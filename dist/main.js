"use strict";var e=require("obsidian");function t(e,t,i){var s=void 0===t?null:t,n=function(e,t){var i=atob(e);if(t){for(var s=new Uint8Array(i.length),n=0,a=i.length;n<a;++n)s[n]=i.charCodeAt(n);return new TextDecoder("utf-16le").decode(new Uint16Array(s.buffer))}return i}(e,void 0!==i&&i),a=n.indexOf("\n",10)+1,r=n.substring(a)+(s?"//# sourceMappingURL="+s:""),c=new Blob([r],{type:"application/javascript"});return URL.createObjectURL(c)}function i(e,i,s){var n;return function(a){return n=n||t(e,i,s),new Worker(n,a)}}var s=i("Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwohZnVuY3Rpb24oKXsidXNlIHN0cmljdCI7dmFyIGUscix0LG49InVuZGVmaW5lZCIhPXR5cGVvZiBnbG9iYWxUaGlzP2dsb2JhbFRoaXM6InVuZGVmaW5lZCIhPXR5cGVvZiB3aW5kb3c/d2luZG93OiJ1bmRlZmluZWQiIT10eXBlb2YgZ2xvYmFsP2dsb2JhbDoidW5kZWZpbmVkIiE9dHlwZW9mIHNlbGY/c2VsZjp7fSxhPXtleHBvcnRzOnt9fTtyPW4sdD1mdW5jdGlvbigpe3ZhciBlPSJmdW5jdGlvbiI9PXR5cGVvZiBNYXA/TWFwOmZ1bmN0aW9uKCl7dmFyIGU9T2JqZWN0LmNyZWF0ZShudWxsKTt0aGlzLmdldD1mdW5jdGlvbihyKXtyZXR1cm4gZVtyXX0sdGhpcy5zZXQ9ZnVuY3Rpb24ocix0KXtyZXR1cm4gZVtyXT10LHRoaXN9LHRoaXMuY2xlYXI9ZnVuY3Rpb24oKXtlPU9iamVjdC5jcmVhdGUobnVsbCl9fSxyPW5ldyBlLHQ9bmV3IGUsbj1bXTtuLnRvdGFsPTA7dmFyIGE9W10sbz1bXTtmdW5jdGlvbiBzKCl7ci5jbGVhcigpLHQuY2xlYXIoKSxhPVtdLG89W119ZnVuY3Rpb24gaShlKXtmb3IodmFyIHI9LTkwMDcxOTkyNTQ3NDA5OTEsdD1lLmxlbmd0aC0xO3Q+PTA7LS10KXt2YXIgbj1lW3RdO2lmKG51bGwhPT1uKXt2YXIgYT1uLnNjb3JlO2E+ciYmKHI9YSl9fXJldHVybi05MDA3MTk5MjU0NzQwOTkxPT09cj9udWxsOnJ9ZnVuY3Rpb24gbChlLHIpe3ZhciB0PWVbcl07aWYodm9pZCAwIT09dClyZXR1cm4gdDt2YXIgbj1yO0FycmF5LmlzQXJyYXkocil8fChuPXIuc3BsaXQoIi4iKSk7Zm9yKHZhciBhPW4ubGVuZ3RoLG89LTE7ZSYmKytvPGE7KWU9ZVtuW29dXTtyZXR1cm4gZX1mdW5jdGlvbiB1KGUpe3JldHVybiJvYmplY3QiPT10eXBlb2YgZX12YXIgZj1mdW5jdGlvbigpe3ZhciBlPVtdLHI9MCx0PXt9O2Z1bmN0aW9uIG4oKXtmb3IodmFyIHQ9MCxuPWVbdF0sYT0xO2E8cjspe3ZhciBvPWErMTt0PWEsbzxyJiZlW29dLnNjb3JlPGVbYV0uc2NvcmUmJih0PW8pLGVbdC0xPj4xXT1lW3RdLGE9MSsodDw8MSl9Zm9yKHZhciBzPXQtMT4+MTt0PjAmJm4uc2NvcmU8ZVtzXS5zY29yZTtzPSh0PXMpLTE+PjEpZVt0XT1lW3NdO2VbdF09bn1yZXR1cm4gdC5hZGQ9ZnVuY3Rpb24odCl7dmFyIG49cjtlW3IrK109dDtmb3IodmFyIGE9bi0xPj4xO24+MCYmdC5zY29yZTxlW2FdLnNjb3JlO2E9KG49YSktMT4+MSllW25dPWVbYV07ZVtuXT10fSx0LnBvbGw9ZnVuY3Rpb24oKXtpZigwIT09cil7dmFyIHQ9ZVswXTtyZXR1cm4gZVswXT1lWy0tcl0sbigpLHR9fSx0LnBlZWs9ZnVuY3Rpb24odCl7aWYoMCE9PXIpcmV0dXJuIGVbMF19LHQucmVwbGFjZVRvcD1mdW5jdGlvbihyKXtlWzBdPXIsbigpfSx0fSgpO3JldHVybiBmdW5jdGlvbiBlKGcpe3ZhciBjPXtzaW5nbGU6ZnVuY3Rpb24oZSxyLHQpe2lmKCJmYXJ6aGVyIj09ZSlyZXR1cm57dGFyZ2V0OiJmYXJ6aGVyIHdhcyBoZXJlICheLV4qKS8iLHNjb3JlOjAsaW5kZXhlczpbMCwxLDIsMyw0LDUsNl19O2lmKCFlKXJldHVybiBudWxsO3ZhciBuPWMuZ2V0UHJlcGFyZWRTZWFyY2goZSksYT1uLmxvd2VyQ29kZXM7aWYoIXIpcmV0dXJuIG51bGw7dShyKXx8KHI9Yy5nZXRQcmVwYXJlZChyKSk7dmFyIG89bi5iaXRtYXNrO3JldHVybihvJnIuX2JpdG1hc2spIT1vP251bGw6Yy5hbGdvcml0aG0oYSxyLGUudG9Mb3dlckNhc2UoKSl9LGdvOmZ1bmN0aW9uKGUscix0KXtpZigiZmFyemhlciI9PWUpcmV0dXJuW3t0YXJnZXQ6ImZhcnpoZXIgd2FzIGhlcmUgKF4tXiopLyIsc2NvcmU6MCxpbmRleGVzOlswLDEsMiwzLDQsNSw2XSxvYmo6cj9yWzBdOm51bGx9XTtpZighZSlyZXR1cm4gdCYmdC5hbGx8fGcmJmcuYWxsP2MuYWxsKGUscix0KTpuO3ZhciBhPWMuZ2V0UHJlcGFyZWRTZWFyY2goZSksbz1hLmxvd2VyQ29kZXM7b1swXTt2YXIgcz1hLmJpdG1hc2ssZD1lLnRvTG93ZXJDYXNlKCkscD10JiZ0LnRocmVzaG9sZHx8ZyYmZy50aHJlc2hvbGR8fC05MDA3MTk5MjU0NzQwOTkxLGg9dCYmdC5saW1pdHx8ZyYmZy5saW1pdHx8OTAwNzE5OTI1NDc0MDk5MSx2PTAsYj0wLHc9ci5sZW5ndGg7aWYodCYmdC5rZXlzKWZvcih2YXIgaz10LnNjb3JlRm58fGkseT10LmtleXMsbT15Lmxlbmd0aCx4PXctMTt4Pj0wOy0teCl7Zm9yKHZhciBfPXJbeF0sQz1uZXcgQXJyYXkobSksTD1tLTE7TD49MDstLUwpKFI9bChfLEE9eVtMXSkpPyh1KFIpfHwoUj1jLmdldFByZXBhcmVkKFIpKSwocyZSLl9iaXRtYXNrKSE9cz9DW0xdPW51bGw6Q1tMXT1jLmFsZ29yaXRobShvLFIsZCkpOkNbTF09bnVsbDtDLm9iaj1fO3ZhciBCPWsoQyk7bnVsbCE9PUImJihCPHB8fChDLnNjb3JlPUIsdjxoPyhmLmFkZChDKSwrK3YpOigrK2IsQj5mLnBlZWsoKS5zY29yZSYmZi5yZXBsYWNlVG9wKEMpKSkpfWVsc2UgaWYodCYmdC5rZXkpe3ZhciBBPXQua2V5O2Zvcih4PXctMTt4Pj0wOy0teClpZihSPWwoXz1yW3hdLEEpKXtpZih1KFIpfHwoUj1jLmdldFByZXBhcmVkKFIpKSwocyZSLl9iaXRtYXNrKSE9cyl2YXIgST1udWxsO2Vsc2UgST1jLmFsZ29yaXRobShvLFIsZCk7bnVsbCE9PUkmJihJLnNjb3JlPHB8fChJPXt0YXJnZXQ6SS50YXJnZXQsX3RhcmdldExvd2VyOiIiLF90YXJnZXRMb3dlckNvZGVzOm51bGwsX25leHRCZWdpbm5pbmdJbmRleGVzOm51bGwsX2JpdG1hc2s6MCxzY29yZTpJLnNjb3JlLGluZGV4ZXM6SS5pbmRleGVzLG9iajpffSx2PGg/KGYuYWRkKEkpLCsrdik6KCsrYixJLnNjb3JlPmYucGVlaygpLnNjb3JlJiZmLnJlcGxhY2VUb3AoSSkpKSl9fWVsc2UgZm9yKHg9dy0xO3g+PTA7LS14KXt2YXIgUjsoUj1yW3hdKSYmKHUoUil8fChSPWMuZ2V0UHJlcGFyZWQoUikpLG51bGwhPT0oST0ocyZSLl9iaXRtYXNrKSE9cz9udWxsOmMuYWxnb3JpdGhtKG8sUixkKSkmJihJLnNjb3JlPHB8fCh2PGg/KGYuYWRkKEkpLCsrdik6KCsrYixJLnNjb3JlPmYucGVlaygpLnNjb3JlJiZmLnJlcGxhY2VUb3AoSSkpKSkpfWlmKDA9PT12KXJldHVybiBuO3ZhciBFPW5ldyBBcnJheSh2KTtmb3IoeD12LTE7eD49MDstLXgpRVt4XT1mLnBvbGwoKTtyZXR1cm4gRS50b3RhbD12K2IsRX0sZ29Bc3luYzpmdW5jdGlvbihlLHIsdCl7dmFyIG49bmV3IFByb21pc2UoZnVuY3Rpb24obixhKXtuKGMuZ28oZSxyLHQpKX0pO3JldHVybiBuLmNhbmNlbD1mdW5jdGlvbigpe30sbn0sYWxsOmZ1bmN0aW9uKGUscix0KXt2YXIgbj1bXTtuLnRvdGFsPXIubGVuZ3RoO3ZhciBhPXQmJnQubGltaXR8fGcmJmcubGltaXR8fDkwMDcxOTkyNTQ3NDA5OTE7aWYodCYmdC5rZXlzKWZvcih2YXIgbz0wO288ci5sZW5ndGg7bysrKXtmb3IodmFyIHM9cltvXSxpPW5ldyBBcnJheSh0LmtleXMubGVuZ3RoKSxmPXQua2V5cy5sZW5ndGgtMTtmPj0wOy0tZikocD1sKHMsdC5rZXlzW2ZdKSk/KHUocCl8fChwPWMuZ2V0UHJlcGFyZWQocCkpLHAuc2NvcmU9LTkwMDcxOTkyNTQ3NDA5OTEsaVtmXT1wKTppW2ZdPW51bGw7aWYoaS5vYmo9cyxpLnNjb3JlPS05MDA3MTk5MjU0NzQwOTkxLG4ucHVzaChpKSxuLmxlbmd0aD49YSlyZXR1cm4gbn1lbHNlIGlmKHQmJnQua2V5KXtmb3Iobz0wO288ci5sZW5ndGg7bysrKWlmKHA9bChzPXJbb10sdC5rZXkpKXt1KHApfHwocD1jLmdldFByZXBhcmVkKHApKSxwLnNjb3JlPS05MDA3MTk5MjU0NzQwOTkxO3ZhciBkPXA7aWYoZD17dGFyZ2V0OmQudGFyZ2V0LF90YXJnZXRMb3dlcjoiIixfdGFyZ2V0TG93ZXJDb2RlczpudWxsLF9uZXh0QmVnaW5uaW5nSW5kZXhlczpudWxsLF9iaXRtYXNrOjAsc2NvcmU6cC5zY29yZSxpbmRleGVzOm51bGwsb2JqOnN9LG4ucHVzaChkKSxuLmxlbmd0aD49YSlyZXR1cm4gbn19ZWxzZSBmb3Iobz0wO288ci5sZW5ndGg7bysrKXt2YXIgcDtpZigocD1yW29dKSYmKHUocCl8fChwPWMuZ2V0UHJlcGFyZWQocCkpLHAuc2NvcmU9LTkwMDcxOTkyNTQ3NDA5OTEsbi5wdXNoKHApLG4ubGVuZ3RoPj1hKSlyZXR1cm4gbn1yZXR1cm4gbn0saGlnaGxpZ2h0OmZ1bmN0aW9uKGUscix0KXtpZigiZnVuY3Rpb24iPT10eXBlb2YgcilyZXR1cm4gYy5oaWdobGlnaHRDYWxsYmFjayhlLHIpO2lmKG51bGw9PT1lKXJldHVybiBudWxsO3ZvaWQgMD09PXImJihyPSI8Yj4iKSx2b2lkIDA9PT10JiYodD0iPC9iPiIpO2Zvcih2YXIgbj0iIixhPTAsbz0hMSxzPWUudGFyZ2V0LGk9cy5sZW5ndGgsbD1lLmluZGV4ZXMsdT0wO3U8aTsrK3Upe3ZhciBmPXNbdV07aWYobFthXT09PXUpe2lmKG98fChvPSEwLG4rPXIpLCsrYT09PWwubGVuZ3RoKXtuKz1mK3Qrcy5zdWJzdHIodSsxKTticmVha319ZWxzZSBvJiYobz0hMSxuKz10KTtuKz1mfXJldHVybiBufSxoaWdobGlnaHRDYWxsYmFjazpmdW5jdGlvbihlLHIpe2lmKG51bGw9PT1lKXJldHVybiBudWxsO2Zvcih2YXIgdD1lLnRhcmdldCxuPXQubGVuZ3RoLGE9ZS5pbmRleGVzLG89IiIscz0wLGk9MCxsPSExLHU9KGU9W10sMCk7dTxuOysrdSl7dmFyIGY9dFt1XTtpZihhW2ldPT09dSl7aWYoKytpLGx8fChsPSEwLGUucHVzaChvKSxvPSIiKSxpPT09YS5sZW5ndGgpe28rPWYsZS5wdXNoKHIobyxzKyspKSxvPSIiLGUucHVzaCh0LnN1YnN0cih1KzEpKTticmVha319ZWxzZSBsJiYobD0hMSxlLnB1c2gocihvLHMrKykpLG89IiIpO28rPWZ9cmV0dXJuIGV9LHByZXBhcmU6ZnVuY3Rpb24oZSl7ZXx8KGU9IiIpO3ZhciByPWMucHJlcGFyZUxvd2VyQ29kZXMoZSk7cmV0dXJue3RhcmdldDplLF90YXJnZXRMb3dlcjplLnRvTG93ZXJDYXNlKCksX3RhcmdldExvd2VyQ29kZXM6cixfbmV4dEJlZ2lubmluZ0luZGV4ZXM6bnVsbCxfYml0bWFzazpjLnByZXBhcmVCaXRtYXNrKHIpLHNjb3JlOm51bGwsaW5kZXhlczpbMF0sb2JqOm51bGx9fSxwcmVwYXJlU2xvdzpmdW5jdGlvbihlKXtyZXR1cm4gYy5wcmVwYXJlKGUpfSxwcmVwYXJlU2VhcmNoOmZ1bmN0aW9uKGUpe2V8fChlPSIiKTt2YXIgcj1jLnByZXBhcmVMb3dlckNvZGVzKGUpO3JldHVybntsb3dlckNvZGVzOnIsYml0bWFzazpjLnByZXBhcmVCaXRtYXNrKHIpfX0sZ2V0UHJlcGFyZWQ6ZnVuY3Rpb24oZSl7aWYoZS5sZW5ndGg+OTk5KXJldHVybiBjLnByZXBhcmUoZSk7dmFyIHQ9ci5nZXQoZSk7cmV0dXJuIHZvaWQgMCE9PXR8fCh0PWMucHJlcGFyZShlKSxyLnNldChlLHQpKSx0fSxnZXRQcmVwYXJlZFNlYXJjaDpmdW5jdGlvbihlKXtpZihlLmxlbmd0aD45OTkpcmV0dXJuIGMucHJlcGFyZVNlYXJjaChlKTt2YXIgcj10LmdldChlKTtyZXR1cm4gdm9pZCAwIT09cnx8KHI9Yy5wcmVwYXJlU2VhcmNoKGUpLHQuc2V0KGUscikpLHJ9LGFsZ29yaXRobTpmdW5jdGlvbihlLHIsdCl7Zm9yKHZhciBuPWVbMF0scz1yLl90YXJnZXRMb3dlckNvZGVzLGk9ZS5sZW5ndGgsbD1zLmxlbmd0aCx1PTAsZj0wLGc9MDs7KXtpZihuPT09c1tmXSl7aWYoYVtnKytdPWYsKyt1PT09aSlicmVhaztuPWVbdV19aWYoKytmPj1sKXJldHVybiBudWxsfXU9MDt2YXIgZD0hMSxwPTAsaD1yLl9uZXh0QmVnaW5uaW5nSW5kZXhlcztudWxsPT09aCYmKGg9ci5fbmV4dEJlZ2lubmluZ0luZGV4ZXM9Yy5wcmVwYXJlTmV4dEJlZ2lubmluZ0luZGV4ZXMoci50YXJnZXQpKTt2YXIgdj0wO2lmKChmPTA9PT1hWzBdPzA6aFthWzBdLTFdKSE9PWwpZm9yKDs7KWlmKGY+PWwpe2lmKHU8PTApYnJlYWs7aWYoKyt2PjIwMClicmVhazstLXUsZj1oW29bLS1wXV19ZWxzZSBpZihlW3VdPT09c1tmXSl7aWYob1twKytdPWYsKyt1PT09aSl7ZD0hMDticmVha30rK2Z9ZWxzZSBmPWhbZl07dmFyIGI9ci5fdGFyZ2V0TG93ZXIuaW5kZXhPZih0LGFbMF0pLHc9fmI7aWYodyYmIWQpZm9yKHZhciBrPTA7azxnOysraylhW2tdPWIrazt2YXIgeT0hMTtpZih3JiYoeT1yLl9uZXh0QmVnaW5uaW5nSW5kZXhlc1tiLTFdPT1iKSxkKXZhciBtPW8seD1wO2Vsc2UgbT1hLHg9Zzt2YXIgXz0wLEM9MDtmb3Ioaz1pLTE7az49MTstLWspbVtrXS1tW2stMV0hPT0xJiYoXy09bVtrXSwrK0MpO2lmKF8tPShtW2ktMV0tbVswXS0oaS0xKSkqQywwIT09bVswXSYmKF8tPTEwKm1bMF0pLGQpe3ZhciBMPTE7Zm9yKGs9aFswXTtrPGw7az1oW2tdKSsrTDtMPjI0JiYoXyo9MTAqKEwtMjQpKX1lbHNlIF8qPTFlMztmb3IodyYmKF8vPTEwKSx5JiYoXy89MTApLF8tPWwtaSxyLnNjb3JlPV8sci5pbmRleGVzPW5ldyBBcnJheSh4KSxrPXgtMTtrPj0wOy0taylyLmluZGV4ZXNba109bVtrXTtyZXR1cm4gcn0scHJlcGFyZUxvd2VyQ29kZXM6ZnVuY3Rpb24oZSl7Zm9yKHZhciByPWUubGVuZ3RoLHQ9W10sbj1lLnRvTG93ZXJDYXNlKCksYT0wO2E8cjsrK2EpdFthXT1uLmNoYXJDb2RlQXQoYSk7cmV0dXJuIHR9LHByZXBhcmVCZWdpbm5pbmdJbmRleGVzOmZ1bmN0aW9uKGUpe2Zvcih2YXIgcj1lLmxlbmd0aCx0PVtdLG49MCxhPSExLG89ITEscz0wO3M8cjsrK3Mpe3ZhciBpPWUuY2hhckNvZGVBdChzKSxsPWk+PTY1JiZpPD05MCx1PWx8fGk+PTk3JiZpPD0xMjJ8fGk+PTQ4JiZpPD01NyxmPWwmJiFhfHwhb3x8IXU7YT1sLG89dSxmJiYodFtuKytdPXMpfXJldHVybiB0fSxwcmVwYXJlTmV4dEJlZ2lubmluZ0luZGV4ZXM6ZnVuY3Rpb24oZSl7Zm9yKHZhciByPWUubGVuZ3RoLHQ9Yy5wcmVwYXJlQmVnaW5uaW5nSW5kZXhlcyhlKSxuPVtdLGE9dFswXSxvPTAscz0wO3M8cjsrK3MpYT5zP25bc109YTooYT10Wysrb10sbltzXT12b2lkIDA9PT1hP3I6YSk7cmV0dXJuIG59LHByZXBhcmVCaXRtYXNrOmZ1bmN0aW9uKGUpe2Zvcih2YXIgcj0wLHQ9ZS5sZW5ndGgtMTt0Pj0wOy0tdCl7dmFyIG49ZVt0XTtyfD0xPDwobj49OTcmJm48PTEyMj9uLTk3Om4+PTQ4JiZuPD01Nz8yNjozMj09PW4/Mjc6bjw9MTI3PzI4OjI5KX1yZXR1cm4gcn0sY2xlYW51cDpzLG5ldzplfTtyZXR1cm4gY30oKX0sKGU9YSkuZXhwb3J0cz9lLmV4cG9ydHM9dCgpOnIuZnV6enlzb3J0PXQoKTt2YXIgbyxzOyFmdW5jdGlvbihlKXtlW2UuQ29tbWFuZHM9MF09IkNvbW1hbmRzIixlW2UuRmlsZXM9MV09IkZpbGVzIixlW2UuVGFncz0yXT0iVGFncyIsZVtlLkh5YnJpZD0zXT0iSHlicmlkIn0ob3x8KG89e30pKSxmdW5jdGlvbihlKXtlW2UuRVJST1I9MF09IkVSUk9SIixlW2UuV0FSTj0xXT0iV0FSTiIsZVtlLklORk89Ml09IklORk8iLGVbZS5ERUJVRz0zXT0iREVCVUcifShzfHwocz17fSkpO2NsYXNzIGl7Y29uc3RydWN0b3IoKXt0aGlzLmxvZ0xldmVsPXMuV0FSTn1zdGF0aWMgZ2V0SW5zdGFuY2UoKXtyZXR1cm4gaS5pbnN0YW5jZXx8KGkuaW5zdGFuY2U9bmV3IGkpLGkuaW5zdGFuY2V9aXNEZWJ1Z0VuYWJsZWQoKXtyZXR1cm4idW5kZWZpbmVkIiE9dHlwZW9mIHdpbmRvdyYmITA9PT13aW5kb3cuQkVUVEVSX0NPTU1BTkRfUEFMRVRURV9ERUJVR31zZXRMb2dMZXZlbChlKXt0aGlzLmxvZ0xldmVsPWV9ZXJyb3IoZSxyKXt0aGlzLmxvZyhzLkVSUk9SLGUscil9d2FybihlLHIpe3RoaXMubG9nKHMuV0FSTixlLHIpfWluZm8oZSxyKXt0aGlzLmxvZyhzLklORk8sZSxyKX1kZWJ1ZyhlLHIpe3RoaXMubG9nKHMuREVCVUcsZSxyKX1sb2coZSxyLHQpe2lmKGU+cy5XQVJOJiYhdGhpcy5pc0RlYnVnRW5hYmxlZCgpKXJldHVybjtpZihlPnRoaXMubG9nTGV2ZWwmJiF0aGlzLmlzRGVidWdFbmFibGVkKCkpcmV0dXJuO2NvbnN0IG49e2xldmVsOmUsbWVzc2FnZTpyLGRhdGE6dCx0aW1lc3RhbXA6bmV3IERhdGV9O3RoaXMub3V0cHV0KG4pfW91dHB1dChlKXtjb25zdCByPWAke2BbQkNQOiR7c1tlLmxldmVsXX1dYH0gJHtlLm1lc3NhZ2V9YDtzd2l0Y2goZS5sZXZlbCl7Y2FzZSBzLkVSUk9SOmUuZGF0YT9jb25zb2xlLmVycm9yKHIsZS5kYXRhKTpjb25zb2xlLmVycm9yKHIpO2JyZWFrO2Nhc2Ugcy5XQVJOOmUuZGF0YT9jb25zb2xlLndhcm4ocixlLmRhdGEpOmNvbnNvbGUud2FybihyKTticmVhaztjYXNlIHMuSU5GTzpjYXNlIHMuREVCVUc6ZS5kYXRhP2NvbnNvbGUubG9nKHIsZS5kYXRhKTpjb25zb2xlLmxvZyhyKX19fWNvbnN0IGw9aS5nZXRJbnN0YW5jZSgpO3NlbGYub25tZXNzYWdlPWU9Pnt0cnl7aWYoIWUuZGF0YXx8Im9iamVjdCIhPXR5cGVvZiBlLmRhdGEpcmV0dXJuIGwud2FybigiSW52YWxpZCBtZXNzYWdlIHJlY2VpdmVkIGJ5IHN1Z2dlc3Rpb25zIHdvcmtlciIpLHZvaWQgc2VsZi5wb3N0TWVzc2FnZShbXSk7Y29uc3R7cXVlcnk6cixpdGVtczp0fT1lLmRhdGE7aWYoIXR8fCFBcnJheS5pc0FycmF5KHQpKXJldHVybiBsLndhcm4oIkludmFsaWQgaXRlbXMgYXJyYXkgcmVjZWl2ZWQgYnkgc3VnZ2VzdGlvbnMgd29ya2VyIiksdm9pZCBzZWxmLnBvc3RNZXNzYWdlKFtdKTtpZigic3RyaW5nIiE9dHlwZW9mIHIpcmV0dXJuIGwud2FybigiSW52YWxpZCBxdWVyeSByZWNlaXZlZCBieSBzdWdnZXN0aW9ucyB3b3JrZXIiKSx2b2lkIHNlbGYucG9zdE1lc3NhZ2UoW10pO2NvbnN0W24sLi4ub109ci5zcGxpdCgiQCIpO2xldCBzPXQ7aWYobi5pbmNsdWRlcygifHwiKSl7Y29uc3QgZT1uLnNwbGl0KCJ8fCIpLm1hcChlPT5lLnRyaW0oKSk7cz10LmZpbHRlcihyPT5lLnNvbWUoZT0+ci50ZXh0LmluY2x1ZGVzKGUpKSl9ZWxzZSIiIT09biYmKHM9YS5leHBvcnRzLmdvKG4sdCx7a2V5OiJ0ZXh0In0pLm1hcChlPT5lLm9iaikpO3JldHVybiBvLmxlbmd0aCYmKHM9cy5maWx0ZXIoZT0+ZnVuY3Rpb24oZSxyKXtmb3IobGV0IHQ9MDt0PHIubGVuZ3RoO3QrPTEpe2NvbnN0IG49clt0XTtmb3IobGV0IHI9MDtyPGUubGVuZ3RoO3IrPTEpe2NvbnN0IHQ9ZVtyXTtpZih0PT09bilyZXR1cm4hMDtjb25zdCBhPWAke259L2A7aWYodC5zdGFydHNXaXRoKGEpKXJldHVybiEwfX1yZXR1cm4hMX0oZS50YWdzLG8pKSksc2VsZi5wb3N0TWVzc2FnZShzKX1jYXRjaChlKXtsLmVycm9yKCJXb3JrZXIgZXJyb3I6IixlKSxzZWxmLnBvc3RNZXNzYWdlKFtdKX19fSgpOwoK",null,!1);class n{constructor(e=[]){this.map=new Map,e.forEach(e=>this.map.set(e.value(),e))}has(e){return this.map.has(e.value())}add(e){return this.delete(e),this.map.set(e.value(),e)}addAll(e){e.forEach(e=>this.add(e))}delete(e){this.map.delete(e.value())}values(){return Array.from(this.map.values())}valuesByLastAdd(){return Array.from(this.map.values()).reverse()}}class a{constructor(e,t,i=[]){this.id=e,this.text=t,this.tags=i}value(){return this.id}}class r{constructor(e,t,i,s){this.app=e,this.prevItems=t,this.recentAbovePinned=i.settings.recentAbovePinned,this.plugin=i,this.palette=s,this.allItems=[],this.pinnedItems=[],this.initialized=!1,this.hiddenIds=[],this.keymapHandlers=[]}usesEnhancedSearch(){return!1}getTitleText(){return this.titleText}getEmptyStateText(){return this.emptyStateText}getInstructions(){return[]}checkInitialized(){if(!this.initialized)throw new Error("This adapter has not been initialized")}initialize(){this.initialized=!0}mount(){}unmount(){this.keymapHandlers.forEach(e=>this.palette.scope.unregister(e)),this.keymapHandlers=[]}cleanQuery(e){return e}getPinnedItems(){return this.checkInitialized(),this.pinnedItems}getItems(){return this.checkInitialized(),this.allItems}getPrevItems(){return this.prevItems}getSortedItems(){const e=new n(this.getItems()),t=this.recentAbovePinned?this.getPrevItems().values():this.getPinnedItems();return[this.recentAbovePinned?this.getPinnedItems():this.getPrevItems().values(),t].forEach(t=>{t.forEach(t=>{e.has(t)&&e.add(t)})}),e.valuesByLastAdd()}async toggleHideId(e){this.hiddenIds.includes(e)?this.hiddenIds=this.hiddenIds.filter(t=>e!==t):this.hiddenIds.push(e),this.plugin.settings[this.hiddenIdsSettingsKey]=this.hiddenIds,await this.plugin.saveSettings(),await this.plugin.loadSettings(),this.palette.updateSuggestions()}}class c{constructor(e,t,i,s=[],n=200){this.app=e,this.id=t,this.name=i,this.commandIds=s,this.delay=n}addCommand(e){this.commandIds.push(e)}removeCommand(e){this.commandIds=this.commandIds.filter(t=>t===e)}commandIsAvailable(e){const t=this.app.commands.findCommand(e);return!t.checkCallback||t.checkCallback(!0)}async callAllCommands(){const t=new e.Notice(`Running "${this.name}"...`,1e4);for(let e=0;e<this.commandIds.length;e+=1){const i=this.commandIds[e],s=this.app.commands.findCommand(i);if(!this.commandIsAvailable(i)){t.setMessage(`Error: "${s.name}" cannot be used in this context. The macro is stopping.`);break}t.setMessage(`Running "${s.name}"`),this.app.commands.executeCommandById(i),await new Promise(e=>{setTimeout(e,this.delay)})}return t.hide(),new e.Notice(`Successfully ran "${this.name}"`),!0}checkCallback(e){return e?this.commandIsAvailable(this.commandIds[0]):(this.callAllCommands(),null)}}const o=new Set(["Alt","Ctrl","Mod","Shift"]),h={Mod:"Ctrl +",Ctrl:"Ctrl +",Meta:"Win +",Alt:"Alt +",Shift:"Shift +",Hyper:"Caps +"},d={Mod:"âŒ˜",Ctrl:"^",Meta:"âŒ˜",Alt:"âŒ¥",Shift:"â‡§",Hyper:"â‡ª"},l={TAB:"â†¹",ENTER:"â†µ",ARROWLEFT:"â†",ARROWRIGHT:"â†’",ARROWUP:"â†‘",ARROWDOWN:"â†“",BACKSPACE:"âŒ«",ESC:"Esc"},u="obsidian-better-command-palette-macro-";var g,m;!function(e){e[e.Commands=0]="Commands",e[e.Files=1]="Files",e[e.Tags=2]="Tags",e[e.Hybrid=3]="Hybrid"}(g||(g={})),function(e){e[e.ERROR=0]="ERROR",e[e.WARN=1]="WARN",e[e.INFO=2]="INFO",e[e.DEBUG=3]="DEBUG"}(m||(m={}));class p{constructor(){this.logLevel=m.WARN}static getInstance(){return p.instance||(p.instance=new p),p.instance}isDebugEnabled(){return"undefined"!=typeof window&&!0===window.BETTER_COMMAND_PALETTE_DEBUG}setLogLevel(e){this.logLevel=e}error(e,t){this.log(m.ERROR,e,t)}warn(e,t){this.log(m.WARN,e,t)}info(e,t){this.log(m.INFO,e,t)}debug(e,t){this.log(m.DEBUG,e,t)}log(e,t,i){if(e>m.WARN&&!this.isDebugEnabled())return;if(e>this.logLevel&&!this.isDebugEnabled())return;const s={level:e,message:t,data:i,timestamp:new Date};this.output(s)}output(e){const t=`${`[BCP:${m[e.level]}]`} ${e.message}`;switch(e.level){case m.ERROR:e.data?console.error(t,e.data):console.error(t);break;case m.WARN:e.data?console.warn(t,e.data):console.warn(t);break;case m.INFO:case m.DEBUG:e.data?console.log(t,e.data):console.log(t)}}}const S=p.getInstance();function f(t,i){let s=e.Platform.isMacOS?d:h;"mac"===i.hotkeyStyle?s=d:"windows"===i.hotkeyStyle&&(s=h);const n=[];var a;i.hyperKeyOverride&&(4===(a=t.modifiers).length&&a.every(e=>o.has(e)))?n.push(s.Hyper):t.modifiers.forEach(e=>{n.push(s[e])});const r=t.key.toUpperCase();return n.push(l[r]||r),n.join(" ")}function y(e,t,i,s){const n="Shift"===t.openInNewTabMod?s.shiftKey:s.metaKey||s.ctrlKey;e.workspace.openLinkText(i.path,i.path,n)}function b(t,i){const s=t.getCache(i);if(!s)return[];const n=(s.tags||[]).map(e=>e.tag),r=e.parseFrontMatterTags(s.frontmatter)||[],c=n.concat(r),o=e.parseFrontMatterAliases(s.frontmatter)||[];return[new a(i,i,c),...o.map(e=>new a(`${e}:${i}`,e,c))]}class x extends r{constructor(){super(...arguments),this.COMMAND_PLUGIN_NAME_SEPARATOR=": "}initialize(){super.initialize(),this.titleText="Better Command Palette: Commands",this.emptyStateText="No matching commands.",this.hiddenIds=this.plugin.settings.hiddenCommands,this.hiddenIdsSettingsKey="hiddenCommands",this.allItems=this.app.commands.listCommands().sort((e,t)=>t.name.localeCompare(e.name)).map(e=>new a(e.id,e.name));const e=this.app.internalPlugins.getPluginById("command-palette").instance.options.pinned||[];this.pinnedItems=e.reduce((e,t)=>{const i=this.app.commands.findCommand(t);return i&&e.push(new a(t,i.name)),e},[]).reverse()}mount(){this.keymapHandlers=[this.palette.scope.register(["Mod"],this.plugin.settings.fileSearchHotkey,()=>this.palette.changeActionType(g.Files)),this.palette.scope.register(["Mod"],this.plugin.settings.tagSearchHotkey,()=>this.palette.changeActionType(g.Tags))]}getInstructions(){return[{command:f({modifiers:[],key:"ENTER"},this.plugin.settings),purpose:"Run command"},{command:f({modifiers:["Mod"],key:this.plugin.settings.fileSearchHotkey},this.plugin.settings),purpose:"Search Files"},{command:f({modifiers:["Mod"],key:this.plugin.settings.tagSearchHotkey},this.plugin.settings),purpose:"Search Tags"}]}renderSuggestion(t,i,s){const n=this.app.commands.findCommand(t.id),a=this.app.hotkeyManager.getHotkeys(n.id),r=this.app.hotkeyManager.getDefaultHotkeys(n.id),c=a||r||[];if(this.getPinnedItems().find(e=>e.id===t.id)){const t=s.querySelector(".suggestion-flair");e.setIcon(t,"filled-pin",13),t.ariaLabel="Pinned",t.onClickEvent(()=>{})}let{text:o}=t,h="";if(o.includes(this.COMMAND_PLUGIN_NAME_SEPARATOR)){const e=o.split(this.COMMAND_PLUGIN_NAME_SEPARATOR);h=e.shift(),o=e.join(this.COMMAND_PLUGIN_NAME_SEPARATOR)}i.createEl("span",{cls:"suggestion-title",text:o}),h&&this.plugin.settings.showPluginName&&i.createEl("span",{cls:"suggestion-note",text:h}),c.forEach(e=>{s.createEl("kbd",{cls:"suggestion-hotkey",text:f(e,this.plugin.settings)})})}async onChooseSuggestion(e,t){if(e)try{this.app.commands.commands[e.id]&&(await this.app.commands.executeCommandById(e.id),this.prevItems.add(e))}catch(e){S.error("Error executing command:",e)}}}class w extends r{initialize(){super.initialize(),this.hiddenIds=this.plugin.settings.hiddenTags,this.hiddenIdsSettingsKey="hiddenTags",this.tagSearchPrefix=this.plugin.settings.tagSearchPrefix,this.titleText="Better Command Palette: Tags",this.emptyStateText="No matching tags.",this.allItems=Object.entries(this.app.metadataCache.getTags()).map(([e,t])=>new a(e,e,[t]))}mount(){this.keymapHandlers=[this.palette.scope.register(["Mod"],this.plugin.settings.commandSearchHotkey,()=>this.palette.changeActionType(g.Commands)),this.palette.scope.register(["Mod"],this.plugin.settings.fileSearchHotkey,()=>this.palette.changeActionType(g.Files))]}getInstructions(){return[{command:f({modifiers:[],key:"ENTER"},this.plugin.settings),purpose:"See file usage"},{command:f({modifiers:["Mod"],key:this.plugin.settings.commandSearchHotkey},this.plugin.settings),purpose:"Search Commands"},{command:f({modifiers:["Mod"],key:this.plugin.settings.fileSearchHotkey},this.plugin.settings),purpose:"Search Files"}]}cleanQuery(e){return e.replace(this.tagSearchPrefix,"")}renderSuggestion(e,t,i){t.createEl("span",{cls:"suggestion-content",text:e.text});const s=parseInt(e.tags[0],10);i.createEl("span",{cls:"suggestion-flair",text:`Found in ${s} file${1===s?"":"s"}`})}async onChooseSuggestion(e){e&&(this.getPrevItems().add(e),this.palette.open(),this.palette.setQuery(`${this.plugin.settings.fileSearchPrefix}@${e.text}`,1))}}class v extends r{constructor(e,t,i,s,n){super(e,t,i,s),this.lastSearchResults=[],this.searchDebounceTimer=null,this.SEARCH_DEBOUNCE_MS=150,this.hybridSearchService=n,this.allItems=[]}initialize(){super.initialize(),this.titleText="Better Command Palette: Hybrid Search",this.emptyStateText="Search for concepts, keywords, or topics...",this.hybridSearchPrefix="?",this.hiddenIds=this.plugin.settings.hiddenFiles,this.hiddenIdsSettingsKey="hiddenFiles",this.allItems=[],this.lastSearchResults=[],this.loadRecentFiles()}loadRecentFiles(){this.app.workspace.getLastOpenFiles().slice(0,10).forEach(t=>{if(!t||"string"!=typeof t)return;if(this.app.vault.getAbstractFileByPath(t)instanceof e.TFile){const e=this.processDisplayPath(t),i=new a(t,e);this.prevItems.add(i),this.allItems.push(i)}})}mount(){this.keymapHandlers=[this.palette.scope.register(["Mod"],this.plugin.settings.commandSearchHotkey,()=>this.palette.changeActionType(g.Commands)),this.palette.scope.register(["Mod"],this.plugin.settings.fileSearchHotkey,()=>this.palette.changeActionType(g.Files)),this.palette.scope.register(["Mod"],this.plugin.settings.tagSearchHotkey,()=>this.palette.changeActionType(g.Tags))]}getInstructions(){const{openInNewTabMod:e}=this.plugin.settings;return[{command:f({modifiers:[],key:"ENTER"},this.plugin.settings),purpose:"Open file"},{command:f({modifiers:[e],key:"ENTER"},this.plugin.settings),purpose:"Open in new pane"},{command:f({modifiers:["Mod"],key:this.plugin.settings.commandSearchHotkey},this.plugin.settings),purpose:"Commands"},{command:f({modifiers:["Mod"],key:this.plugin.settings.fileSearchHotkey},this.plugin.settings),purpose:"Files"}]}cleanQuery(e){return e.startsWith(this.hybridSearchPrefix)?e.slice(this.hybridSearchPrefix.length).trim():e.trim()}processDisplayPath(e){let t=e;return this.plugin.settings.displayOnlyNotesNames&&(t=e.split("/").pop()||e),this.plugin.settings.hideMdExtension&&t.endsWith(".md")&&(t=t.slice(0,-3)),t}usesEnhancedSearch(){return!0}async getSearchResults(e){S.debug("HybridSearchAdapter: getSearchResults called with:",e);const t=this.cleanQuery(e);if(t.length<2)return[];if(!this.hybridSearchService?.isReady())return S.debug("HybridSearchAdapter: Service not ready"),[];try{const e=await this.hybridSearchService.search(t,{limit:this.plugin.settings.suggestionLimit});return S.debug("HybridSearchAdapter: Found",e.length,"results"),this.lastSearchResults=e.map(e=>{const t=this.processDisplayPath(e.path),i=new a(e.path,t,e.metadata?.tags||[]);return i.hybridResult=e,i}),this.lastSearchResults}catch(e){return S.error("HybridSearchAdapter: Search failed",e),[]}}async streamSearchResults(e,t){const i=this.cleanQuery(e);if(!(i.length<2)&&this.hybridSearchService?.isReady())return this.searchDebounceTimer&&(clearTimeout(this.searchDebounceTimer),this.searchDebounceTimer=null),new Promise(e=>{this.searchDebounceTimer=setTimeout(async()=>{if(t.signal?.aborted)return t.onUpdate([],!0),void e();try{await this.hybridSearchService.searchStream(i,{limit:t.limit,signal:t.signal,onUpdate:(e,i)=>{t.signal?.aborted||(this.lastSearchResults=e.map(e=>{const t=this.processDisplayPath(e.path),i=new a(e.path,t,e.metadata?.tags||[]);return i.hybridResult=e,i}),t.onUpdate(this.lastSearchResults,"complete"===i))}}),e()}catch(i){if(t.signal?.aborted)return void e();S.error("HybridSearchAdapter: Stream search failed",i),t.onUpdate([],!0),e()}},this.SEARCH_DEBOUNCE_MS)});t.onUpdate([],!0)}renderSuggestion(t,i,s){const n=t.hybridResult;i.addClass("hybrid-suggestion-content");const a=this.app.vault.getAbstractFileByPath(t.id),r=i.createEl("div",{cls:"hybrid-result-header"});let c=t.text.split("/").pop()||t.text;this.plugin.settings.hideMdExtension&&c.endsWith(".md")&&(c=c.slice(0,-3)),c.length>0&&(c=c.charAt(0).toUpperCase()+c.slice(1)),r.createEl("span",{cls:"hybrid-result-title",text:c}),r.createEl("span",{cls:"hybrid-header-spacer"});const o=r.createEl("span",{cls:"hybrid-result-meta"});if(a instanceof e.TFile){const e=this.app.metadataCache.getFileCache(a),t=e?.frontmatter?.rating;if(null!=t){const e=parseFloat(String(t));if(!isNaN(e)){const t=e/7*5,i=t.toFixed(1),s=o.createEl("span",{cls:"hybrid-rating"}),n=Math.round(t);let a="";for(let e=0;e<5;e++)a+=e<n?"â˜…":"â˜†";s.createEl("span",{cls:"hybrid-rating-stars",text:a}),s.createEl("span",{cls:"hybrid-rating-text",text:` Rating: ${i}/5`})}}}n&&this.addConfidenceMeter(o,n.finalScore);const h=o.createEl("span",{cls:"hybrid-menu-icon"});e.setIcon(h,"more-vertical"),h.onClickEvent(i=>{i.preventDefault(),i.stopPropagation();const s=new e.Menu(this.app),n=this.hiddenIds.includes(t.id);s.addItem(e=>{e.setTitle(n?"Unhide Item":"Ignore Item").setIcon(n?"eye":"eye-off").onClick(()=>{this.toggleHideId(t.id)})}),s.showAtMouseEvent(i)});const d=t.text,l=d.lastIndexOf("/");if(l>0){const e=d.substring(0,l).replace(/\//g," > ");i.createEl("div",{cls:"hybrid-result-path",text:e})}const u=i.createEl("div",{cls:"hybrid-result-body"}),g=a instanceof e.TFile?window.moment(a.stat.mtime).format("MMM D, YYYY"):"";if(g&&u.createEl("span",{cls:"hybrid-date-pill",text:g}),n?.excerpt){const e=u.createEl("span",{cls:"hybrid-excerpt"});this.renderExcerptWithHighlights(e,n.excerpt,n.matches?.keywordMatches||[]),e.createEl("span",{cls:"hybrid-excerpt-more",text:"..See more"})}else t.tags&&t.tags.length>0&&t.tags.slice(0,3).forEach(e=>{u.createEl("span",{cls:"hybrid-tag",text:e.startsWith("#")?e:`#${e}`})})}renderExcerptWithHighlights(e,t,i){if(!i.length)return void(e.textContent=t);const s=new RegExp(`(${i.map(e=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")).join("|")})`,"gi");t.split(s).forEach(t=>{i.some(e=>e.toLowerCase()===t.toLowerCase())?e.createEl("span",{cls:"hybrid-highlight",text:t}):e.appendText(t)})}addConfidenceMeter(e,t){const i=e.createEl("span",{cls:"hybrid-confidence-meter"});i.title=`Relevance Score: ${(100*t).toFixed(1)}%`;const s=Math.round(5*t);for(let e=0;e<5;e++)i.createEl("span",{cls:"meter-bar "+(e<s?"filled":"empty")})}async onChooseSuggestion(t,i){if(!t)return;const s=t.id;if(this.hybridSearchService&&this.palette.inputEl){const e=this.cleanQuery(this.palette.inputEl.value);e&&this.hybridSearchService.recordSelection(e,s)}if(this.plugin.usageTracker&&this.palette.inputEl){const e=this.cleanQuery(this.palette.inputEl.value);this.plugin.usageTracker.recordSearchResultOpen(s,e)}const n=this.app.vault.getAbstractFileByPath(s);if(n)if(n instanceof e.TFile)try{y(this.app,this.plugin.settings,n,i)}catch(t){S.error("HybridSearchAdapter: Failed to open file",t),new e.Notice(`Failed to open file: ${t.message}`)}else new e.Notice(`Path is not a file: ${s}`);else new e.Notice(`File not found: ${s}`)}}class k extends r{constructor(e,t,i,s,a){super(e,t,i,s),this.searchService=a,this.unresolvedItems=new n,this.allItems=[]}initialize(){super.initialize(),this.titleText="Better Command Palette: Files (Enhanced)",this.emptyStateText="No matching files.",this.fileSearchPrefix=this.plugin.settings.fileSearchPrefix,this.hiddenIds=this.plugin.settings.hiddenFiles,this.hiddenIdsSettingsKey="hiddenFiles",this.allItems=[],this.unresolvedItems=new n,this.app.metadataCache.getCachedFiles().forEach(e=>{if(!e||"string"!=typeof e)return;if(this.plugin.settings.fileTypeExclusion.some(t=>e.endsWith(`.${t}`)))return;const t=b(this.app.metadataCache,e).map(e=>{if(e.id.includes(":"))return e;const t=this.processDisplayPath(e.text);return new a(e.id,t,e.tags)});this.allItems=this.allItems.concat(t);const i=this.app.metadataCache.unresolvedLinks[e];i&&"object"==typeof i&&Object.keys(i).forEach(e=>{e&&"string"==typeof e&&e.trim()&&this.unresolvedItems.add(new a(e,e))})}),this.allItems=this.allItems.concat(Array.from(this.unresolvedItems.values())).reverse(),[...this.app.workspace.getLastOpenFiles()].reverse().forEach(e=>{const t=b(this.app.metadataCache,e);if(t[0]){const i=this.processDisplayPath(e),s=new a(e,i,t[0].tags);this.prevItems.add(s)}})}mount(){this.keymapHandlers=[this.palette.scope.register(["Mod"],this.plugin.settings.commandSearchHotkey,()=>this.palette.changeActionType(g.Commands)),this.palette.scope.register(["Mod"],this.plugin.settings.tagSearchHotkey,()=>this.palette.changeActionType(g.Tags))]}getInstructions(){const{openInNewTabMod:e,createNewFileMod:t}=this.plugin.settings;return[{command:f({modifiers:[],key:"ENTER"},this.plugin.settings),purpose:"Open file"},{command:f({modifiers:[e],key:"ENTER"},this.plugin.settings),purpose:"Open file in new pane"},{command:f({modifiers:[t],key:"ENTER"},this.plugin.settings),purpose:"Create file"},{command:f({modifiers:["Mod"],key:this.plugin.settings.commandSearchHotkey},this.plugin.settings),purpose:"Search Commands"},{command:f({modifiers:["Mod"],key:this.plugin.settings.tagSearchHotkey},this.plugin.settings),purpose:"Search Tags"}]}cleanQuery(e){return e.replace(this.fileSearchPrefix,"")}processDisplayPath(e){let t=e;return this.plugin.settings.displayOnlyNotesNames&&(t=e.split("/").pop()||e),this.plugin.settings.hideMdExtension&&t.endsWith(".md")&&(t=t.slice(0,-3)),t}async getSearchResults(e){S.debug("Enhanced search: getSearchResults called with:",e);const t=this.cleanQuery(e);if(t.length<2)return[];if(!this.searchService?.isReady())return S.debug("Enhanced search: Service not ready, returning empty results"),[];try{const e=await this.searchService.search(t,50);return S.debug("Enhanced search: Found",e.length,"results for query:",t),e.map(e=>{const t=this.processDisplayPath(e.metadata.path);return new a(e.metadata.path,t,e.metadata.tags||[])})}catch(e){return S.error("Enhanced search failed:",e),[]}}async streamSearchResults(e,t){S.debug("Enhanced search: streamSearchResults called with:",e);const i=this.cleanQuery(e);if(i.length<2||!this.searchService?.isReady())t.onUpdate([],!0);else try{await this.searchService.searchStream(i,t.limit,{signal:t.signal,onChunk:(e,i)=>{if(t.signal?.aborted)return;const s=new Set,n=e.reduce((e,t)=>{if(s.has(t.metadata.path))return e;s.add(t.metadata.path);const i=this.processDisplayPath(t.metadata.path);return e.push(new a(t.metadata.path,i,t.metadata.tags||[])),e},[]);t.onUpdate(n,i.done)}})}catch(e){if(t.signal?.aborted)return;S.error("Enhanced search streaming failed:",e),t.onUpdate([],!0)}}renderSuggestion(e,t,i){this.renderOriginalSuggestion(e,t)}renderOriginalSuggestion(t,i){let s=t.text;this.plugin.settings.displayOnlyNotesNames&&(s=t.text.split("/").pop()||t.text),this.plugin.settings.hideMdExtension&&s.endsWith(".md")&&(s=s.slice(0,-3));const n=i.createEl("div",{cls:"suggestion-title"});if(this.addFileTypeIndicator(n,t.text),this.isRecentlyAccessed(t)&&n.createEl("div",{cls:"recent-indicator"}),!this.plugin.settings.displayOnlyNotesNames&&t.text.includes("/")?this.renderSmartPath(n,t.text,s):n.createEl("span",{cls:"path-part filename",text:s}),this.unresolvedItems.has(t)&&n.addClass("unresolved"),t.id.includes(":")){n.createEl("span",{cls:"suggestion-name",text:t.text}).ariaLabel="Alias",e.setIcon(n,"right-arrow-with-tail");const[,i]=t.id.split(":");n.createEl("span",{cls:"suggestion-note",text:i})}if(t.tags&&t.tags.length>0){const e=i.createEl("div",{cls:"suggestion-note"});t.tags.forEach(t=>{t.trim()&&e.createEl("span",{cls:"tag",text:t.startsWith("#")?t:`#${t}`})})}}addFileTypeIndicator(e,t){const i=this.getFileExtension(t);if(!i)return;let s="md",n="MD";switch(i.toLowerCase()){case"md":s="md",n="MD";break;case"txt":s="txt",n="TXT";break;case"pdf":s="pdf",n="PDF";break;case"png":case"jpg":case"jpeg":case"gif":case"svg":s="img",n="IMG";break;default:n=i.toUpperCase().substring(0,3)}e.createEl("span",{cls:`file-type-indicator ${s}`,text:n})}getFileExtension(e){const t=e.match(/\.([^.]+)$/);return t?t[1]:null}renderSmartPath(e,t,i){e.textContent=t,e.title=t}isRecentlyAccessed(e){if(!this.searchService)return!1;const t=this.searchService.getLastOpened?.(e.text);if(!t)return!1;return(Date.now()-t)/864e5<1}async onChooseSuggestion(t,i){if(!t&&i){const t=this.palette.inputEl,s=this.cleanQuery(t.value);if(s)try{const t=await async function(t,i){let s=t.metadataCache.getFirstLinkpathDest(i,"");if(!s){const n=e.normalizePath(`${i}.md`),a=n.split("/").slice(0,-1).join("/");if(a)try{await t.vault.createFolder(a)}catch(e){if(!e.message?.includes("already exists")&&!e.message?.includes("Folder already exists"))throw S.error("Failed to create directory:",e),new Error(`Could not create directory: ${a}`)}try{s=await t.vault.create(n,"")}catch(e){throw S.error("Failed to create file:",e),new Error(`Could not create file: ${n}. ${e.message||"Unknown error"}`)}}return s}(this.app,s);y(this.app,this.plugin.settings,t,i)}catch(t){new e.Notice(`Failed to create file: ${t.message}`)}return}if(!t)return;let s=t.id;if(t.id.includes(":")){const[,e]=t.id.split(":");s=e}this.searchService&&this.searchService.recordFileAccess(s);const n=this.app.vault.getAbstractFileByPath(s);if(n)if(n instanceof e.TFile)try{y(this.app,this.plugin.settings,n,i),this.prevItems.add(t)}catch(t){new e.Notice(`Failed to open file: ${t.message}`)}else new e.Notice(`Path is not a file: ${s}`);else new e.Notice(`File not found: ${s}`)}usesEnhancedSearch(){return void 0!==this.searchService}async performEnhancedSearch(e){if(this.searchService)try{const t=this.cleanQuery(e);S.debug("Enhanced search: Searching for:",t);const i=Date.now(),s=this.searchService.search(t,this.plugin.settings.suggestionLimit);Date.now();if(0===s.length)return;S.debug("Enhanced search: Found",s.length,"results");const n=[],r=new Set;for(const e of s.slice(0,this.plugin.settings.suggestionLimit)){if(r.has(e.metadata.path))continue;r.add(e.metadata.path);if(!this.app.vault.getAbstractFileByPath(e.metadata.path))continue;const t=this.processDisplayPath(e.metadata.path),i=new a(e.metadata.path,t,e.metadata.tags||[]);i&&n.push(i)}this.palette.currentSuggestions=n,this.palette.limit=n.length}catch(t){S.error("Enhanced search: Error during search:",t),this.palette.getSuggestionsAsync(e)}else S.debug("Enhanced search: No search service available")}loadAllFiles(){const e=this.app.vault.getMarkdownFiles();this.allItems=e.filter(e=>!this.plugin.settings.fileTypeExclusion.some(t=>e.path.endsWith(`.${t}`))).flatMap(e=>{const t=[];t.push(new a(e.path,e.path));const i=this.app.metadataCache.getFileCache(e);if(i?.frontmatter?.aliases){(Array.isArray(i.frontmatter.aliases)?i.frontmatter.aliases:[i.frontmatter.aliases]).forEach(i=>{i&&"string"==typeof i&&t.push(new a(`${i}:${e.path}`,i))})}return t})}}class C extends e.SuggestModal{constructor(e,t,i,s,a,r,c,o="",h){super(e),this.suppressNextSearchUpdate=!1,this.toggleHiddenItems=()=>{this.showHiddenItems=!this.showHiddenItems,this.updateSuggestions()},this.fileSearchPrefix=s.settings.fileSearchPrefix,this.tagSearchPrefix=s.settings.tagSearchPrefix,this.hybridSearchPrefix="?",this.suggestionLimit=s.settings.suggestionLimit,this.initialInputValue=o,this.initialMode=h,this.plugin=s,this.modalEl.addClass("better-command-palette"),this.setPlaceholder("Select a command"),this.commandAdapter=new x(e,t,s,this),this.fileAdapter=new k(e,new n,s,this,r),this.tagAdapter=new w(e,i,s,this),this.hybridAdapter=new v(e,new n,s,this,c),this.suggestionsWorker=a,this.suggestionsWorker.onmessage=e=>this.receivedSuggestions(e),this.modalTitleEl=createEl("p",{cls:"better-command-palette-title"}),this.initialInputValue&&(this.inputEl.value=this.initialInputValue),this.updateActionType(),this.modalEl.insertBefore(this.modalTitleEl,this.modalEl.firstChild),this.hiddenItemsHeaderEl=createEl("p","hidden-items-header"),this.showHiddenItems=!1,this.hiddenItemsHeaderEl.onClickEvent(this.toggleHiddenItems),this.modalEl.insertBefore(this.hiddenItemsHeaderEl,this.resultContainerEl),this.setScopes(s)}close(e){if(this.plugin.settings.enhancedSearch.preserveQuery&&this.actionType===g.Files){const e=this.inputEl.value,t=this.fileAdapter.cleanQuery(e);this.plugin.lastFileQuery=t}super.close(),e&&e.preventDefault(),this.cancelEnhancedSearch()}setScopes(e){const t=t=>{const i=t.target;e.settings.closeWithBackspace&&""===i.value&&this.close(t)},{openInNewTabMod:i,createNewFileMod:s}=e.settings;this.scope.register([],"Backspace",e=>{t(e)}),this.scope.register(["Mod"],"Backspace",e=>{t(e)}),this.scope.register([s],"Enter",e=>{this.actionType===g.Files&&(this.currentAdapter.onChooseSuggestion(null,e),this.close(e))}),this.scope.register([s,i],"Enter",e=>{this.actionType===g.Files&&(this.currentAdapter.onChooseSuggestion(null,e),this.close(e))}),this.scope.register([i],"Enter",e=>{if(this.actionType===g.Files&&this.currentSuggestions.length){const t=document.querySelector(".better-command-palette .prompt-results"),i=document.querySelector(".better-command-palette .is-selected");if(t&&i){const s=Array.from(t.children).indexOf(i);if(s>=0&&s<this.currentSuggestions.length){const t=this.currentSuggestions[s]||null;this.currentAdapter.onChooseSuggestion(t,e),this.close(e)}}}}),this.scope.register(["Mod"],"I",this.toggleHiddenItems)}onOpen(){super.onOpen(),this.plugin.usageTracker&&this.plugin.usageTracker.recordSearchModalOpen(),this.initialInputValue&&(this.plugin.settings.enhancedSearch.preserveQuery&&this.initialInputValue===this.plugin.settings.fileSearchPrefix&&this.plugin.lastFileQuery?this.inputEl.value=this.initialInputValue+this.plugin.lastFileQuery:this.inputEl.value=this.initialInputValue,this.updateActionType(),this.currentAdapter.initialized||this.currentAdapter.initialize(),this.updateSuggestions())}changeActionType(e){let t="";e===g.Files?t=this.plugin.settings.fileSearchPrefix:e===g.Tags?t=this.plugin.settings.tagSearchPrefix:e===g.Hybrid&&(t=this.hybridSearchPrefix);const i=this.inputEl.value;if(this.plugin.settings.enhancedSearch.preserveQuery||this.plugin.settings.semanticSearch.preserveQuery){const e=this.currentAdapter.cleanQuery(i);this.inputEl.value=t+e}else this.inputEl.value=t;this.updateSuggestions()}setQuery(e,t=-1){this.inputEl.value=e,t>-1&&this.inputEl.setSelectionRange(t,t),this.updateSuggestions()}updateActionType(){const e=this.inputEl.value;let t,i;e.startsWith(this.hybridSearchPrefix)?(i=g.Hybrid,t=this.hybridAdapter,this.modalEl.setAttribute("palette-mode","hybrid")):e.startsWith(this.fileSearchPrefix)?(i=g.Files,t=this.fileAdapter,this.modalEl.setAttribute("palette-mode","files")):e.startsWith(this.tagSearchPrefix)?(i=g.Tags,t=this.tagAdapter,this.modalEl.setAttribute("palette-mode","tags")):this.initialMode?(i=this.initialMode,i===g.Hybrid?(t=this.hybridAdapter,this.modalEl.setAttribute("palette-mode","hybrid")):i===g.Files?(t=this.fileAdapter,this.modalEl.setAttribute("palette-mode","files")):i===g.Tags?(t=this.tagAdapter,this.modalEl.setAttribute("palette-mode","tags")):(i=g.Commands,t=this.commandAdapter,this.modalEl.setAttribute("palette-mode","commands"))):(i=g.Commands,t=this.commandAdapter,this.modalEl.setAttribute("palette-mode","commands")),i!==this.actionType&&(this.currentAdapter?.unmount(),this.currentAdapter=t,this.currentAdapter.mount()),this.currentAdapter.initialized||this.currentAdapter.initialize();const s=i!==this.actionType;return this.actionType=i,s&&(this.updateEmptyStateText(),this.updateTitleText(),this.updateInstructions(),this.currentSuggestions=this.currentAdapter.getSortedItems().slice(0,this.suggestionLimit)),s}updateTitleText(){this.plugin.settings.showPluginName?this.modalTitleEl.setText(this.currentAdapter.getTitleText()):this.modalTitleEl.setText("")}updateEmptyStateText(){this.emptyStateText=this.currentAdapter.getEmptyStateText()}updateInstructions(){Array.from(this.modalEl.getElementsByClassName("prompt-instructions")).forEach(e=>{this.modalEl.removeChild(e)}),this.setInstructions([...this.currentAdapter.getInstructions(),{command:f({modifiers:[],key:"ESC"},this.plugin.settings),purpose:"Close palette"},{command:f({modifiers:["Mod"],key:"I"},this.plugin.settings),purpose:"Toggle Hidden Items"}])}getItems(){return this.currentAdapter.getSortedItems()}receivedSuggestions(e){const t=[];let i=0;for(let s=0;s<e.data.length&&t.length<this.suggestionLimit+i;s+=1)t.push(e.data[s]),this.currentAdapter.hiddenIds.includes(e.data[s].id)&&(i+=1);const s=t.map(e=>new a(e.id,e.text,e.tags)),n=this.currentAdapter.getPrevItems();s.sort((e,t)=>+n.has(t)-+n.has(e)),this.currentSuggestions=s,this.limit=this.currentSuggestions.length,this.updateSuggestions()}getSuggestionsAsync(e){const t=this.getItems();this.suggestionsWorker.postMessage({query:e,items:t})}applySearchResults(e,t=!0){const i=new Map;e.forEach(e=>{e.id&&i.set(e.id,e)});const s=Array.from(i.values());this.currentSuggestions=s.slice(0,this.suggestionLimit),this.limit=this.currentSuggestions.length,t&&(this.suppressNextSearchUpdate=!0,this.updateSuggestions())}cancelEnhancedSearch(){this.currentSearchAbortController&&(this.currentSearchAbortController.abort(),this.currentSearchAbortController=void 0)}async getEnhancedSearchResults(e){try{const t=this.currentAdapter;if(this.cancelEnhancedSearch(),t.streamSearchResults){const i=new AbortController;return this.currentSearchAbortController=i,void await t.streamSearchResults(e,{limit:this.suggestionLimit,signal:i.signal,onUpdate:(e,s)=>{i.signal.aborted||t!==this.currentAdapter||(this.applySearchResults(e),s&&this.cancelEnhancedSearch())}})}if(t.getSearchResults){const i=await t.getSearchResults(e);if(t!==this.currentAdapter)return;return void this.applySearchResults(i)}this.getSuggestionsAsync(e)}catch(t){this.cancelEnhancedSearch(),S.error("Enhanced search failed:",t),this.getSuggestionsAsync(e)}}getSuggestions(e){let t=e;this.initialInputValue&&""===e&&this.inputEl.value!==this.initialInputValue&&(t=this.initialInputValue,this.inputEl.value=this.initialInputValue);const i=this.updateActionType();this.currentAdapter.initialized||this.currentAdapter.initialize();const s=this.suppressNextSearchUpdate&&this.currentAdapter.usesEnhancedSearch&&this.currentAdapter.usesEnhancedSearch(),n=(t!==this.lastQuery||0===this.currentSuggestions.length||i)&&!s;this.suppressNextSearchUpdate=!1,this.lastQuery=t;const a=this.currentAdapter.cleanQuery(t.trim());n&&(i&&(this.currentSuggestions=[]),this.currentAdapter.usesEnhancedSearch&&this.currentAdapter.usesEnhancedSearch()?(this.getEnhancedSearchResults(a),0===this.currentSuggestions.length&&(this.currentSuggestions=this.currentAdapter.getSortedItems().slice(0,this.suggestionLimit))):this.getSuggestionsAsync(a));const r=this.currentSuggestions.filter(e=>!this.currentAdapter.hiddenIds.includes(e.id)),c=this.currentSuggestions.length-r.length;return this.updateHiddenItemCountHeader(c),this.showHiddenItems?this.currentSuggestions:r}updateHiddenItemCountHeader(e){if(this.hiddenItemsHeaderEl.empty(),0!==e){const t=`${this.showHiddenItems?"Hide":"Show"} hidden items (${e})`;this.hiddenItemsHeaderEl.setText(t)}}renderSuggestion(t,i){i.addClass("mod-complex");const s=this.currentAdapter.hiddenIds.includes(t.id);s&&i.addClass("hidden");const n=i.createEl("span","suggestion-content"),a=i.createEl("span","suggestion-aux"),r=a.createEl("span","suggestion-flair");!function(e,t,i,s){s.has(t)&&(i.addClass("recent"),i.createEl("span",{cls:"suggestion-note",text:e.recentlyUsedText}))}(this.plugin.settings,t,n,this.currentAdapter.getPrevItems()),e.setIcon(r,"cross",13),r.ariaLabel=s?"Click to Unhide":"Click to Hide",r.setAttr("data-id",t.id),r.onClickEvent(e=>{e.preventDefault(),e.stopPropagation();const t=e.target.getAttr("data-id");t&&this.currentAdapter.toggleHideId(t)}),this.currentAdapter.renderSuggestion(t,n,a)}async onChooseSuggestion(e,t){this.currentAdapter.onChooseSuggestion(e,t)}async performEnhancedSearch(e){try{if(!this.enhancedSearchService)return;const t=(await this.enhancedSearchService.search(e,this.currentLimit)).map(e=>({text:e.metadata.path,score:e.relevanceScore,metadata:e.metadata}));this.currentSuggestions=[...this.currentSuggestions,...t];const i=this.currentSuggestions.filter((e,t,i)=>t===i.findIndex(t=>t.text===e.text));this.currentSuggestions=i.sort((e,t)=>(t.score||0)-(e.score||0)).slice(0,this.currentLimit)}catch(e){S.error("Enhanced search failed:",e)}}}const I={enabled:!1,rrfK:60,keywordWeight:.5,semanticWeight:.5,enableReRanking:!0,reRankPoolSize:20,reRankTitleWeight:.25,reRankRecencyWeight:.15,reRankUsageWeight:.15,reRankContentWeight:.25,reRankPageRankWeight:.2,reRankProximityWeight:.15,maxResults:20,minScoreThreshold:.1,searchTimeoutMs:5e3,showMatchReasons:!0,searchHotkey:"h",enableClustering:!1,clusterSimilarityThreshold:.85},T={throttleMs:200,debounceMs:500,name:"SmartScheduler"};class F{constructor(e,t={}){this.onFlush=e,this.throttleTimer=null,this.debounceTimer=null,this.pendingItems=new Set,this.isDestroyed=!1,this.options={...T,...t}}schedule(e){this.isDestroyed||(this.pendingItems.add(e),S.debug(`[${this.options.name}] ðŸ“¥ Scheduled: ${e} (${this.pendingItems.size} pending)`),S.debug(`[${this.options.name}] Scheduled: ${e} (${this.pendingItems.size} pending)`),this.throttleTimer||(S.debug(`[${this.options.name}] â±ï¸ Throttle timer started (${this.options.throttleMs}ms)`),this.throttleTimer=setTimeout(()=>{this.throttleTimer=null,this.pendingItems.size>0&&this.performFlush("throttle")},this.options.throttleMs)),this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.debounceTimer=null,this.pendingItems.size>0&&this.performFlush("debounce")},this.options.debounceMs))}async flush(){this.pendingItems.size>0&&await this.performFlush("manual")}get pendingCount(){return this.pendingItems.size}get hasPending(){return this.pendingItems.size>0}destroy(){this.isDestroyed=!0,this.throttleTimer&&(clearTimeout(this.throttleTimer),this.throttleTimer=null),this.debounceTimer&&(clearTimeout(this.debounceTimer),this.debounceTimer=null),this.pendingItems.clear(),S.debug(`[${this.options.name}] ðŸ›‘ Destroyed`),S.debug(`[${this.options.name}] Destroyed`)}async performFlush(e){if(0===this.pendingItems.size)return;const t=Array.from(this.pendingItems);this.pendingItems.clear();const i="throttle"===e?"âš¡":"debounce"===e?"âœ…":"ðŸ”„";S.debug(`[${this.options.name}] ${i} Flush (${e}): Processing ${t.length} items:`,t),S.debug(`[${this.options.name}] Flush (${e}): ${t.length} items`);try{await this.onFlush(t),S.debug(`[${this.options.name}] âœ“ Flush complete`)}catch(e){console.error(`[${this.options.name}] âœ— Flush failed:`,e),S.error(`[${this.options.name}] Flush failed:`,e)}}}const E={dampingFactor:.85,maxIterations:20,convergenceThreshold:1e-4,enabled:!0,weight:.15};class M{constructor(e,t=E){this.graph=new Map,this.pageRanks=new Map,this.isComputed=!1,this.lastComputeTime=0,this.storageKey="better-command-palette-link-graph",this.vault=e.vault,this.metadataCache=e.metadataCache,this.settings=t,this.scheduler=new F(()=>this.processScheduledRecompute(),{throttleMs:6e4,debounceMs:1e4,name:"LinkGraph"}),this.loadFromStorage()}updateSettings(e){this.settings={...this.settings,...e},this.isComputed=!1}getPageRankScore(e){return this.settings.enabled?this.pageRanks.get(e)??0:0}getBacklinkCount(t){const i=this.vault.getAbstractFileByPath(t);if(i&&i instanceof e.TFile){const e=this.metadataCache.getBacklinksForFile(i);if(e&&e.count)return e.count()}const s=this.graph.get(t);return s?.inLinks.size??0}getTopByPageRank(e=10){return Array.from(this.pageRanks.entries()).map(([e,t])=>({path:e,score:t,backlinks:this.getBacklinkCount(e)})).sort((e,t)=>t.score-e.score).slice(0,e)}async buildGraph(){const t=Date.now();S.debug("[LinkGraph] Building graph from vault..."),this.graph.clear();const i=this.vault.getMarkdownFiles();S.debug(`[LinkGraph] Found ${i.length} markdown files`);for(const e of i)this.graph.set(e.path,{path:e.path,outLinks:new Set,inLinks:new Set,pageRank:1/i.length});let s=0;for(const t of i){const i=this.metadataCache.getFileCache(t);if(!i)continue;const n=this.graph.get(t.path),a=[...i.links??[],...i.embeds??[]];for(const i of a){const a=this.metadataCache.getFirstLinkpathDest(i.link,t.path);if(a&&a instanceof e.TFile){const e=a.path;e!==t.path&&this.graph.has(e)&&(n.outLinks.add(e),s++)}}}let n=0;for(const e of i){const t=this.graph.get(e.path),i=this.metadataCache.getBacklinksForFile(e);if(i&&i.keys)for(const s of i.keys())s!==e.path&&this.graph.has(s)&&(t.inLinks.add(s),n++)}const a=Date.now()-t;S.debug(`[LinkGraph] Built graph: ${i.length} nodes, ${s} outLinks, ${n} backlinks in ${a}ms`);const r=Array.from(this.graph.values()).map(e=>({path:e.path,inLinks:e.inLinks.size,outLinks:e.outLinks.size})).sort((e,t)=>t.inLinks-e.inLinks).slice(0,5);S.debug("[LinkGraph] Top linked files:",r),S.debug(`Link graph: Built graph with ${i.length} nodes, ${s} outLinks, ${n} backlinks in ${a}ms`)}computePageRank(){if(!this.settings.enabled)return;const e=Date.now(),{dampingFactor:t,maxIterations:i,convergenceThreshold:s}=this.settings,n=Array.from(this.graph.values()),a=n.length;if(0===a)return void S.debug("Link graph: No nodes to compute PageRank");const r=1/a;for(const e of n)e.pageRank=r;for(let e=0;e<i;e++){let i=0;const r=new Map;for(const e of n){let s=0;for(const t of e.inLinks){const e=this.graph.get(t);e&&e.outLinks.size>0&&(s+=e.pageRank/e.outLinks.size)}const n=(1-t)/a+t*s;r.set(e.path,n);const c=Math.abs(n-e.pageRank);i=Math.max(i,c)}for(const e of n)e.pageRank=r.get(e.path);if(i<s){S.debug(`Link graph: PageRank converged after ${e+1} iterations`);break}}this.normalizeAndStoreScores();const c=Date.now()-e;this.lastComputeTime=Date.now(),this.isComputed=!0,S.debug(`Link graph: Computed PageRank for ${a} nodes in ${c}ms`),this.saveToStorage()}normalizeAndStoreScores(){let e=0;for(const t of this.graph.values())e=Math.max(e,t.pageRank);if(this.pageRanks.clear(),e>0)for(const t of this.graph.values())this.pageRanks.set(t.path,t.pageRank/e)}async recompute(){await this.buildGraph(),this.computePageRank()}onFileCreate(e){"md"===e.extension&&(this.graph.set(e.path,{path:e.path,outLinks:new Set,inLinks:new Set,pageRank:0}),this.isComputed=!1,this.queueUpdate(e.path))}onFileDelete(e){const t=this.graph.get(e);if(t){for(const i of t.outLinks){const t=this.graph.get(i);t?.inLinks.delete(e)}for(const i of t.inLinks){const t=this.graph.get(i);t?.outLinks.delete(e)}this.graph.delete(e),this.pageRanks.delete(e),this.isComputed=!1,this.queueUpdate(e)}}onFileRename(e,t){const i=this.graph.get(e);if(!i)return;i.path=t,this.graph.delete(e),this.graph.set(t,i);for(const s of i.outLinks){const i=this.graph.get(s);i&&(i.inLinks.delete(e),i.inLinks.add(t))}for(const s of i.inLinks){const i=this.graph.get(s);i&&(i.outLinks.delete(e),i.outLinks.add(t))}const s=this.pageRanks.get(e);void 0!==s&&(this.pageRanks.delete(e),this.pageRanks.set(t,s))}async onFileModify(t){if(S.debug("[LinkGraph] onFileModify called:",t.path),"md"!==t.extension)return;const i=this.graph.get(t.path);if(!i)return void this.onFileCreate(t);for(const e of i.outLinks){const i=this.graph.get(e);i?.inLinks.delete(t.path)}i.outLinks.clear();const s=this.metadataCache.getFileCache(t);if(s?.links)for(const n of s.links){const s=this.metadataCache.getFirstLinkpathDest(n.link,t.path);if(s&&s instanceof e.TFile){const e=s.path,n=this.graph.get(e);n&&e!==t.path&&(i.outLinks.add(e),n.inLinks.add(t.path))}}this.isComputed=!1,this.queueUpdate(t.path)}queueUpdate(e){S.debug(`[LinkGraph] Queued update for ${e}`),S.debug(`Link graph: Queued update for ${e}`),this.scheduler.schedule(e)}async processScheduledRecompute(){S.debug("[LinkGraph] processScheduledRecompute called"),S.debug("Link graph: Processing scheduled recompute");try{S.debug("[LinkGraph] Starting recompute..."),await this.recompute(),S.debug("[LinkGraph] Recompute complete!"),S.debug("Link graph: Recompute complete")}catch(e){console.error("[LinkGraph] Recompute failed:",e),S.error("Link graph: Failed to recompute after updates",e)}}async flushUpdates(){await this.scheduler.flush()}getStats(){let e=0,t=0,i=0;for(const s of this.graph.values()){const n=s.inLinks.size;e+=n,t=Math.max(t,n),i+=s.outLinks.size}const s=this.graph.size;return{nodeCount:s,edgeCount:i,isComputed:this.isComputed,avgBacklinks:s>0?e/s:0,maxBacklinks:t}}saveToStorage(){try{const e={version:"1.0.0",timestamp:Date.now(),scores:Array.from(this.pageRanks.entries())};localStorage.setItem(this.storageKey,JSON.stringify(e))}catch(e){S.warn("Link graph: Failed to save to storage",e)}}loadFromStorage(){try{const e=localStorage.getItem(this.storageKey);if(!e)return;const t=JSON.parse(e);if("1.0.0"===t.version&&t.scores){this.pageRanks=new Map(t.scores);Date.now()-(t.timestamp||0)<36e5&&(this.isComputed=!0,S.debug("Link graph: Loaded cached PageRank scores"))}}catch(e){S.warn("Link graph: Failed to load from storage",e)}}reset(){this.graph.clear(),this.pageRanks.clear(),this.isComputed=!1,localStorage.removeItem(this.storageKey)}}const L={closeWithBackspace:!0,showPluginName:!0,fileSearchPrefix:"/",tagSearchPrefix:"#",commandSearchHotkey:"p",fileSearchHotkey:"o",tagSearchHotkey:"t",suggestionLimit:50,recentAbovePinned:!1,hyperKeyOverride:!1,displayOnlyNotesNames:!1,hideMdExtension:!1,recentlyUsedText:"(recently used)",macros:[],hotkeyStyle:"auto",createNewFileMod:"Mod",openInNewTabMod:"Shift",hiddenCommands:[],hiddenFiles:[],hiddenTags:[],fileTypeExclusion:[],enhancedSearch:{scoreWeights:{relevance:.5,recency:.2,frequency:.15,linkImportance:.15},recencyHalfLife:6048e5,maxUsageScore:100,maxIndexedFiles:1e4,enableUsageTracking:!0,indexingDebounceMs:1e3,searchTimeoutMs:5e3,contentPreviewLength:200,enableContentSearch:!0,preserveQuery:!1,indexingBatchSize:2,indexingDelayMs:150,indexingBatchDelayMs:400,maxFileSize:524288,typoTolerance:1,foldAccents:!0,enableStemming:!1,synonyms:[]},semanticSearch:{enableSemanticSearch:!1,ollamaUrl:"http://localhost:11434",embeddingModel:"nomic-embed-text",searchThreshold:.3,maxResults:10,chunkSize:1e3,maxConcurrentRequests:5,enableAdaptiveThrottling:!0,cacheEnabled:!0,excludePatterns:["**/node_modules/**","**/.git/**","**/.*/**","**/*.excalidraw.md","**/*.sfile.md"],preserveQuery:!1},hybridSearch:I,linkGraph:E,quickLink:{enabled:!0,defaultHotkey:"l",autoCloseModal:!0,searchEngine:"enhanced"}};class R{constructor(){this.id="general",this.title="General",this.icon="settings-2"}display(t,i,s){const{settings:n}=s;new e.Setting(t).setName("Close on Backspace").setDesc("Close the palette when there is no text and backspace is pressed").addToggle(e=>e.setValue(n.closeWithBackspace).onChange(async e=>{n.closeWithBackspace=e,await s.saveSettings()})),new e.Setting(t).setName("Show Plugin Name").setDesc("Display the plugin name in commands for easier identification").addToggle(e=>e.setValue(n.showPluginName).onChange(async e=>{n.showPluginName=e,await s.saveSettings()})),new e.Setting(t).setName("Recent Above Pinned").setDesc("Prioritize recently used items over pinned items in search results").addToggle(e=>e.setValue(n.recentAbovePinned).onChange(async e=>{n.recentAbovePinned=e,await s.saveSettings()})),new e.Setting(t).setName("Recently Used Label").setDesc("Custom text displayed next to recently used items").addText(e=>e.setPlaceholder("(recently used)").setValue(n.recentlyUsedText).onChange(async e=>{e.trim()&&(n.recentlyUsedText=e,await s.saveSettings())})),t.createEl("h3",{text:"Display Options"}),new e.Setting(t).setName("Display Only Note Names").setDesc("Show only file names instead of full paths in search results").addToggle(e=>e.setValue(n.displayOnlyNotesNames).onChange(async e=>{n.displayOnlyNotesNames=e,await s.saveSettings()})),new e.Setting(t).setName("Hide .md Extensions").setDesc("Remove .md extensions from note names in search results").addToggle(e=>e.setValue(n.hideMdExtension).onChange(async e=>{n.hideMdExtension=e,await s.saveSettings()})),new e.Setting(t).setName("Suggestion Limit").setDesc("Maximum number of suggestions to display").addSlider(e=>e.setLimits(10,100,5).setValue(n.suggestionLimit).setDynamicTooltip().onChange(async e=>{n.suggestionLimit=e,await s.saveSettings()})),t.createEl("h3",{text:"Shortcuts"}),new e.Setting(t).setName("Hyper Key Override").setDesc("Use caps lock icon (â‡ª) instead of âŒ¥ ^ âŒ˜ â‡§ for hyper key users").addToggle(e=>e.setValue(n.hyperKeyOverride).onChange(async e=>{n.hyperKeyOverride=e,await s.saveSettings()})),t.createEl("h3",{text:"Prefixes & Hotkeys"}),new e.Setting(t).setName("File Search Prefix").setDesc("Character to trigger file search in command palette").addText(e=>e.setValue(n.fileSearchPrefix).onChange(async e=>{n.fileSearchPrefix=e||"/",await s.saveSettings()})),new e.Setting(t).setName("Tag Search Prefix").setDesc("Character to trigger tag search in command palette").addText(e=>e.setValue(n.tagSearchPrefix).onChange(async e=>{n.tagSearchPrefix=e||"#",await s.saveSettings()})),new e.Setting(t).setName("Command Search Hotkey").setDesc("Key to open command search (with Cmd/Ctrl)").addText(e=>e.setValue(n.commandSearchHotkey).onChange(async e=>{n.commandSearchHotkey=e||"p",await s.saveSettings()})),new e.Setting(t).setName("File Search Hotkey").setDesc("Key to open file search (with Cmd/Ctrl)").addText(e=>e.setValue(n.fileSearchHotkey).onChange(async e=>{n.fileSearchHotkey=e||"o",await s.saveSettings()})),new e.Setting(t).setName("Tag Search Hotkey").setDesc("Key to open tag search (with Cmd/Ctrl)").addText(e=>e.setValue(n.tagSearchHotkey).onChange(async e=>{n.tagSearchHotkey=e||"t",await s.saveSettings()})),new e.Setting(t).setName("Reverse File Creation Shortcut").setDesc("Use Shift to create files and Cmd/Ctrl to open in new tab (matches default quick switcher)").addToggle(e=>e.setValue("Shift"===n.createNewFileMod).onChange(async e=>{n.createNewFileMod=e?"Shift":"Mod",n.openInNewTabMod=e?"Mod":"Shift",await s.saveSettings()}))}}class ${constructor(){this.id="search",this.title="Search",this.icon="search"}display(t,i,s){const{settings:n}=s;if(new e.Setting(t).setName("Enable Enhanced Content Search").setDesc("Activate content indexing and smart scoring").addToggle(e=>e.setValue(n.enhancedSearch.enableContentSearch).onChange(async e=>{n.enhancedSearch.enableContentSearch=e,await s.saveSettings(),this.display(t,i,s)})),!n.enhancedSearch.enableContentSearch)return;t.createEl("h3",{text:"Scoring Weights"});const a=(i,a)=>{new e.Setting(t).setName(i).addSlider(e=>e.setLimits(0,1,.05).setValue(n.enhancedSearch.scoreWeights[a]||0).setDynamicTooltip().onChange(async e=>{n.enhancedSearch.scoreWeights[a]=e,await s.saveSettings()}))};a("Content Relevance","relevance"),a("Recency","recency"),a("Frequency","frequency"),a("Link Importance","linkImportance"),t.createEl("h3",{text:"Link Graph (PageRank)"}),new e.Setting(t).setName("Enable Link Graph").setDesc("Compute page importance based on links").addToggle(e=>e.setValue(n.linkGraph.enabled).onChange(async e=>{n.linkGraph.enabled=e,await s.saveSettings()})),new e.Setting(t).setName("Damping Factor").setDesc("Probability of continuing to follow links (0.85 is standard)").addSlider(e=>e.setLimits(.5,.99,.01).setValue(n.linkGraph.dampingFactor).setDynamicTooltip().onChange(async e=>{n.linkGraph.dampingFactor=e,await s.saveSettings()})),new e.Setting(t).setName("Max Iterations").setDesc("Maximum number of calculation steps").addSlider(e=>e.setLimits(10,100,5).setValue(n.linkGraph.maxIterations).setDynamicTooltip().onChange(async e=>{n.linkGraph.maxIterations=e,await s.saveSettings()})),new e.Setting(t).setName("Link Graph Weight").setDesc("Weight of link importance in final scoring (0-1)").addSlider(e=>e.setLimits(0,1,.05).setValue(n.linkGraph.weight).setDynamicTooltip().onChange(async e=>{n.linkGraph.weight=e,await s.saveSettings()})),t.createEl("h3",{text:"Matching"}),new e.Setting(t).setName("Typo Tolerance").setDesc("Fuzzy matching level (0 = exact, 1 = minor typos, 2 = more lenient)").addSlider(e=>e.setLimits(0,2,1).setValue(n.enhancedSearch.typoTolerance).setDynamicTooltip().onChange(async e=>{n.enhancedSearch.typoTolerance=e,await s.saveSettings()})),new e.Setting(t).setName("Accent Folding").setDesc("Treat accented characters as equivalent (e.g., Ã© = e)").addToggle(e=>e.setValue(n.enhancedSearch.foldAccents).onChange(async e=>{n.enhancedSearch.foldAccents=e,await s.saveSettings()})),new e.Setting(t).setName("Enable Stemming").setDesc("Match word variations (e.g., running = run)").addToggle(e=>e.setValue(n.enhancedSearch.enableStemming).onChange(async e=>{n.enhancedSearch.enableStemming=e,await s.saveSettings()})),new e.Setting(t).setName("Preserve Query").setDesc("Keep search query when switching between search modes").addToggle(e=>e.setValue(n.enhancedSearch.preserveQuery).onChange(async e=>{n.enhancedSearch.preserveQuery=e,await s.saveSettings()})),t.createEl("h3",{text:"Performance"}),new e.Setting(t).setName("Enable Usage Tracking").setDesc("Track file access for smarter ranking").addToggle(e=>e.setValue(n.enhancedSearch.enableUsageTracking).onChange(async e=>{n.enhancedSearch.enableUsageTracking=e,await s.saveSettings()})),new e.Setting(t).setName("Maximum Indexed Files").addSlider(e=>e.setLimits(1e3,5e4,1e3).setValue(n.enhancedSearch.maxIndexedFiles).setDynamicTooltip().onChange(async e=>{n.enhancedSearch.maxIndexedFiles=e,await s.saveSettings()})),new e.Setting(t).setName("Indexing Debounce (ms)").setDesc("Wait time after file changes before re-indexing").addSlider(e=>e.setLimits(100,5e3,100).setValue(n.enhancedSearch.indexingDebounceMs).setDynamicTooltip().onChange(async e=>{n.enhancedSearch.indexingDebounceMs=e,await s.saveSettings()})),new e.Setting(t).setName("Max File Size (KB)").setDesc("Skip indexing files larger than this (for performance)").addSlider(e=>e.setLimits(128,2048,128).setValue(Math.round(n.enhancedSearch.maxFileSize/1024)).setDynamicTooltip().onChange(async e=>{n.enhancedSearch.maxFileSize=1024*e,await s.saveSettings()})),new e.Setting(t).setName("Content Preview Length").setDesc("Length of content snippets in search results").addSlider(e=>e.setLimits(50,500,50).setValue(n.enhancedSearch.contentPreviewLength).setDynamicTooltip().onChange(async e=>{n.enhancedSearch.contentPreviewLength=e,await s.saveSettings()})),t.createEl("h3",{text:"Actions"});const r=new e.Setting(t).setName("Maintenance").setDesc("Manage search index");r.addButton(t=>t.setButtonText("Rebuild Index").onClick(async()=>{new e.Notice("Rebuilding index..."),setTimeout(()=>new e.Notice("Done"),1e3)})),r.addButton(t=>t.setButtonText("Clear Cache").setWarning().onClick(async()=>{new e.Notice("Cache cleared")}))}}class z{constructor(){this.id="semantic",this.title="Semantic",this.icon="brain-circuit"}display(t,i,s){const{settings:n}=s;if(new e.Setting(t).setName("Enable Semantic Search").setDesc("Activate AI-powered semantic search using Ollama embeddings").addToggle(e=>e.setValue(n.semanticSearch.enableSemanticSearch).onChange(async e=>{n.semanticSearch.enableSemanticSearch=e,await s.saveSettings(),this.display(t,i,s)})),!n.semanticSearch.enableSemanticSearch){return void t.createEl("div",{cls:"settings-info"}).createEl("p",{text:"Semantic search requires Ollama to be installed and running. Enable this feature to configure advanced AI-powered search capabilities."})}t.createEl("h3",{text:"Connection Settings"}),new e.Setting(t).setName("Ollama URL").setDesc("URL of your Ollama server").addText(e=>e.setPlaceholder("http://localhost:11434").setValue(n.semanticSearch.ollamaUrl).onChange(async e=>{n.semanticSearch.ollamaUrl=e,await s.saveSettings()})),new e.Setting(t).setName("Embedding Model").setDesc("Model to use for embeddings (e.g., nomic-embed-text, bge-m3)").addText(e=>e.setPlaceholder("nomic-embed-text").setValue(n.semanticSearch.embeddingModel||"nomic-embed-text").onChange(async e=>{n.semanticSearch.embeddingModel=e.trim()||"nomic-embed-text",await s.saveSettings()})),t.createEl("h3",{text:"Search Parameters"}),new e.Setting(t).setName("Search Threshold").setDesc("Minimum similarity score for search results (lower = more results)").addSlider(e=>e.setLimits(.1,.9,.05).setValue(n.semanticSearch.searchThreshold).setDynamicTooltip().onChange(async e=>{n.semanticSearch.searchThreshold=e,await s.saveSettings()})),new e.Setting(t).setName("Maximum Results").setDesc("Maximum number of semantic search results to return").addSlider(e=>e.setLimits(5,50,5).setValue(n.semanticSearch.maxResults).setDynamicTooltip().onChange(async e=>{n.semanticSearch.maxResults=e,await s.saveSettings()})),t.createEl("h3",{text:"Performance"}),new e.Setting(t).setName("Chunk Size").setDesc("Text chunk size for embedding (larger = more context, slower)").addSlider(e=>e.setLimits(500,2e3,100).setValue(n.semanticSearch.chunkSize).setDynamicTooltip().onChange(async e=>{n.semanticSearch.chunkSize=e,await s.saveSettings()})),new e.Setting(t).setName("Max Concurrent Requests").setDesc("Maximum simultaneous requests to Ollama (1-10)").addSlider(e=>e.setLimits(1,10,1).setValue(n.semanticSearch.maxConcurrentRequests).setDynamicTooltip().onChange(async e=>{n.semanticSearch.maxConcurrentRequests=e,await s.saveSettings()})),new e.Setting(t).setName("Adaptive Throttling").setDesc("Automatically adjust concurrency based on Ollama response times").addToggle(e=>e.setValue(n.semanticSearch.enableAdaptiveThrottling??!0).onChange(async e=>{n.semanticSearch.enableAdaptiveThrottling=e,await s.saveSettings()})),new e.Setting(t).setName("Enable Cache").setDesc("Cache embeddings to improve performance (recommended)").addToggle(e=>e.setValue(n.semanticSearch.cacheEnabled).onChange(async e=>{n.semanticSearch.cacheEnabled=e,await s.saveSettings()})),new e.Setting(t).setName("Preserve Query").setDesc("Keep search query when switching between search modes").addToggle(e=>e.setValue(n.semanticSearch.preserveQuery).onChange(async e=>{n.semanticSearch.preserveQuery=e,await s.saveSettings()})),t.createEl("h3",{text:"Exclusions"}),new e.Setting(t).setName("Exclude Patterns").setDesc("Glob patterns to exclude from indexing (one per line)").addTextArea(e=>{e.inputEl.rows=4,e.inputEl.cols=40,e.setPlaceholder("**/templates/**\n**/daily-notes/**").setValue(n.semanticSearch.excludePatterns.join("\n")).onChange(async e=>{n.semanticSearch.excludePatterns=e.split("\n").map(e=>e.trim()).filter(e=>e.length>0),await s.saveSettings()})}),t.createEl("h3",{text:"Actions"}),new e.Setting(t).setName("Rebuild Semantic Index").setDesc("Recreate the semantic search index from scratch").addButton(t=>t.setButtonText("Rebuild Index").setCta().onClick(async()=>{t.setButtonText("Rebuilding..."),t.setDisabled(!0);try{await s.reindexSemanticSearch(),new e.Notice("Semantic search index rebuilt successfully")}catch(t){new e.Notice(`Failed: ${t}`,5e3)}finally{t.setButtonText("Rebuild Index"),t.setDisabled(!1)}}))}}class D{constructor(){this.id="hybrid",this.title="Hybrid",this.icon="layers"}display(t,i,s){const{settings:n}=s;if(new e.Setting(t).setName("Enable Hybrid Search").setDesc("Combine keyword and semantic search for Google-like results").addToggle(e=>e.setValue(n.hybridSearch.enabled).onChange(async e=>{n.hybridSearch.enabled=e,await s.saveSettings(),this.display(t,i,s)})),!n.hybridSearch.enabled)return void t.createEl("div",{cls:"settings-info",text:"Enable hybrid search to access advanced configuration."});n.semanticSearch.enableSemanticSearch||t.createEl("div",{cls:"settings-warning",text:"âš ï¸ Semantic search is not enabled. Hybrid search works best when Semantic Search is active."}),t.createEl("h3",{text:"Fusion Settings"}),new e.Setting(t).setName("RRF K Parameter").setDesc("Balance between high-ranking and low-ranking items (default: 60)").addSlider(e=>e.setLimits(1,100,1).setValue(n.hybridSearch.rrfK).setDynamicTooltip().onChange(async e=>{n.hybridSearch.rrfK=e,await s.saveSettings()})),new e.Setting(t).setName("Keyword Weight").setDesc("Importance of keyword matches (0-1)").addSlider(e=>e.setLimits(0,1,.1).setValue(n.hybridSearch.keywordWeight).setDynamicTooltip().onChange(async e=>{n.hybridSearch.keywordWeight=e,await s.saveSettings()})),new e.Setting(t).setName("Semantic Weight").setDesc("Importance of semantic matches (0-1)").addSlider(e=>e.setLimits(0,1,.1).setValue(n.hybridSearch.semanticWeight).setDynamicTooltip().onChange(async e=>{n.hybridSearch.semanticWeight=e,await s.saveSettings()})),t.createEl("h3",{text:"Re-ranking"}),new e.Setting(t).setName("Enable Re-ranking").setDesc("Apply smart scoring to refine top results").addToggle(e=>e.setValue(n.hybridSearch.enableReRanking).onChange(async e=>{n.hybridSearch.enableReRanking=e,await s.saveSettings()})),new e.Setting(t).setName("Re-rank Pool Size").setDesc("How many results to re-rank (default: 20)").addSlider(e=>e.setLimits(5,50,5).setValue(n.hybridSearch.reRankPoolSize).setDynamicTooltip().onChange(async e=>{n.hybridSearch.reRankPoolSize=e,await s.saveSettings()}));const a=(i,a,r)=>{new e.Setting(t).setName(i).setDesc(a).addSlider(e=>e.setLimits(0,1,.1).setValue(n.hybridSearch[r]).setDynamicTooltip().onChange(async e=>{n.hybridSearch[r]=e,await s.saveSettings()}))};a("Title Match Weight","Boost title matches","reRankTitleWeight"),a("Recency Weight","Boost recently modified files","reRankRecencyWeight"),a("Usage Weight","Boost frequently accessed files","reRankUsageWeight"),a("Link Importance Weight","Boost well-connected files (PageRank)","reRankPageRankWeight"),a("Content Density Weight","Boost files with more matching content","reRankContentWeight"),a("Term Proximity Weight","Boost files where terms appear close together","reRankProximityWeight"),t.createEl("h3",{text:"Search Behavior"}),new e.Setting(t).setName("Maximum Results").setDesc("Maximum number of search results to return").addSlider(e=>e.setLimits(5,50,5).setValue(n.hybridSearch.maxResults).setDynamicTooltip().onChange(async e=>{n.hybridSearch.maxResults=e,await s.saveSettings()})),new e.Setting(t).setName("Minimum Score Threshold").setDesc("Exclude results below this score (0-1)").addSlider(e=>e.setLimits(0,.5,.05).setValue(n.hybridSearch.minScoreThreshold).setDynamicTooltip().onChange(async e=>{n.hybridSearch.minScoreThreshold=e,await s.saveSettings()})),new e.Setting(t).setName("Show Match Reasons").setDesc("Display explanations for why results matched").addToggle(e=>e.setValue(n.hybridSearch.showMatchReasons).onChange(async e=>{n.hybridSearch.showMatchReasons=e,await s.saveSettings()})),t.createEl("h3",{text:"Result Clustering"}),new e.Setting(t).setName("Enable Result Clustering").setDesc("Group similar notes together in search results").addToggle(e=>e.setValue(n.hybridSearch.enableClustering).onChange(async e=>{n.hybridSearch.enableClustering=e,await s.saveSettings()})),new e.Setting(t).setName("Cluster Similarity Threshold").setDesc("How similar notes must be to cluster (higher = stricter)").addSlider(e=>e.setLimits(.7,.95,.05).setValue(n.hybridSearch.clusterSimilarityThreshold).setDynamicTooltip().onChange(async e=>{n.hybridSearch.clusterSimilarityThreshold=e,await s.saveSettings()}))}}class P{constructor(){this.id="quick-link",this.title="Quick Link",this.icon="link"}display(t,i,s){const{settings:n}=s;new e.Setting(t).setName("Quick Link Enabled").setDesc("Enable quick link creation from selected text").addToggle(e=>e.setValue(n.quickLink.enabled).onChange(async e=>{n.quickLink.enabled=e,await s.saveSettings()})),new e.Setting(t).setName("Auto Close Quick Link Modal").setDesc("Automatically close quick link modal after opening").addToggle(e=>e.setValue(n.quickLink.autoCloseModal).onChange(async e=>{n.quickLink.autoCloseModal=e,await s.saveSettings()}));const a=n.semanticSearch.enableSemanticSearch,r=n.hybridSearch.enabled;new e.Setting(t).setName("Search Engine").setDesc("Choose which search engine to use for finding files in Quick Link").addDropdown(t=>{t.addOption("enhanced","Enhanced (Keyword)"),t.addOption("semantic",a?"Semantic (AI)":"Semantic (AI) - Enable in settings"),t.addOption("hybrid",r?"Hybrid (Combined)":"Hybrid (Combined) - Enable in settings"),t.setValue(n.quickLink.searchEngine),t.onChange(async i=>"semantic"!==i||a?"hybrid"!==i||r?(n.quickLink.searchEngine=i,void await s.saveSettings()):(new e.Notice("Please enable Hybrid Search in settings first"),void t.setValue(n.quickLink.searchEngine)):(new e.Notice("Please enable Semantic Search in settings first"),void t.setValue(n.quickLink.searchEngine)))})}}class A extends e.SuggestModal{constructor(e,t){super(e),this.onChoose=t}getSuggestions(e){return this.app.commands.listCommands().filter(t=>t.name.toLowerCase().includes(e.toLowerCase()))}renderSuggestion(e,t){t.createEl("div",{text:e.name})}onChooseSuggestion(e,t){this.onChoose(e)}}class W{constructor(){this.id="macros",this.title="Macros",this.icon="terminal-square"}display(t,i,s){const{settings:n}=s;if(0===n.macros.length){t.createEl("div",{cls:"settings-empty"}).createEl("p",{text:"No macros created yet. Macros allow you to chain multiple commands together."})}new e.Setting(t).setName("Create New Macro").setDesc("Add a new command sequence macro").addButton(e=>e.setButtonText("+ Add Macro").setCta().onClick(async()=>{await this.createNewMacro(s,()=>this.display(t,i,s))})),n.macros.forEach((a,r)=>{const c=t.createEl("div",{cls:"macro-container"});new e.Setting(c).setName(`${a.name}`).setDesc(`${a.commandIds.length} commands â€¢ ${a.delay}ms delay`).addButton(e=>e.setButtonText("Delete").setWarning().onClick(async()=>{n.macros.splice(r,1),await s.saveSettings(),this.display(t,i,s)}));const o=c.createEl("div",{cls:"macro-details"});if(new e.Setting(o).setName("Macro Name").addText(e=>e.setValue(a.name).onChange(async e=>{e.trim()&&(n.macros[r].name=e,await s.saveSettings())})),new e.Setting(o).setName("Delay Between Commands (ms)").addSlider(e=>e.setLimits(0,1e3,50).setValue(a.delay).setDynamicTooltip().onChange(async e=>{n.macros[r].delay=e,await s.saveSettings()})),a.commandIds.length>0){const c=o.createEl("div",{cls:"macro-commands"});c.createEl("h4",{text:"Commands:",cls:"macro-commands-title"}),a.commandIds.forEach((a,o)=>{const h=i.commands.findCommand(a),d=c.createEl("div",{cls:"macro-command-item"});d.createEl("span",{text:`${o+1}. ${h?.name||"Unknown Command"}`,cls:"macro-command-name"});const l=d.createEl("button",{cls:"macro-command-remove"});e.setIcon(l,"trash"),l.addEventListener("click",async()=>{n.macros[r].commandIds.splice(o,1),await s.saveSettings(),this.display(t,i,s)})})}new e.Setting(o).setName("Add Command").addButton(e=>e.setButtonText("+ Add Command").onClick(async()=>{new A(i,async e=>{n.macros[r].commandIds.push(e.id),await s.saveSettings(),this.display(t,i,s)}).open()}))})}async createNewMacro(e,t){e.settings.macros.push({name:`Macro ${e.settings.macros.length+1}`,commandIds:[],delay:100}),await e.saveSettings(),t()}}class Z{constructor(){this.id="danger-zone",this.title="Danger Zone",this.icon="alert-triangle"}display(t,i,s){const{settings:n}=s;new e.Setting(t).setName("Excluded File Types").setDesc("Comma-separated list of file extensions to exclude from search").addText(e=>e.setPlaceholder("pdf,jpg,png").setValue(n.fileTypeExclusion.join(",")).onChange(async e=>{const t=e.split(",").map(e=>e.trim().toLowerCase()).filter(e=>e.length>0);n.fileTypeExclusion=t,await s.saveSettings()})),t.createEl("h3",{text:"Hidden Items"});const a=(i,s)=>{new e.Setting(t).setName(`Hidden ${i}`).setDesc(`${s.length} ${i.toLowerCase()} currently hidden`).addButton(t=>t.setButtonText(`Manage ${i}`).onClick(()=>{new e.Notice(`Hidden ${i} management coming soon`)}))};a("Commands",n.hiddenCommands),a("Files",n.hiddenFiles),a("Tags",n.hiddenTags),t.createEl("h3",{text:"Reset"}),new e.Setting(t).setName("Reset All Settings").setDesc("Reset all plugin settings to default values").addButton(t=>t.setButtonText("Reset All").setWarning().onClick(async()=>{confirm("Are you sure you want to reset all settings?")&&(s.settings={...L},await s.saveSettings(),new e.Notice("All settings reset to defaults."))}))}}class V{constructor(t,i){this.id=i.title.toLowerCase().replace(/\s+/g,"-"),this.isCollapsed=i.defaultCollapsed??!0,this.containerEl=t.createDiv({cls:"bcp-collapsible-group"}),this.headerEl=this.containerEl.createDiv({cls:"bcp-collapsible-header"});const s=this.headerEl.createDiv({cls:"bcp-collapsible-title-group"});if(i.icon){const t=s.createSpan({cls:"bcp-collapsible-icon"});e.setIcon(t,i.icon)}s.createSpan({cls:"bcp-collapsible-title",text:i.title}),this.chevronEl=this.headerEl.createSpan({cls:"bcp-collapsible-chevron"}),this.updateChevron(),this.contentEl=this.containerEl.createDiv({cls:"bcp-collapsible-content"}),this.updateContentVisibility(),this.group=new e.SettingGroup(this.contentEl),this.headerEl.addEventListener("click",()=>this.toggle())}updateChevron(){e.setIcon(this.chevronEl,this.isCollapsed?"chevron-right":"chevron-down")}updateContentVisibility(){this.contentEl.style.display=this.isCollapsed?"none":"block"}toggle(){return this.isCollapsed=!this.isCollapsed,this.updateChevron(),this.updateContentVisibility(),this}expand(){return this.isCollapsed&&(this.isCollapsed=!1,this.updateChevron(),this.updateContentVisibility()),this}collapse(){return this.isCollapsed||(this.isCollapsed=!0,this.updateChevron(),this.updateContentVisibility()),this}get collapsed(){return this.isCollapsed}get element(){return this.containerEl}get header(){return this.headerEl}get content(){return this.contentEl}setSubheading(e){return this.group.setHeading(e),this}addClass(e){return this.group.addClass(e),this}addSetting(e){return this.group.addSetting(e),this}addSearch(e){return this.group.addSearch(e),this}addExtraButton(e){return this.group.addExtraButton(e),this}addSubheading(t){return new e.Setting(this.contentEl).setName(t).setHeading(),this}}class N extends e.PluginSettingTab{constructor(e,t){super(e,t),this.tabs=[],this.searchInput=null,this.groups=new Map,this.plugin=t,this.initializeTabs()}initializeTabs(){this.tabs=[new R,new $,new z,new D,new P,new W,new Z]}display(){const{containerEl:t}=this;t.empty(),t.addClass("bcp-settings-container");const i=t.createDiv({cls:"bcp-settings-header-container"});new e.Setting(i).setName("Better Command Palette").setDesc("Configure search, appearance, and advanced features").addSearch(t=>{t.setPlaceholder("Search settings...").onChange(e.debounce(e=>{this.searchSettings(e)},300)),this.searchInput=t.inputEl});const s=i.createDiv({cls:"bcp-settings-global-controls"}),n=s.createSpan({cls:"bcp-control-link"});n.setText("Expand all"),n.onclick=()=>this.toggleAllSections(!0);const a=s.createSpan({cls:"bcp-control-link"});a.setText("Collapse all"),a.onclick=()=>this.toggleAllSections(!1),this.groups.clear();const r=t.createDiv({cls:"bcp-settings-content"});this.tabs.forEach(e=>{this.renderSection(r,e)})}renderSection(e,t){const i=new V(e,{title:t.title,icon:t.icon,defaultCollapsed:!0});t.display(i.content,this.app,this.plugin),this.groups.set(t.id,i)}toggleAllSections(e){this.groups.forEach(t=>{e?t.expand():t.collapse()})}searchSettings(e){const t=e.toLowerCase().trim();t?this.groups.forEach((e,i)=>{const s=e.content;let n=!1;const a=s.querySelectorAll(".setting-item");a.forEach(e=>{const i=e,s=i.querySelector(".setting-item-name")?.textContent?.toLowerCase()||"",a=i.querySelector(".setting-item-description")?.textContent?.toLowerCase()||"";s.includes(t)||a.includes(t)?(i.style.display="flex",n=!0):i.style.display="none"});(e.header.textContent?.toLowerCase()||"").includes(t)&&(n=!0,a.forEach(e=>e.style.display="flex")),n?(e.element.style.display="block",e.expand()):e.element.style.display="none"}):this.groups.forEach(e=>{e.element.style.display="block";e.content.querySelectorAll(".setting-item").forEach(e=>e.style.display="flex")})}}const H="KEYS",X="VALUES",G="";class O{constructor(e,t){const i=e._tree,s=Array.from(i.keys());this.set=e,this._type=t,this._path=s.length>0?[{node:i,keys:s}]:[]}next(){const e=this.dive();return this.backtrack(),e}dive(){if(0===this._path.length)return{done:!0,value:void 0};const{node:e,keys:t}=U(this._path);if(U(t)===G)return{done:!1,value:this.result()};const i=e.get(U(t));return this._path.push({node:i,keys:Array.from(i.keys())}),this.dive()}backtrack(){if(0===this._path.length)return;const e=U(this._path).keys;e.pop(),e.length>0||(this._path.pop(),this.backtrack())}key(){return this.set._prefix+this._path.map(({keys:e})=>U(e)).filter(e=>e!==G).join("")}value(){return U(this._path).node.get(G)}result(){switch(this._type){case X:return this.value();case H:return this.key();default:return[this.key(),this.value()]}}[Symbol.iterator](){return this}}const U=e=>e[e.length-1],K=(e,t,i,s,n,a,r,c)=>{const o=a*r;e:for(const h of e.keys())if(h===G){const t=n[o-1];t<=i&&s.set(c,[e.get(h),t])}else{let o=a;for(let e=0;e<h.length;++e,++o){const s=h[e],a=r*o,c=a-r;let d=n[a];const l=Math.max(0,o-i-1),u=Math.min(r-1,o+i);for(let e=l;e<u;++e){const i=s!==t[e],r=n[c+e]+ +i,o=n[c+e+1]+1,h=n[a+e]+1,l=n[a+e+1]=Math.min(r,o,h);l<d&&(d=l)}if(d>i)continue e}K(e.get(h),t,i,s,n,o,r,c+h)}};class _{constructor(e=new Map,t=""){this._size=void 0,this._tree=e,this._prefix=t}atPrefix(e){if(!e.startsWith(this._prefix))throw new Error("Mismatched prefix");const[t,i]=B(this._tree,e.slice(this._prefix.length));if(void 0===t){const[t,s]=ee(i);for(const i of t.keys())if(i!==G&&i.startsWith(s)){const n=new Map;return n.set(i.slice(s.length),t.get(i)),new _(n,e)}}return new _(t,e)}clear(){this._size=void 0,this._tree.clear()}delete(e){return this._size=void 0,q(this._tree,e)}entries(){return new O(this,"ENTRIES")}forEach(e){for(const[t,i]of this)e(t,i,this)}fuzzyGet(e,t){return((e,t,i)=>{const s=new Map;if(void 0===t)return s;const n=t.length+1,a=n+i,r=new Uint8Array(a*n).fill(i+1);for(let e=0;e<n;++e)r[e]=e;for(let e=1;e<a;++e)r[e*n]=e;return K(e,t,i,s,r,1,n,""),s})(this._tree,e,t)}get(e){const t=Y(this._tree,e);return void 0!==t?t.get(G):void 0}has(e){const t=Y(this._tree,e);return void 0!==t&&t.has(G)}keys(){return new O(this,H)}set(e,t){if("string"!=typeof e)throw new Error("key must be a string");this._size=void 0;return j(this._tree,e).set(G,t),this}get size(){if(this._size)return this._size;this._size=0;const e=this.entries();for(;!e.next().done;)this._size+=1;return this._size}update(e,t){if("string"!=typeof e)throw new Error("key must be a string");this._size=void 0;const i=j(this._tree,e);return i.set(G,t(i.get(G))),this}fetch(e,t){if("string"!=typeof e)throw new Error("key must be a string");this._size=void 0;const i=j(this._tree,e);let s=i.get(G);return void 0===s&&i.set(G,s=t()),s}values(){return new O(this,X)}[Symbol.iterator](){return this.entries()}static from(e){const t=new _;for(const[i,s]of e)t.set(i,s);return t}static fromObject(e){return _.from(Object.entries(e))}}const B=(e,t,i=[])=>{if(0===t.length||null==e)return[e,i];for(const s of e.keys())if(s!==G&&t.startsWith(s))return i.push([e,s]),B(e.get(s),t.slice(s.length),i);return i.push([e,t]),B(void 0,"",i)},Y=(e,t)=>{if(0===t.length||null==e)return e;for(const i of e.keys())if(i!==G&&t.startsWith(i))return Y(e.get(i),t.slice(i.length))},j=(e,t)=>{const i=t.length;e:for(let s=0;e&&s<i;){for(const n of e.keys())if(n!==G&&t[s]===n[0]){const a=Math.min(i-s,n.length);let r=1;for(;r<a&&t[s+r]===n[r];)++r;const c=e.get(n);if(r===n.length)e=c;else{const i=new Map;i.set(n.slice(r),c),e.set(t.slice(s,s+r),i),e.delete(n),e=i}s+=r;continue e}const n=new Map;return e.set(t.slice(s),n),n}return e},q=(e,t)=>{const[i,s]=B(e,t);if(void 0!==i)if(i.delete(G),0===i.size)J(s);else if(1===i.size){const[e,t]=i.entries().next().value;Q(s,e,t)}},J=e=>{if(0===e.length)return;const[t,i]=ee(e);if(t.delete(i),0===t.size)J(e.slice(0,-1));else if(1===t.size){const[i,s]=t.entries().next().value;i!==G&&Q(e.slice(0,-1),i,s)}},Q=(e,t,i)=>{if(0===e.length)return;const[s,n]=ee(e);s.set(n+t,i),s.delete(n)},ee=e=>e[e.length-1],te="or",ie="and",se="and_not";class ne{constructor(e){if(null==(null==e?void 0:e.fields))throw new Error('MiniSearch: option "fields" must be provided');const t=null==e.autoVacuum||!0===e.autoVacuum?me:e.autoVacuum;this._options={...he,...e,autoVacuum:t,searchOptions:{...de,...e.searchOptions||{}},autoSuggestOptions:{...le,...e.autoSuggestOptions||{}}},this._index=new _,this._documentCount=0,this._documentIds=new Map,this._idToShortId=new Map,this._fieldIds={},this._fieldLength=new Map,this._avgFieldLength=[],this._nextId=0,this._storedFields=new Map,this._dirtCount=0,this._currentVacuum=null,this._enqueuedVacuum=null,this._enqueuedVacuumConditions=ge,this.addFields(this._options.fields)}add(e){const{extractField:t,stringifyField:i,tokenize:s,processTerm:n,fields:a,idField:r}=this._options,c=t(e,r);if(null==c)throw new Error(`MiniSearch: document does not have ID field "${r}"`);if(this._idToShortId.has(c))throw new Error(`MiniSearch: duplicate ID ${c}`);const o=this.addDocumentId(c);this.saveStoredFields(o,e);for(const r of a){const a=t(e,r);if(null==a)continue;const c=s(i(a,r),r),h=this._fieldIds[r],d=new Set(c).size;this.addFieldLength(o,h,this._documentCount-1,d);for(const e of c){const t=n(e,r);if(Array.isArray(t))for(const e of t)this.addTerm(h,o,e);else t&&this.addTerm(h,o,t)}}}addAll(e){for(const t of e)this.add(t)}addAllAsync(e,t={}){const{chunkSize:i=10}=t,s={chunk:[],promise:Promise.resolve()},{chunk:n,promise:a}=e.reduce(({chunk:e,promise:t},s,n)=>(e.push(s),(n+1)%i===0?{chunk:[],promise:t.then(()=>new Promise(e=>setTimeout(e,0))).then(()=>this.addAll(e))}:{chunk:e,promise:t}),s);return a.then(()=>this.addAll(n))}remove(e){const{tokenize:t,processTerm:i,extractField:s,stringifyField:n,fields:a,idField:r}=this._options,c=s(e,r);if(null==c)throw new Error(`MiniSearch: document does not have ID field "${r}"`);const o=this._idToShortId.get(c);if(null==o)throw new Error(`MiniSearch: cannot remove document with ID ${c}: it is not in the index`);for(const r of a){const a=s(e,r);if(null==a)continue;const c=t(n(a,r),r),h=this._fieldIds[r],d=new Set(c).size;this.removeFieldLength(o,h,this._documentCount,d);for(const e of c){const t=i(e,r);if(Array.isArray(t))for(const e of t)this.removeTerm(h,o,e);else t&&this.removeTerm(h,o,t)}}this._storedFields.delete(o),this._documentIds.delete(o),this._idToShortId.delete(c),this._fieldLength.delete(o),this._documentCount-=1}removeAll(e){if(e)for(const t of e)this.remove(t);else{if(arguments.length>0)throw new Error("Expected documents to be present. Omit the argument to remove all documents.");this._index=new _,this._documentCount=0,this._documentIds=new Map,this._idToShortId=new Map,this._fieldLength=new Map,this._avgFieldLength=[],this._storedFields=new Map,this._nextId=0}}discard(e){const t=this._idToShortId.get(e);if(null==t)throw new Error(`MiniSearch: cannot discard document with ID ${e}: it is not in the index`);this._idToShortId.delete(e),this._documentIds.delete(t),this._storedFields.delete(t),(this._fieldLength.get(t)||[]).forEach((e,i)=>{this.removeFieldLength(t,i,this._documentCount,e)}),this._fieldLength.delete(t),this._documentCount-=1,this._dirtCount+=1,this.maybeAutoVacuum()}maybeAutoVacuum(){if(!1===this._options.autoVacuum)return;const{minDirtFactor:e,minDirtCount:t,batchSize:i,batchWait:s}=this._options.autoVacuum;this.conditionalVacuum({batchSize:i,batchWait:s},{minDirtCount:t,minDirtFactor:e})}discardAll(e){const t=this._options.autoVacuum;try{this._options.autoVacuum=!1;for(const t of e)this.discard(t)}finally{this._options.autoVacuum=t}this.maybeAutoVacuum()}replace(e){const{idField:t,extractField:i}=this._options,s=i(e,t);this.discard(s),this.add(e)}vacuum(e={}){return this.conditionalVacuum(e)}conditionalVacuum(e,t){return this._currentVacuum?(this._enqueuedVacuumConditions=this._enqueuedVacuumConditions&&t,null!=this._enqueuedVacuum||(this._enqueuedVacuum=this._currentVacuum.then(()=>{const t=this._enqueuedVacuumConditions;return this._enqueuedVacuumConditions=ge,this.performVacuuming(e,t)})),this._enqueuedVacuum):!1===this.vacuumConditionsMet(t)?Promise.resolve():(this._currentVacuum=this.performVacuuming(e),this._currentVacuum)}async performVacuuming(e,t){const i=this._dirtCount;if(this.vacuumConditionsMet(t)){const t=e.batchSize||ue.batchSize,s=e.batchWait||ue.batchWait;let n=1;for(const[e,i]of this._index){for(const[e,t]of i)for(const[s]of t)this._documentIds.has(s)||(t.size<=1?i.delete(e):t.delete(s));0===this._index.get(e).size&&this._index.delete(e),n%t===0&&await new Promise(e=>setTimeout(e,s)),n+=1}this._dirtCount-=i}await null,this._currentVacuum=this._enqueuedVacuum,this._enqueuedVacuum=null}vacuumConditionsMet(e){if(null==e)return!0;let{minDirtCount:t,minDirtFactor:i}=e;return t=t||me.minDirtCount,i=i||me.minDirtFactor,this.dirtCount>=t&&this.dirtFactor>=i}get isVacuuming(){return null!=this._currentVacuum}get dirtCount(){return this._dirtCount}get dirtFactor(){return this._dirtCount/(1+this._documentCount+this._dirtCount)}has(e){return this._idToShortId.has(e)}getStoredFields(e){const t=this._idToShortId.get(e);if(null!=t)return this._storedFields.get(t)}search(e,t={}){const{searchOptions:i}=this._options,s={...i,...t},n=this.executeQuery(e,t),a=[];for(const[e,{score:t,terms:i,match:r}]of n){const n=i.length||1,c={id:this._documentIds.get(e),score:t*n,terms:Object.keys(r),queryTerms:i,match:r};Object.assign(c,this._storedFields.get(e)),(null==s.filter||s.filter(c))&&a.push(c)}return e===ne.wildcard&&null==s.boostDocument||a.sort(fe),a}autoSuggest(e,t={}){t={...this._options.autoSuggestOptions,...t};const i=new Map;for(const{score:s,terms:n}of this.search(e,t)){const e=n.join(" "),t=i.get(e);null!=t?(t.score+=s,t.count+=1):i.set(e,{score:s,terms:n,count:1})}const s=[];for(const[e,{score:t,terms:n,count:a}]of i)s.push({suggestion:e,terms:n,score:t/a});return s.sort(fe),s}get documentCount(){return this._documentCount}get termCount(){return this._index.size}static loadJSON(e,t){if(null==t)throw new Error("MiniSearch: loadJSON should be given the same options used when serializing the index");return this.loadJS(JSON.parse(e),t)}static async loadJSONAsync(e,t){if(null==t)throw new Error("MiniSearch: loadJSON should be given the same options used when serializing the index");return this.loadJSAsync(JSON.parse(e),t)}static getDefault(e){if(he.hasOwnProperty(e))return ae(he,e);throw new Error(`MiniSearch: unknown option "${e}"`)}static loadJS(e,t){const{index:i,documentIds:s,fieldLength:n,storedFields:a,serializationVersion:r}=e,c=this.instantiateMiniSearch(e,t);c._documentIds=be(s),c._fieldLength=be(n),c._storedFields=be(a);for(const[e,t]of c._documentIds)c._idToShortId.set(t,e);for(const[e,t]of i){const i=new Map;for(const e of Object.keys(t)){let s=t[e];1===r&&(s=s.ds),i.set(parseInt(e,10),be(s))}c._index.set(e,i)}return c}static async loadJSAsync(e,t){const{index:i,documentIds:s,fieldLength:n,storedFields:a,serializationVersion:r}=e,c=this.instantiateMiniSearch(e,t);c._documentIds=await xe(s),c._fieldLength=await xe(n),c._storedFields=await xe(a);for(const[e,t]of c._documentIds)c._idToShortId.set(t,e);let o=0;for(const[e,t]of i){const i=new Map;for(const e of Object.keys(t)){let s=t[e];1===r&&(s=s.ds),i.set(parseInt(e,10),await xe(s))}++o%1e3==0&&await we(0),c._index.set(e,i)}return c}static instantiateMiniSearch(e,t){const{documentCount:i,nextId:s,fieldIds:n,averageFieldLength:a,dirtCount:r,serializationVersion:c}=e;if(1!==c&&2!==c)throw new Error("MiniSearch: cannot deserialize an index created with an incompatible version");const o=new ne(t);return o._documentCount=i,o._nextId=s,o._idToShortId=new Map,o._fieldIds=n,o._avgFieldLength=a,o._dirtCount=r||0,o._index=new _,o}executeQuery(e,t={}){if(e===ne.wildcard)return this.executeWildcardQuery(t);if("string"!=typeof e){const i={...t,...e,queries:void 0},s=e.queries.map(e=>this.executeQuery(e,i));return this.combineResults(s,i.combineWith)}const{tokenize:i,processTerm:s,searchOptions:n}=this._options,a={tokenize:i,processTerm:s,...n,...t},{tokenize:r,processTerm:c}=a,o=r(e).flatMap(e=>c(e)).filter(e=>!!e).map(oe(a)).map(e=>this.executeQuerySpec(e,a));return this.combineResults(o,a.combineWith)}executeQuerySpec(e,t){const i={...this._options.searchOptions,...t},s=(i.fields||this._options.fields).reduce((e,t)=>({...e,[t]:ae(i.boost,t)||1}),{}),{boostDocument:n,weights:a,maxFuzzy:r,bm25:c}=i,{fuzzy:o,prefix:h}={...de.weights,...a},d=this._index.get(e.term),l=this.termResults(e.term,e.term,1,e.termBoost,d,s,n,c);let u,g;if(e.prefix&&(u=this._index.atPrefix(e.term)),e.fuzzy){const t=!0===e.fuzzy?.2:e.fuzzy,i=t<1?Math.min(r,Math.round(e.term.length*t)):t;i&&(g=this._index.fuzzyGet(e.term,i))}if(u)for(const[t,i]of u){const a=t.length-e.term.length;if(!a)continue;null==g||g.delete(t);const r=h*t.length/(t.length+.3*a);this.termResults(e.term,t,r,e.termBoost,i,s,n,c,l)}if(g)for(const t of g.keys()){const[i,a]=g.get(t);if(!a)continue;const r=o*t.length/(t.length+a);this.termResults(e.term,t,r,e.termBoost,i,s,n,c,l)}return l}executeWildcardQuery(e){const t=new Map,i={...this._options.searchOptions,...e};for(const[e,s]of this._documentIds){const n=i.boostDocument?i.boostDocument(s,"",this._storedFields.get(e)):1;t.set(e,{score:n,terms:[],match:{}})}return t}combineResults(e,t=te){if(0===e.length)return new Map;const i=t.toLowerCase(),s=re[i];if(!s)throw new Error(`Invalid combination operator: ${t}`);return e.reduce(s)||new Map}toJSON(){const e=[];for(const[t,i]of this._index){const s={};for(const[e,t]of i)s[e]=Object.fromEntries(t);e.push([t,s])}return{documentCount:this._documentCount,nextId:this._nextId,documentIds:Object.fromEntries(this._documentIds),fieldIds:this._fieldIds,fieldLength:Object.fromEntries(this._fieldLength),averageFieldLength:this._avgFieldLength,storedFields:Object.fromEntries(this._storedFields),dirtCount:this._dirtCount,index:e,serializationVersion:2}}termResults(e,t,i,s,n,a,r,c,o=new Map){if(null==n)return o;for(const h of Object.keys(a)){const d=a[h],l=this._fieldIds[h],u=n.get(l);if(null==u)continue;let g=u.size;const m=this._avgFieldLength[l];for(const n of u.keys()){if(!this._documentIds.has(n)){this.removeTerm(l,n,t),g-=1;continue}const a=r?r(this._documentIds.get(n),t,this._storedFields.get(n)):1;if(!a)continue;const p=u.get(n),S=this._fieldLength.get(n)[l],f=i*s*d*a*ce(p,g,this._documentCount,S,m,c),y=o.get(n);if(y){y.score+=f,pe(y.terms,e);const i=ae(y.match,t);i?i.push(h):y.match[t]=[h]}else o.set(n,{score:f,terms:[e],match:{[t]:[h]}})}}return o}addTerm(e,t,i){const s=this._index.fetch(i,ye);let n=s.get(e);if(null==n)n=new Map,n.set(t,1),s.set(e,n);else{const e=n.get(t);n.set(t,(e||0)+1)}}removeTerm(e,t,i){if(!this._index.has(i))return void this.warnDocumentChanged(t,e,i);const s=this._index.fetch(i,ye),n=s.get(e);null==n||null==n.get(t)?this.warnDocumentChanged(t,e,i):n.get(t)<=1?n.size<=1?s.delete(e):n.delete(t):n.set(t,n.get(t)-1),0===this._index.get(i).size&&this._index.delete(i)}warnDocumentChanged(e,t,i){for(const s of Object.keys(this._fieldIds))if(this._fieldIds[s]===t)return void this._options.logger("warn",`MiniSearch: document with ID ${this._documentIds.get(e)} has changed before removal: term "${i}" was not present in field "${s}". Removing a document after it has changed can corrupt the index!`,"version_conflict")}addDocumentId(e){const t=this._nextId;return this._idToShortId.set(e,t),this._documentIds.set(t,e),this._documentCount+=1,this._nextId+=1,t}addFields(e){for(let t=0;t<e.length;t++)this._fieldIds[e[t]]=t}addFieldLength(e,t,i,s){let n=this._fieldLength.get(e);null==n&&this._fieldLength.set(e,n=[]),n[t]=s;const a=(this._avgFieldLength[t]||0)*i+s;this._avgFieldLength[t]=a/(i+1)}removeFieldLength(e,t,i,s){if(1===i)return void(this._avgFieldLength[t]=0);const n=this._avgFieldLength[t]*i-s;this._avgFieldLength[t]=n/(i-1)}saveStoredFields(e,t){const{storeFields:i,extractField:s}=this._options;if(null==i||0===i.length)return;let n=this._storedFields.get(e);null==n&&this._storedFields.set(e,n={});for(const e of i){const i=s(t,e);void 0!==i&&(n[e]=i)}}}ne.wildcard=Symbol("*");const ae=(e,t)=>Object.prototype.hasOwnProperty.call(e,t)?e[t]:void 0,re={[te]:(e,t)=>{for(const i of t.keys()){const s=e.get(i);if(null==s)e.set(i,t.get(i));else{const{score:e,terms:n,match:a}=t.get(i);s.score=s.score+e,s.match=Object.assign(s.match,a),Se(s.terms,n)}}return e},[ie]:(e,t)=>{const i=new Map;for(const s of t.keys()){const n=e.get(s);if(null==n)continue;const{score:a,terms:r,match:c}=t.get(s);Se(n.terms,r),i.set(s,{score:n.score+a,terms:n.terms,match:Object.assign(n.match,c)})}return i},[se]:(e,t)=>{for(const i of t.keys())e.delete(i);return e}},ce=(e,t,i,s,n,a)=>{const{k:r,b:c,d:o}=a;return Math.log(1+(i-t+.5)/(t+.5))*(o+e*(r+1)/(e+r*(1-c+c*s/n)))},oe=e=>(t,i,s)=>({term:t,fuzzy:"function"==typeof e.fuzzy?e.fuzzy(t,i,s):e.fuzzy||!1,prefix:"function"==typeof e.prefix?e.prefix(t,i,s):!0===e.prefix,termBoost:"function"==typeof e.boostTerm?e.boostTerm(t,i,s):1}),he={idField:"id",extractField:(e,t)=>e[t],stringifyField:(e,t)=>e.toString(),tokenize:e=>e.split(ve),processTerm:e=>e.toLowerCase(),fields:void 0,searchOptions:void 0,storeFields:[],logger:(e,t)=>{"function"==typeof(null===console||void 0===console?void 0:console[e])&&console[e](t)},autoVacuum:!0},de={combineWith:te,prefix:!1,fuzzy:!1,maxFuzzy:6,boost:{},weights:{fuzzy:.45,prefix:.375},bm25:{k:1.2,b:.7,d:.5}},le={combineWith:"and",prefix:(e,t,i)=>t===i.length-1},ue={batchSize:1e3,batchWait:10},ge={minDirtFactor:.1,minDirtCount:20},me={...ue,...ge},pe=(e,t)=>{e.includes(t)||e.push(t)},Se=(e,t)=>{for(const i of t)e.includes(i)||e.push(i)},fe=({score:e},{score:t})=>t-e,ye=()=>new Map,be=e=>{const t=new Map;for(const i of Object.keys(e))t.set(parseInt(i,10),e[i]);return t},xe=async e=>{const t=new Map;let i=0;for(const s of Object.keys(e))t.set(parseInt(s,10),e[s]),++i%1e3==0&&await we(0);return t},we=e=>new Promise(t=>setTimeout(t,e)),ve=/[\n\r\p{Z}\p{P}]+/u;class ke{constructor(e={}){this.synonymMap=new Map,this.documents=new Map,this.documentCount=0,this.lastUpdated=Date.now(),this.termFrequencyIndex=null,this.options={typoTolerance:1,foldAccents:!0,enableStemming:!1,synonyms:[],...e},this.indexOptions={fields:["content","title","headings","tags","aliases"],storeFields:["title","path"],idField:"id",tokenize:(e,t)=>this.tokenizeText(e),processTerm:(e,t)=>this.processTerm(e)},this.synonymMap=this.buildSynonymMap(this.options.synonyms),this.searchOptions=this.buildSearchOptions(),this.index=new ne(this.indexOptions)}updateOptions(e){this.options={...this.options,...e},this.synonymMap=this.buildSynonymMap(this.options.synonyms),this.searchOptions=this.buildSearchOptions()}setTermFrequencyIndex(e){this.termFrequencyIndex=e}getTermFrequencyIndex(){return this.termFrequencyIndex}async addDocument(e,t,i){try{const s=this.createSearchDocument(e,t,i);if(this.index.has(e)?this.index.replace(s):(this.index.add(s),this.documentCount++),this.documents.set(e,i),this.lastUpdated=Date.now(),this.termFrequencyIndex){const i=this.tokenizeText(t);this.termFrequencyIndex.addDocument(e,i);const s=this.termFrequencyIndex.getStats();1===s.totalDocuments?S.debug(`[TFI] First document indexed: ${e} (${i.length} terms extracted)`):s.totalDocuments%100==0&&S.debug(`[TFI] Progress: ${s.totalDocuments} docs, ${s.uniqueTerms} unique terms`)}}catch(t){throw S.error(`Failed to add document ${e} to search index:`,t),t}}async removeDocument(e){try{this.index.has(e)&&(this.index.remove({id:e}),this.documentCount--),this.documents.delete(e),this.lastUpdated=Date.now(),this.termFrequencyIndex&&this.termFrequencyIndex.removeDocument(e)}catch(t){throw S.error(`Failed to remove document ${e} from search index:`,t),t}}async updateDocument(e,t,i){await this.addDocument(e,t,i)}async search(e,t=50){try{if(!e.trim())return[];return this.index.search(e,{limit:Math.min(t,200),...this.searchOptions}).map(t=>({id:t.id,score:t.score,matches:t.match||{},metadata:this.documents.get(t.id),snippet:this.generateSnippet(t.id,e,t.match)}))}catch(e){return S.error("Search failed:",e),[]}}getStats(){return{documentCount:this.documentCount,indexSize:this.calculateIndexSize(),lastUpdated:this.lastUpdated,version:"1.1.0"}}async clear(){this.index=new ne(this.indexOptions),this.documents.clear(),this.documentCount=0,this.lastUpdated=Date.now(),this.termFrequencyIndex&&(this.termFrequencyIndex.clear(),S.debug("[MiniSearchAdapter] Cleared index and TermFrequencyIndex - will rebuild"))}hasDocument(e){return this.index.has(e)}has(e){return this.index.has(e)}createSearchDocument(e,t,i){return{id:e,content:this.truncateContent(t,2e3),title:i.title||this.extractTitle(t)||"",headings:this.extractHeadings(t).join(" "),tags:(i.tags||[]).join(" "),aliases:this.normalizeAliasesArray(i.aliases).join(" "),path:i.path}}tokenizeText(e){if(!e)return[];return e.replace(/[#*_`\[\]()]/g," ").replace(/\bhttps?:\/\/\S+/g," ").replace(/\s+/g," ").trim().split(/[^\p{L}\p{N}'-]+/u).map(e=>this.normalizeTerm(e)).filter(e=>Boolean(e))}processTerm(e){const t=this.normalizeTerm(e);if(!t)return null;const i=this.synonymMap.get(t);if(!i||0===i.length)return t;const s=new Set([t]);return i.forEach(e=>{const t=this.normalizeTerm(e);t&&s.add(t)}),Array.from(s)}normalizeTerm(e){if(!e)return null;const t=e.toLocaleLowerCase(),i=(this.options.foldAccents?this.removeDiacritics(t):t).replace(/[^\p{L}\p{N}'-]+/gu,"").trim();if(i.length<2)return null;return(this.options.enableStemming?this.stem(i):i)||null}removeDiacritics(e){return e.normalize("NFD").replace(/\p{M}+/gu,"")}stem(e){if(e.length<=3)return e;const t=e.replace(/'s$/u,"");return t.length<=3?t:t.endsWith("es")&&t.length>4?t.slice(0,-2):t.endsWith("s")&&t.length>3?t.slice(0,-1):t}buildSearchOptions(){const e=this.options.typoTolerance>0;return{boost:{title:3,headings:2,aliases:2,tags:1.5,content:1},fuzzy:!!e&&this.options.typoTolerance,prefix:!0,combineWith:"AND",weights:{fuzzy:e?.2:0,prefix:.5}}}buildSynonymMap(e){const t=new Map;return e.forEach(e=>{const[i,s]=e.split("="),n=this.normalizeTerm(i||"");if(!n||!s)return;const a=s.split(",").map(e=>this.normalizeTerm(e||"")).filter(e=>Boolean(e));if(0===a.length)return;const r=Array.from(new Set(a.filter(e=>e!==n)));r.length>0&&(t.set(n,r),r.forEach(e=>{const i=t.get(e)||[];t.set(e,Array.from(new Set([...i,n])))}))}),t}extractTitle(e){const t=e.match(/^#\s+(.+)$/m);if(t)return t[1].trim();const i=e.match(/^---[\s\S]*?title:\s*(.+)$/m);return i?i[1].trim().replace(/['"]/g,""):""}extractHeadings(e){const t=e.match(/^#{1,6}\s+(.+)$/gm);return t?t.map(e=>e.replace(/^#+\s*/,"").trim()):[]}truncateContent(e,t){if(e.length<=t)return e;const i=e.substring(0,t),s=i.lastIndexOf(" ");return s>.8*t?i.substring(0,s):i}generateSnippet(e,t,i){const s=this.documents.get(e);return s&&(s.title||s.path)||""}calculateIndexSize(){return 1024*this.documentCount}async exportIndex(){return{index:this.index.toJSON(),documents:Array.from(this.documents.entries()),stats:this.getStats(),termFrequencyIndex:this.termFrequencyIndex?.serialize()??null}}async serialize(){return this.exportIndex()}async importIndex(e){try{if(this.index=ne.loadJSON(JSON.stringify(e.index),this.indexOptions),this.documents=new Map(e.documents),this.documentCount=e.stats?.documentCount||this.documents.size,this.lastUpdated=e.stats?.lastUpdated||Date.now(),e.termFrequencyIndex&&this.termFrequencyIndex){if(this.termFrequencyIndex.deserialize(e.termFrequencyIndex)){const e=this.termFrequencyIndex.getStats();S.debug(`[TermFrequencyIndex] Loaded from cache: ${e.totalDocuments} docs, ${e.uniqueTerms} terms`)}else S.debug("[TermFrequencyIndex] Failed to deserialize from cache (version mismatch or error)")}else S.debug(`[TermFrequencyIndex] Skipped loading: hasData=${!!e.termFrequencyIndex}, hasIndex=${!!this.termFrequencyIndex}`)}catch(e){throw S.error("Failed to import index:",e),e}}async loadFromData(e){return this.importIndex(e)}normalizeAliasesArray(e){return e?Array.isArray(e)?e.filter(e=>"string"==typeof e):"string"==typeof e?[e]:[]:[]}}class Ce{constructor(){this.termDocCount=new Map,this.docTerms=new Map,this.totalDocuments=0}addDocument(e,t){this.docTerms.has(e)&&this.removeDocument(e);const i=new Set(t.filter(e=>e&&e.length>=2));this.docTerms.set(e,i),this.totalDocuments++;for(const e of i){const t=this.termDocCount.get(e)||0;this.termDocCount.set(e,t+1)}}removeDocument(e){const t=this.docTerms.get(e);if(t){for(const e of t){const t=this.termDocCount.get(e)||0;t<=1?this.termDocCount.delete(e):this.termDocCount.set(e,t-1)}this.docTerms.delete(e),this.totalDocuments=Math.max(0,this.totalDocuments-1)}}getIDF(e){const t=this.termDocCount.get(e)||0,i=Math.log((this.totalDocuments+1)/(t+1));return Math.max(0,i)}getDocumentFrequency(e){return this.termDocCount.get(e)||0}getTermWeights(e){const t=new Map;if(0===e.length)return t;let i=0;for(const s of e){const e=this.getIDF(s);t.set(s,e),i+=e}if(i>0)for(const[e,s]of t)t.set(e,s/i);else{const i=1/e.length;for(const s of e)t.set(s,i)}return t}getStats(){return{totalDocuments:this.totalDocuments,uniqueTerms:this.termDocCount.size}}clear(){this.termDocCount.clear(),this.docTerms.clear(),this.totalDocuments=0}serialize(){return{version:Ce.VERSION,totalDocuments:this.totalDocuments,termDocCount:Array.from(this.termDocCount.entries()),docTerms:Array.from(this.docTerms.entries()).map(([e,t])=>[e,Array.from(t)])}}deserialize(e){try{return e.version!==Ce.VERSION?(S.warn(`[TermFrequencyIndex] Version mismatch: ${e.version} vs ${Ce.VERSION}`),!1):(this.totalDocuments=e.totalDocuments,this.termDocCount=new Map(e.termDocCount),this.docTerms=new Map(e.docTerms.map(([e,t])=>[e,new Set(t)])),S.debug(`[TermFrequencyIndex] Loaded ${this.totalDocuments} docs, ${this.termDocCount.size} unique terms`),!0)}catch(e){return S.error("[TermFrequencyIndex] Failed to deserialize:",e),!1}}logQueryTermWeights(e){const t=this.getTermWeights(e),i=e.map(e=>{const i=this.getDocumentFrequency(e),s=this.getIDF(e),n=t.get(e)||0;return`"${e}": df=${i}, idf=${s.toFixed(2)}, weight=${(100*n).toFixed(1)}%`});S.debug(`[TermFrequencyIndex] Query term weights (N=${this.totalDocuments}):\n  ${i.join("\n  ")}`)}}function Ie(e){return function(e,t=36){let i=0;if(!e||0===e.length)return"0";for(let t=0;t<e.length;t++)i=(i<<5)-i+e.charCodeAt(t),i&=i;return Math.abs(i).toString(t)}(e,36)}Ce.VERSION="1.0.0";class Te{constructor(e,t,i,s,n,a,r=500,c={}){this.pendingUpdates=new Map,this.isInitialized=!1,this.app=e,this.searchIndex=t,this.contentStore=i,this.usageTracker=s,this.persistence=n,this.debounceCallback=a,this.debounceMs=r,this.enableContentSearch=c.enableContentSearch??!0}async initialize(){this.isInitialized||(this.isInitialized=!0)}async indexFile(e,t){this.pendingUpdates.has(e.path)&&clearTimeout(this.pendingUpdates.get(e.path)),this.pendingUpdates.set(e.path,setTimeout(async()=>{try{const i=t||await this.readFileContent(e),s=this.extractMetadata(e,i);if(!await this.shouldReindexFile(e.path,s))return S.debug(`Enhanced search: Skipping reindex of ${e.path} - content unchanged`),void this.pendingUpdates.delete(e.path);S.debug(`Enhanced search: Reindexing ${e.path} due to content changes`),this.enableContentSearch&&await this.contentStore.set(e.path,i),await this.searchIndex.addDocument(e.path,i,s),await this.updateIndexMetadata(e.path,s),this.pendingUpdates.delete(e.path),this.debounceCallback(e.path,"modify")}catch(t){S.error(`Failed to index file ${e.path}:`,t),this.pendingUpdates.delete(e.path)}},this.debounceMs))}async removeFile(e){this.pendingUpdates.has(e)&&(clearTimeout(this.pendingUpdates.get(e)),this.pendingUpdates.delete(e));try{await this.contentStore.delete(e),await this.searchIndex.removeDocument(e)}catch(t){throw S.error(`Failed to remove file ${e}:`,t),t}}async renameFile(e,t){S.debug(`Enhanced search: Handling file rename from ${e} to ${t}`),this.pendingUpdates.has(e)&&(clearTimeout(this.pendingUpdates.get(e)),this.pendingUpdates.delete(e)),this.pendingUpdates.has(t)&&(clearTimeout(this.pendingUpdates.get(t)),this.pendingUpdates.delete(t));try{const i=this.getFileByPath?.(t);if(!i)return S.warn(`Enhanced search: Could not find renamed file at ${t}`),void await this.removeFile(e);await this.contentStore.delete(e),await this.searchIndex.removeDocument(e),await this.indexFile(i),S.debug(`Enhanced search: Successfully renamed file from ${e} to ${t}`)}catch(i){throw S.error(`Enhanced search: Failed to rename file from ${e} to ${t}:`,i),i}}async search(e,t=50){try{const i=await this.searchIndex.search(e,t);return this.enhanceResultsWithUsage(i)}catch(e){return S.error("Search failed:",e),[]}}enhanceResultsWithUsage(e){return e.map(e=>{const t=this.usageTracker.getUsageScore(e.id),i=this.usageTracker.getLastOpened(e.id);return{...e,usageScore:t,lastOpened:i,recencyScore:this.usageTracker.getRecencyScore(e.id)}})}async getStats(){try{return this.searchIndex.getStats()}catch(e){return S.error("Failed to get index stats:",e),{documentCount:0,indexSize:0,lastUpdated:0,version:"unknown"}}}async clearIndex(){this.pendingUpdates.forEach(e=>clearTimeout(e)),this.pendingUpdates.clear();try{await this.contentStore.clear(),await this.searchIndex.clear()}catch(e){throw S.error("Failed to clear index:",e),e}}async readFileContent(e){try{return await this.app.vault.read(e)}catch(t){return S.error(`Enhanced search: Failed to read file ${e.path}:`,t),""}}extractMetadata(e,t){const i=this.app.metadataCache.getFileCache(e);return{path:e.path,title:this.extractTitle(t)||e.basename,headings:i?.headings?.map(e=>({heading:e.heading,level:e.level}))||[],frontmatter:i?.frontmatter||{},tags:i?.tags?.map(e=>e.tag)||[],aliases:this.normalizeAliases(i?.frontmatter?.aliases),links:i?.links?.map(e=>e.link)||[],size:e.stat.size,lastModified:e.stat.mtime,contentHash:Ie(t)}}extractTitle(e){const t=e.match(/^#\s+(.+)$/m);if(t)return t[1].trim();const i=e.match(/^---\s*\n(?:.*\n)*?title:\s*(.+)\n(?:.*\n)*?---/m);return i?i[1].trim().replace(/['"]/g,""):void 0}async scheduleFileUpdate(e,t){if(S.debug(`Enhanced search: Scheduling ${t} operation for ${e}`),"modify"===t){const t=this.getFileByPath?.(e);if(t)return void await this.indexFile(t)}this.debounceCallback(e,t)}setFileGetter(e){this.getFileByPath=e}async shutdown(){for(const e of this.pendingUpdates.values())clearTimeout(e);this.pendingUpdates.clear(),this.isInitialized=!1}destroy(){this.pendingUpdates.forEach(e=>clearTimeout(e)),this.pendingUpdates.clear()}async shouldReindexFile(e,t){try{const i=await(this.persistence.getMetadata?.(e));return!i||(i.contentHash!==t.contentHash?(S.debug(`Enhanced search: Content hash changed for ${e}`),!0):i.lastModified!==t.lastModified?(S.debug(`Enhanced search: Last modified time changed for ${e}`),!0):i.size!==t.size&&(S.debug(`Enhanced search: File size changed for ${e}`),!0))}catch(t){return S.warn(`Enhanced search: Error checking if file should be reindexed ${e}:`,t),!0}}async updateIndexMetadata(e,t){try{if(this.persistence.setMetadata){const i={...t,indexedAt:Date.now()};await this.persistence.setMetadata(e,i)}}catch(t){S.warn(`Enhanced search: Failed to update index metadata for ${e}:`,t)}}async forceReindexFile(e,t){this.pendingUpdates.has(e.path)&&clearTimeout(this.pendingUpdates.get(e.path));try{const i=t||await this.readFileContent(e),s=this.extractMetadata(e,i);S.debug(`Enhanced search: Force reindexing ${e.path}`),this.enableContentSearch&&await this.contentStore.set(e.path,i),await this.searchIndex.addDocument(e.path,i,s),await this.updateIndexMetadata(e.path,s),this.debounceCallback(e.path,"modify")}catch(t){throw S.error(`Failed to force reindex file ${e.path}:`,t),t}}normalizeAliases(e){return e?Array.isArray(e)?e.filter(e=>"string"==typeof e):"string"==typeof e?[e]:[]:[]}async handleFileChange(e,t){if(this.shouldReindexFile(e.path,this.extractMetadata(e,await this.readFileContent(e))))try{const i="delete"===t?"":await this.readFileContent(e),s=Ie(i),n=await(this.persistence.getMetadata?.(e.path));if(n&&n.contentHash===s)return void S.debug(`Enhanced search: Skipping reindex of ${e.path} - content unchanged`);switch(S.debug(`Enhanced search: Reindexing ${e.path} due to content changes`),t){case"create":case"modify":await this.indexFile(e,i);break;case"delete":await this.removeFile(e.path)}}catch(t){S.error(`Enhanced search: Failed to handle file change for ${e.path}:`,t)}}}class Fe{constructor(){this.dbName="better-command-palette-index",this.dbVersion=1,this.db=null,this.isInitialized=!1}async initialize(){if(!this.isInitialized)return new Promise((e,t)=>{const i=indexedDB.open(this.dbName,this.dbVersion);i.onerror=()=>{t(new Error(`Failed to open IndexedDB: ${i.error?.message||"Unknown error"}`))},i.onsuccess=()=>{this.db=i.result,this.isInitialized=!0,e()},i.onupgradeneeded=e=>{const t=e.target.result;this.createObjectStores(t)}})}createObjectStores(e){if(!e.objectStoreNames.contains("content")){const t=e.createObjectStore("content",{keyPath:"id"});t.createIndex("timestamp","timestamp"),t.createIndex("size","size")}if(!e.objectStoreNames.contains("index_metadata")){const t=e.createObjectStore("index_metadata",{keyPath:"id"});t.createIndex("lastModified","lastModified"),t.createIndex("contentHash","contentHash")}if(!e.objectStoreNames.contains("usage_stats")){const t=e.createObjectStore("usage_stats",{keyPath:"id"});t.createIndex("lastAccessed","lastAccessed"),t.createIndex("accessCount","accessCount")}}ensureInitialized(){if(!this.isInitialized||!this.db)throw new Error("IndexPersistence not initialized. Call initialize() first.")}async get(e){return this.ensureInitialized(),new Promise((t,i)=>{const s=this.db.transaction(["content"],"readonly").objectStore("content").get(e);s.onsuccess=()=>{const{result:e}=s;t(e?.content||"")},s.onerror=()=>{i(new Error(`Failed to get content for ${e}: ${s.error?.message}`))}})}async set(e,t){return this.ensureInitialized(),new Promise((i,s)=>{const n=this.db.transaction(["content"],"readwrite").objectStore("content"),a={id:e,content:t,timestamp:Date.now(),size:t.length,compressed:!1},r=n.put(a);r.onsuccess=()=>{i()},r.onerror=()=>{s(new Error(`Failed to store content for ${e}: ${r.error?.message}`))}})}async delete(e){return this.ensureInitialized(),new Promise((t,i)=>{const s=this.db.transaction(["content","index_metadata","usage_stats"],"readwrite"),n=s.objectStore("content"),a=s.objectStore("index_metadata"),r=s.objectStore("usage_stats");n.delete(e),a.delete(e),r.delete(e),s.oncomplete=()=>{t()},s.onerror=()=>{i(new Error(`Failed to delete ${e}: ${s.error?.message}`))}})}async clear(){return this.ensureInitialized(),new Promise((e,t)=>{const i=this.db.transaction(["content","index_metadata","usage_stats"],"readwrite");i.objectStore("content").clear(),i.objectStore("index_metadata").clear(),i.objectStore("usage_stats").clear(),i.oncomplete=()=>{e()},i.onerror=()=>{t(new Error(`Failed to clear stores: ${i.error?.message}`))}})}async getStats(){return this.ensureInitialized(),new Promise((e,t)=>{const i=this.db.transaction(["content"],"readonly").objectStore("content").openCursor();let s=0,n=0;i.onsuccess=t=>{const i=t.target.result;i?(s++,n+=i.value.size||0,i.continue()):e({count:s,size:n})},i.onerror=()=>{t(new Error(`Failed to get stats: ${i.error?.message}`))}})}async setMetadata(e,t){return this.ensureInitialized(),new Promise((i,s)=>{const n=this.db.transaction(["index_metadata"],"readwrite").objectStore("index_metadata"),a={id:e,...t,timestamp:Date.now()},r=n.put(a);r.onsuccess=()=>{i()},r.onerror=()=>{s(new Error(`Failed to store metadata for ${e}: ${r.error?.message}`))}})}async getMetadata(e){return this.ensureInitialized(),new Promise((t,i)=>{const s=this.db.transaction(["index_metadata"],"readonly").objectStore("index_metadata").get(e);s.onsuccess=()=>{t(s.result||null)},s.onerror=()=>{i(new Error(`Failed to get metadata for ${e}: ${s.error?.message}`))}})}async setUsageStats(e,t){return this.ensureInitialized(),new Promise((i,s)=>{const n=this.db.transaction(["usage_stats"],"readwrite").objectStore("usage_stats"),a={id:e,...t,lastUpdated:Date.now()},r=n.put(a);r.onsuccess=()=>{i()},r.onerror=()=>{s(new Error(`Failed to store usage stats for ${e}: ${r.error?.message}`))}})}async getUsageStats(e){return this.ensureInitialized(),new Promise((t,i)=>{const s=this.db.transaction(["usage_stats"],"readonly").objectStore("usage_stats").get(e);s.onsuccess=()=>{t(s.result||null)},s.onerror=()=>{i(new Error(`Failed to get usage stats for ${e}: ${s.error?.message}`))}})}async getAllUsageStats(){return this.ensureInitialized(),new Promise((e,t)=>{const i=this.db.transaction(["usage_stats"],"readonly").objectStore("usage_stats").openCursor(),s={};i.onsuccess=t=>{const i=t.target.result;i?(s[i.value.id]=i.value,i.continue()):e(s)},i.onerror=()=>{t(new Error(`Failed to get all usage stats: ${i.error?.message}`))}})}async loadSearchIndex(){return this.ensureInitialized(),new Promise((e,t)=>{const i=this.db.transaction(["index_metadata"],"readonly").objectStore("index_metadata").get("__search_index__");i.onsuccess=()=>{e(i.result?.data||null)},i.onerror=()=>{t(new Error(`Failed to load search index: ${i.error?.message}`))}})}async saveSearchIndex(e){return this.ensureInitialized(),new Promise((t,i)=>{const s=this.db.transaction(["index_metadata"],"readwrite").objectStore("index_metadata"),n={id:"__search_index__",data:e,timestamp:Date.now()},a=s.put(n);a.onsuccess=()=>{t()},a.onerror=()=>{i(new Error(`Failed to save search index: ${a.error?.message}`))}})}close(){this.db&&(this.db.close(),this.db=null,this.isInitialized=!1)}static async deleteDatabase(e="better-command-palette-index"){return new Promise((t,i)=>{const s=indexedDB.deleteDatabase(e);s.onsuccess=()=>{t()},s.onerror=()=>{i(new Error(`Failed to delete database: ${s.error?.message}`))},s.onblocked=()=>{S.warn("Database deletion blocked. Close all tabs using this database.")}})}async handleDatabaseBlocked(){S.warn("Database deletion blocked. Close all tabs using this database.")}}class Ee{constructor(){this.fileAccess=new Map,this.searchHistory=[],this.maxSearchHistory=1e3,this.storageKey="better-command-palette-usage",this.saveTimeoutId=null,this.SAVE_DEBOUNCE_MS=1500,this.STORAGE_VERSION="2.0.0",this.STORAGE_KEY=this.storageKey,this.bounceData=new Map,this.lastSearchResult=null,this.BOUNCE_THRESHOLD_MS=5e3,this.loadFromStorage()}recordFileOpen(e){if(!e||"string"!=typeof e)return;const t=Date.now(),i=this.fileAccess.get(e);i?(i.count++,i.lastOpened=t):this.fileAccess.set(e,{count:1,lastOpened:t,firstOpened:t}),this.queueSave()}recordSearchResultOpen(e,t){this.recordFileOpen(e),this.lastSearchResult={path:e,query:t,timestamp:Date.now()};const i=this.bounceData.get(e)??{bounceCount:0,openCount:0,lastBounce:0};i.openCount++,this.bounceData.set(e,i)}recordSearchModalOpen(){if(!this.lastSearchResult)return;const e=Date.now(),t=e-this.lastSearchResult.timestamp;if(t<this.BOUNCE_THRESHOLD_MS){const i=this.lastSearchResult.path,s=this.bounceData.get(i)??{bounceCount:0,openCount:1,lastBounce:0};s.bounceCount++,s.lastBounce=e,this.bounceData.set(i,s),S.debug(`Bounce detected for ${i} (returned after ${t}ms)`),this.queueSave()}this.lastSearchResult=null}getBounceScore(e){const t=this.bounceData.get(e);if(!t||0===t.openCount)return 0;const i=Math.min(t.bounceCount/t.openCount,1),s=(Date.now()-t.lastBounce)/864e5;return i*Math.exp(-s/14)}getHighBounceFiles(e=10){return Array.from(this.bounceData.entries()).filter(([,e])=>e.openCount>=3).map(([e,t])=>({path:e,bounceRate:t.bounceCount/t.openCount,bounceCount:t.bounceCount})).sort((e,t)=>t.bounceRate-e.bounceRate).slice(0,e)}recordSearch(e,t){if(!e||"string"!=typeof e)return;const i={query:e.trim(),timestamp:Date.now(),selectedPath:t};this.searchHistory.push(i),this.searchHistory.length>this.maxSearchHistory&&(this.searchHistory=this.searchHistory.slice(-this.maxSearchHistory)),this.queueSave()}recordFileCreate(e){this.recordFileOpen(e)}getUsageScore(e){const t=this.fileAccess.get(e);if(!t)return 0;const i=Math.log(1+t.count),s=Math.log(1+this.getMaxUsageCount());return s>0?i/s:0}getRecencyScore(e){const t=this.fileAccess.get(e);if(!t)return 0;const i=Date.now()-t.lastOpened;return Math.exp(-i/6048e5)}getLastOpened(e){const t=this.fileAccess.get(e);return t?.lastOpened}getSearchHistory(e){const t=[...this.searchHistory].reverse();return e?t.slice(0,e):t}getFrequentQueries(e=10){const t=new Map;return this.searchHistory.forEach(e=>{const i=t.get(e.query);i?(i.count++,i.lastUsed=Math.max(i.lastUsed,e.timestamp)):t.set(e.query,{count:1,lastUsed:e.timestamp})}),Array.from(t.entries()).map(([e,t])=>({query:e,...t})).sort((e,t)=>t.count-e.count||t.lastUsed-e.lastUsed).slice(0,e)}getRecentFiles(e=10){return Array.from(this.fileAccess.entries()).map(([e,t])=>({path:e,lastOpened:t.lastOpened,count:t.count})).sort((e,t)=>t.lastOpened-e.lastOpened).slice(0,e)}getFrequentFiles(e=10){return Array.from(this.fileAccess.entries()).map(([e,t])=>({path:e,count:t.count,lastOpened:t.lastOpened})).sort((e,t)=>t.count-e.count||t.lastOpened-e.lastOpened).slice(0,e)}getStaleFiles(e=30){const t=Date.now()-24*e*60*60*1e3;return Array.from(this.fileAccess.entries()).filter(([e,i])=>i.lastOpened<t).map(([e,t])=>({path:e,lastOpened:t.lastOpened,count:t.count})).sort((e,t)=>e.lastOpened-t.lastOpened)}async reset(){this.fileAccess.clear(),this.searchHistory=[],this.bounceData.clear(),this.lastSearchResult=null,this.flushPendingSave(),this.saveToStorage()}resetFileUsage(e){this.fileAccess.delete(e),this.bounceData.delete(e),this.queueSave()}async getStats(){return{totalOpens:Array.from(this.fileAccess.values()).reduce((e,t)=>e+t.count,0),totalSearches:this.searchHistory.length,uniqueFiles:this.fileAccess.size}}getMaxUsageCount(){let e=0;for(const t of this.fileAccess.values())e=Math.max(e,t.count);return e||1}saveToStorage(){try{const e=[];for(const[t,i]of this.fileAccess.entries())"string"==typeof t&&e.push({path:t,count:Number(i.count)||0,lastOpened:Number(i.lastOpened)||0,firstOpened:Number(i.firstOpened)||0});const t=[];for(const[e,i]of this.bounceData.entries())"string"==typeof e&&t.push({path:e,bounceCount:Number(i.bounceCount)||0,openCount:Number(i.openCount)||0,lastBounce:Number(i.lastBounce)||0});const i={version:this.STORAGE_VERSION,fileAccess:e,bounceData:t};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(i))}catch(e){S.error("Failed to save usage data to localStorage:",e)}}loadFromStorage(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(!e)return;const t=JSON.parse(e),i=t.version?.split(".")[0],s=this.STORAGE_VERSION.split(".")[0];if(i&&i!==s&&"1"!==i)return void S.debug("Usage data version mismatch, resetting data");if(t.fileAccess)for(const e of t.fileAccess)this.fileAccess.set(e.path,{count:e.count,lastOpened:e.lastOpened,firstOpened:e.firstOpened});if(t.bounceData)for(const e of t.bounceData)this.bounceData.set(e.path,{bounceCount:e.bounceCount,openCount:e.openCount,lastBounce:e.lastBounce})}catch(e){S.error("Failed to load usage data from localStorage:",e)}}exportData(){return{fileAccess:Array.from(this.fileAccess.entries()),searchHistory:this.searchHistory,version:"1.0.0",exportDate:Date.now()}}importData(e){try{if(!(e.version&&e.fileAccess&&e.searchHistory))throw new Error("Invalid data format");this.fileAccess=new Map(e.fileAccess),this.searchHistory=e.searchHistory,this.flushPendingSave(),this.saveToStorage()}catch(e){throw S.error("Failed to import usage data:",e),e}}getDataSize(){const e=100*this.fileAccess.size,t=80*this.searchHistory.length;return{fileAccessSize:e,searchHistorySize:t,totalSize:e+t}}queueSave(){if(null!==this.saveTimeoutId)return;const e="undefined"!=typeof window?window.setTimeout:setTimeout;this.saveTimeoutId=e(()=>{this.saveTimeoutId=null,this.saveToStorage()},this.SAVE_DEBOUNCE_MS)}flushPendingSave(){if(null===this.saveTimeoutId)return;("undefined"!=typeof window?window.clearTimeout:clearTimeout)(this.saveTimeoutId),this.saveTimeoutId=null}importUsageData(e){try{if(!e||"object"!=typeof e)throw new Error("Invalid usage data format");if(e.fileAccess&&Array.isArray(e.fileAccess))for(const t of e.fileAccess)t.path&&"string"==typeof t.path&&this.fileAccess.set(t.path,{count:t.count||0,lastOpened:t.lastOpened||Date.now(),firstOpened:t.firstOpened||Date.now()});this.flushPendingSave(),this.saveToStorage()}catch(e){throw S.error("Failed to import usage data:",e),e}}}class Me{constructor(e){this.settings=e}calculateCombinedScore(e){const t=this.settings.scoreWeights,i=this.normalizeBM25(e.contentScore),s=this.calculateRecencyScore(e.lastOpened),n=this.calculateFrequencyScore(e.usageScore),a=e.pageRankScore??0,r=e.bounceScore??0,c=t.relevance*i+t.recency*s+t.frequency*n+(t.linkImportance??0)*a-.1*r;return Math.max(0,Math.min(1,c))}normalizeBM25(e){return e<=0?0:e/(e+1)}calculateRecencyScore(e){if(!e||!this.settings.enableUsageTracking)return 0;const t=(Date.now()-e)/this.settings.recencyHalfLife;return Math.exp(-t)}calculateFrequencyScore(e){if(e<=0||!this.settings.enableUsageTracking)return 0;const t=Math.log(1+e)/Math.log(1+this.settings.maxUsageScore);return Math.min(1,t)}updateSettings(e){this.settings=e,this.validateSettings()}validateSettings(){const{scoreWeights:e}=this.settings,t=e.relevance+e.recency+e.frequency+(e.linkImportance??0);Math.abs(t-1)>.01&&S.warn(`Score weights sum to ${t.toFixed(3)}, expected ~1.0`),Object.entries(e).forEach(([e,t])=>{(t<0||t>1)&&S.warn(`Score weight ${e} is ${t}, should be between 0 and 1`)}),this.settings.recencyHalfLife<=0&&S.warn("Recency half-life should be positive"),this.settings.maxUsageScore<=0&&S.warn("Max usage score should be positive")}getSettings(){return{...this.settings}}getScoreBreakdown(e){return{relevance:this.normalizeBM25(e.contentScore),recency:this.calculateRecencyScore(e.lastOpened),frequency:this.calculateFrequencyScore(e.usageScore),linkImportance:e.pageRankScore??0,combined:this.calculateCombinedScore(e)}}}const Le=new class{constructor(){this.searchLatencies=[],this.indexingLatencies=[],this.memoryUsage=[],this.maxSamples=100,this.performanceMarks=new Map}startTiming(e){this.performanceMarks.set(e,performance.now())}endTiming(e,t="search"){const i=this.performanceMarks.get(e);if(!i)return S.warn(`No start time found for operation: ${e}`),0;const s=performance.now()-i;return this.performanceMarks.delete(e),"search"===t?this.recordSearchLatency(s):this.recordIndexingLatency(s),s}recordSearchLatency(e){this.searchLatencies.push(e),this.searchLatencies.length>this.maxSamples&&this.searchLatencies.shift()}recordIndexingLatency(e){this.indexingLatencies.push(e),this.indexingLatencies.length>this.maxSamples&&this.indexingLatencies.shift()}recordMemoryUsage(){if("memory"in performance){const e=performance.memory;this.memoryUsage.push(e.usedJSHeapSize),this.memoryUsage.length>this.maxSamples&&this.memoryUsage.shift()}}getSearchStats(){if(0===this.searchLatencies.length)return{averageLatency:0,medianLatency:0,p95Latency:0,maxLatency:0,sampleCount:0};const e=[...this.searchLatencies].sort((e,t)=>e-t);return{averageLatency:e.reduce((e,t)=>e+t,0)/e.length,medianLatency:e[Math.floor(e.length/2)],p95Latency:e[Math.floor(.95*e.length)],maxLatency:Math.max(...e),sampleCount:e.length}}getIndexingStats(){if(0===this.indexingLatencies.length)return{averageLatency:0,medianLatency:0,maxLatency:0,sampleCount:0};const e=[...this.indexingLatencies].sort((e,t)=>e-t);return{averageLatency:e.reduce((e,t)=>e+t,0)/e.length,medianLatency:e[Math.floor(e.length/2)],maxLatency:Math.max(...e),sampleCount:e.length}}getMemoryStats(){if(0===this.memoryUsage.length)return{averageUsage:0,peakUsage:0,currentUsage:0,sampleCount:0};const e=this.memoryUsage.reduce((e,t)=>e+t,0),t="memory"in performance?performance.memory.usedJSHeapSize:0;return{averageUsage:e/this.memoryUsage.length,peakUsage:Math.max(...this.memoryUsage),currentUsage:t,sampleCount:this.memoryUsage.length}}getPerformanceReport(){const e=this.getSearchStats(),t=this.getIndexingStats(),i=this.getMemoryStats();let s=100;e.averageLatency>100&&(s-=Math.min(50,(e.averageLatency-100)/10)),t.averageLatency>1e3&&(s-=Math.min(30,(t.averageLatency-1e3)/100));const n=i.currentUsage/1048576;return n>50&&(s-=Math.min(20,(n-50)/10)),{search:e,indexing:t,memory:i,healthScore:Math.max(0,Math.round(s))}}isPerformanceAcceptable(){const e=this.getSearchStats();return!(e.averageLatency>200)&&!(e.p95Latency>500)}clear(){this.searchLatencies=[],this.indexingLatencies=[],this.memoryUsage=[],this.performanceMarks.clear()}getRecommendations(){const e=[],t=this.getSearchStats(),i=this.getIndexingStats(),s=this.getMemoryStats();t.averageLatency>100&&e.push("Consider reducing the maximum number of indexed files to improve search speed."),t.p95Latency>300&&e.push("Search performance is inconsistent. Try increasing the search timeout or reducing content preview length."),i.averageLatency>2e3&&e.push("File indexing is slow. Consider increasing the indexing debounce time to batch updates.");return s.currentUsage/1048576>100&&e.push("High memory usage detected. Consider reducing the maximum indexed files or disabling full content search."),0===e.length&&e.push("Search performance is optimal!"),e}};class Re{constructor(t,i){this.isInitialized=!1,this.indexingPaused=!1,this.cacheSavePending=!1,this.isIndexing=!1,this.app=t,this.settings=i,this.termFrequencyIndex=new Ce,this.searchIndex=this.createSearchIndex(),this.persistence=new Fe,this.usageTracker=new Ee,this.scorer=new Me(i),this.lastIndexOptions=this.getMiniSearchOptions(),this.indexingCoordinator=new Te(this.app,this.searchIndex,this.persistence,this.usageTracker,this.persistence,e.debounce(this.performFileIndexing.bind(this),i.indexingDebounceMs),i.indexingDebounceMs,{enableContentSearch:i.enableContentSearch}),this.debouncedCacheSave=e.debounce(this.saveIndexToCache.bind(this),2e3)}isReady(){return this.isInitialized}createSearchIndex(){S.debug("Enhanced search: Using in-memory MiniSearch index");const e=new ke(this.getMiniSearchOptions());return e.setTermFrequencyIndex(this.termFrequencyIndex),e}getMiniSearchOptions(){const{typoTolerance:e,foldAccents:t,enableStemming:i,synonyms:s}=this.settings;return{typoTolerance:e,foldAccents:t,enableStemming:i,synonyms:s||[]}}haveIndexOptionsChanged(e,t){if(e.typoTolerance!==t.typoTolerance||e.foldAccents!==t.foldAccents||e.enableStemming!==t.enableStemming)return!0;const i=(e.synonyms||[]).map(e=>e.trim()).filter(e=>e.length>0),s=(t.synonyms||[]).map(e=>e.trim()).filter(e=>e.length>0);if(i.length!==s.length)return!0;return[...i].sort().join("\n")!==[...s].sort().join("\n")}requestCacheSave(){this.cacheSavePending||(this.cacheSavePending=!0,this.debouncedCacheSave())}runWhenIdle(e,t=1e3){return new Promise((i,s)=>{const n=()=>{e().then(i).catch(s)};"undefined"!=typeof window&&"requestIdleCallback"in window?requestIdleCallback(()=>{n()},{timeout:t}):setTimeout(()=>{n()},0)})}sleep(e){return new Promise(t=>{setTimeout(t,e)})}async initialize(){if(!this.isInitialized){S.debug("Enhanced search: Starting initialization...");try{await this.persistence.initialize(),S.debug("Enhanced search: Persistence initialized"),await this.indexingCoordinator.initialize(),S.debug("Enhanced search: IndexingCoordinator initialized"),await this.loadPersistedData(),S.debug("Enhanced search: Data loaded");const t=this.termFrequencyIndex.getStats();S.debug(`[EnhancedSearchService] After loadPersistedData - TFI: ${t.totalDocuments} docs, ${t.uniqueTerms} terms`),this.indexingCoordinator.setFileGetter(t=>{const i=this.app.vault.getAbstractFileByPath(t);return i instanceof e.TFile?i:null}),this.setupFileWatchers(),S.debug("Enhanced search: File watchers set up"),this.isInitialized=!0,S.debug("Enhanced search: Service ready (indexing will continue in background)"),this.indexVault().then(()=>{const e=this.termFrequencyIndex.getStats();S.debug(`[EnhancedSearchService] After indexVault - TFI: ${e.totalDocuments} docs, ${e.uniqueTerms} terms`),S.debug("Enhanced search: Background vault indexing complete")}).catch(e=>{S.error("Enhanced search: Background vault indexing failed:",e)})}catch(e){throw S.error("Enhanced search: Failed to initialize:",e),e}}}async search(e,t=50){if(!this.isInitialized)throw new Error("Search service not initialized");S.debug(`Enhanced search: Searching for "${e}" with limit ${t}`);const i=`search-${Date.now()}`;Le.startTiming(i);try{const s=await this.searchIndex.search(e,2*t);S.debug(`Enhanced search: MiniSearch returned ${s.length} results`);const n=s.map(t=>this.buildEnhancedResult(e,t));n.sort((e,t)=>t.combinedScore-e.combinedScore);const a=Le.endTiming(i,"search");return a>1e3&&S.debug(`Enhanced search: Long search took ${a}ms`),this.settings.enableUsageTracking&&this.usageTracker.recordSearch(e),n.slice(0,t)}catch(e){throw Le.endTiming(i,"search"),S.error("Search failed:",e),e}}buildEnhancedResult(e,t){const i=this.settings.enableUsageTracking?this.usageTracker.getUsageScore(t.metadata.path):0,s=this.settings.enableUsageTracking?this.usageTracker.getRecencyScore(t.metadata.path):0,n=this.usageTracker.getLastOpened(t.metadata.path),a=this.scorer.calculateCombinedScore({query:e,contentScore:t.score,usageScore:i,recencyScore:s,metadata:t.metadata,lastOpened:n});return{...t,combinedScore:a,contentScore:t.score,usageScore:i,recencyScore:s,lastOpened:n}}async searchStream(e,t=50,i={}){if(!this.isInitialized)throw new Error("Search service not initialized");const{chunkSize:s=10,signal:n,onChunk:a}=i,r=`search-stream-${Date.now()}`;Le.startTiming(r);try{const i=await this.searchIndex.search(e,2*t);if(0===i.length)return this.settings.enableUsageTracking&&!n?.aborted&&this.usageTracker.recordSearch(e),a?.([],{done:!0,received:0,total:0}),void Le.endTiming(r,"search");const c=[],o=i.length;for(let r=0;r<i.length&&c.length<t&&!n?.aborted;r+=1){c.push(this.buildEnhancedResult(e,i[r]));if(c.length%s===0||r===i.length-1||c.length>=t){const e=[...c].sort((e,t)=>t.combinedScore-e.combinedScore).slice(0,t);a?.(e,{done:r===i.length-1||c.length>=t,received:c.length,total:o}),await this.sleep(0)}}this.settings.enableUsageTracking&&!n?.aborted&&this.usageTracker.recordSearch(e);const h=Le.endTiming(r,"search");h>1e3&&S.debug(`Enhanced search: Long streaming search took ${h}ms`)}catch(e){throw Le.endTiming(r,"search"),S.error("Search stream failed:",e),e}}recordFileAccess(e){this.settings.enableUsageTracking&&this.usageTracker.recordFileOpen(e)}recordSearchSelection(e,t){this.isInitialized?this.usageTracker.recordSearch(e,t):S.warn("Enhanced search: Cannot record search selection - service not initialized")}getLastOpened(e){if(this.isInitialized)return this.usageTracker.getLastOpened(e)}updateSettings(e){const t=this.lastIndexOptions;this.settings={...this.settings,...e},this.scorer=new Me(this.settings);const i=this.getMiniSearchOptions();this.lastIndexOptions=i,this.searchIndex.updateOptions&&this.searchIndex.updateOptions(i);this.haveIndexOptionsChanged(t,i)&&this.isInitialized&&this.rebuildIndex().catch(e=>{S.error("Enhanced search: Failed to rebuild index after setting changes",e)})}getSearchStats(){return{indexStats:this.searchIndex.getStats(),usageStats:{},performanceStats:Le.getPerformanceReport()}}async clearAllData(){await this.searchIndex.clear(),await this.persistence.clear(),await this.usageTracker.reset(),Le.clear()}async rebuildIndex(){S.debug("Enhanced search: Rebuilding entire index..."),await this.searchIndex.clear();try{await this.persistence.saveSearchIndex(null),S.debug("Enhanced search: Cleared cached index")}catch(e){S.warn("Enhanced search: Failed to clear cached index:",e)}await this.indexVault()}async shutdown(){this.indexingCoordinator&&await this.indexingCoordinator.shutdown(),this.isInitialized=!1}async triggerVaultIndexing(){this.isInitialized?(S.debug("Enhanced search: Manually triggering vault indexing..."),await this.indexVault()):S.warn("Enhanced search: Service not initialized yet")}pauseIndexing(){this.indexingPaused=!0,S.debug("Enhanced search: Indexing paused")}resumeIndexing(){this.indexingPaused=!1,S.debug("Enhanced search: Indexing resumed")}isIndexingPaused(){return this.indexingPaused}getIndexingProgress(){return{isIndexing:this.isIndexing,currentStats:this.searchIndex.getStats(),isPaused:this.indexingPaused}}async forceCacheSave(){await this.saveIndexToCache()}getTermFrequencyIndex(){return this.termFrequencyIndex}async loadPersistedData(){try{const e=await this.persistence.loadSearchIndex();if(e&&e.index){S.debug("Enhanced search: Loading cached search index..."),await this.searchIndex.loadFromData(e),S.debug(`Enhanced search: Loaded cached index with ${e.stats?.documentCount||0} documents`);if(await this.validateCache(e))S.debug("Enhanced search: Cache is valid, skipping full reindex");else{S.debug("[Enhanced Search] Cache is outdated, clearing index for rebuild"),S.debug("Enhanced search: Cache is outdated, will rebuild index"),await this.searchIndex.clear();try{await this.persistence.clear(),S.debug("[Enhanced Search] Cleared persistence metadata"),S.debug("Enhanced search: Cleared cached metadata to match cleared index")}catch(e){S.warn("Enhanced search: Failed to clear cached metadata:",e)}}}else S.debug("Enhanced search: No cached index found, will build from scratch")}catch(e){S.warn("Failed to load persisted search data:",e),await this.searchIndex.clear()}}async validateCache(e){try{if(!e.stats?.lastUpdated)return!1;if(!e.termFrequencyIndex)return S.debug("[Enhanced Search] Cache missing TermFrequencyIndex data, will rebuild"),!1;try{const t=e.termFrequencyIndex;S.debug(`[Enhanced Search] Cache has TermFrequencyIndex: version=${t.version}, docs=${t.totalDocuments}, terms=${t.termDocCount?.length??0}`)}catch(e){S.debug("[Enhanced Search] Failed to log TermFrequencyIndex stats:",e)}const t=e.stats.lastUpdated,i=this.app.vault.getMarkdownFiles(),s=i.length,n=e.stats?.documentCount||0;if(Math.abs(s-n)>Math.max(1,.1*s))return S.debug(`Enhanced search: File count changed significantly (${s} vs ${n})`),!1;const a=Math.min(i.length,50),r=i.length>a?this.sampleArray(i,a):i;S.debug(`Enhanced search: Checking ${r.length} files for modifications (sampling from ${i.length} total)`);for(const e of r)if(e.stat.mtime>t)return S.debug(`Enhanced search: File ${e.path} modified since cache (${new Date(e.stat.mtime).toISOString()} > ${new Date(t).toISOString()})`),!1;return S.debug(`Enhanced search: Cache is valid (${n} files, last updated ${new Date(t).toISOString()})`),!0}catch(e){return S.warn("Enhanced search: Failed to validate cache:",e),!1}}sampleArray(e,t){if(e.length<=t)return e;const i=[],s=e.length/t;for(let n=0;n<t;n++){const t=Math.floor(n*s);i.push(e[t])}return i}async saveIndexToCache(){try{const e=await this.searchIndex.serialize();await this.persistence.saveSearchIndex(e),S.debug("Enhanced search: Index saved to cache")}catch(e){S.warn("Enhanced search: Failed to save index to cache:",e)}finally{this.cacheSavePending=!1}}setupFileWatchers(){this.app.vault.on("modify",t=>{t instanceof e.TFile&&"md"===t.extension&&this.handleFileChange(t.path,"modify")}),this.app.vault.on("create",t=>{t instanceof e.TFile&&"md"===t.extension&&(this.handleFileChange(t.path,"create"),this.settings.enableUsageTracking&&this.usageTracker.recordFileCreate(t.path))}),this.app.vault.on("delete",t=>{t instanceof e.TFile&&"md"===t.extension&&this.handleFileChange(t.path,"delete")}),this.app.vault.on("rename",(t,i)=>{t instanceof e.TFile&&"md"===t.extension&&this.handleFileRename(i,t.path)})}async handleFileChange(e,t){try{if(this.indexingPaused&&"delete"!==t)return void S.debug(`Enhanced search: Skipping ${t} for ${e} (indexing paused)`);const i=()=>{"requestIdleCallback"in window?requestIdleCallback(async()=>{try{await this.indexingCoordinator.scheduleFileUpdate(e,t)}catch(t){S.error(`Failed to schedule file update for ${e}:`,t)}},{timeout:2e3}):setTimeout(async()=>{try{await this.indexingCoordinator.scheduleFileUpdate(e,t)}catch(t){S.error(`Failed to schedule file update for ${e}:`,t)}},50)};"delete"===t?i():setTimeout(i,200)}catch(t){S.error(`Failed to handle file change for ${e}:`,t)}}async handleFileRename(e,t){try{if(this.indexingPaused)return void S.debug(`Enhanced search: Skipping rename for ${e} to ${t} (indexing paused)`);(()=>{"requestIdleCallback"in window?requestIdleCallback(async()=>{try{await this.indexingCoordinator.renameFile(e,t)}catch(i){S.error(`Failed to handle file rename for ${e} to ${t}:`,i)}},{timeout:2e3}):setTimeout(async()=>{try{await this.indexingCoordinator.renameFile(e,t)}catch(i){S.error(`Failed to handle file rename for ${e} to ${t}:`,i)}},50)})()}catch(i){S.error(`Failed to handle file rename for ${e} to ${t}:`,i)}}async indexVault(){if(this.isIndexing)return void S.debug("Enhanced search: Indexing already in progress, skipping");this.isIndexing=!0;const e=`index-vault-${Date.now()}`;Le.startTiming(e);try{if(!this.app.vault)return void S.warn("Enhanced search: Vault not available yet");const t=this.app.vault.getMarkdownFiles();if(S.debug(`Enhanced search: Found ${t.length} markdown files to check`),0===t.length)return S.warn("Enhanced search: No markdown files found. This might indicate the vault is not fully loaded yet."),void setTimeout(()=>{S.debug("Enhanced search: Retrying vault indexing..."),this.indexVault().catch(e=>{S.error("Enhanced search: Retry failed:",e)})},2e3);const i=t.slice(0,this.settings.maxIndexedFiles);i.length<t.length&&S.warn(`Indexing limited to ${this.settings.maxIndexedFiles} files out of ${t.length} total`),S.debug(`[Enhanced Search] Checking ${i.length} files for indexing needs...`);const s=await this.getFilesNeedingIndexing(i);if(S.debug(`[Enhanced Search] getFilesNeedingIndexing returned ${s.length} files to index`),0===s.length)return S.debug("[Enhanced Search] No files need indexing - this is unexpected after cache clear!"),S.debug("Enhanced search: All files are already indexed and up-to-date"),void Le.endTiming(e,"indexing");S.debug(`[Enhanced Search] Starting to index ${s.length} files`),S.debug(`Enhanced search: Found ${s.length} files that need indexing (${i.length-s.length} already cached)`),S.debug(`Enhanced search: Starting to index ${s.length} files`);const n=Math.max(1,this.settings.indexingBatchSize||3),a=s.length>200?Math.min(2*n,20):n,r=Math.max(0,this.settings.indexingDelayMs??50),c=Math.max(0,this.settings.indexingBatchDelayMs??200),o=s.length>200?Math.floor(r/2):r,h=s.length>200?Math.floor(c/2):c;let d=0;for(let e=0;e<s.length;e+=a){const t=s.slice(e,e+a);S.debug(`Enhanced search: Indexing batch ${Math.floor(e/a)+1}/${Math.ceil(s.length/a)} (files ${d+1}-${d+t.length})`);for(const e of t){if(this.indexingPaused)return void S.debug("Enhanced search: Indexing paused by user, stopping vault indexing");try{await this.performFileIndexingInternal(e.path,"create"),d++,o>0&&await this.sleep(o)}catch(t){S.error(`Enhanced search: Failed to index ${e.path}:`,t)}}h>0&&await this.sleep(h),d%5!=0&&d!==s.length||S.debug(`Enhanced search: Progress ${d}/${s.length} files indexed`)}S.debug("Enhanced search: Vault indexing completed"),await this.saveIndexToCache(),Le.endTiming(e,"indexing")}catch(t){throw Le.endTiming(e,"indexing"),S.error("Failed to index vault:",t),t}finally{this.isIndexing=!1}}async performFileIndexing(e,t){await this.runWhenIdle(async()=>{await this.performFileIndexingInternal(e,t)},1e3)}async performFileIndexingInternal(t,i){const s=Date.now();try{if("delete"===i){await this.searchIndex.removeDocument(t);try{await this.persistence.delete(t)}catch(e){S.warn(`Failed to clean up metadata for deleted file ${t}:`,e)}return S.debug(`Enhanced search: Removed ${t} from index (${Date.now()-s}ms)`),void this.requestCacheSave()}const n=this.app.vault.getAbstractFileByPath(t);if(!(n&&n instanceof e.TFile&&"md"===n.extension))return;const a=this.settings.maxFileSize||524288;if(n.stat.size>a)return void S.warn(`Enhanced search: Skipping large file ${t} (${Math.round(n.stat.size/1024)}KB)`);const r=this.extractFileMetadata(n),c=await this.app.vault.read(n);if(!c||0===c.trim().length)return;await this.indexDocumentAsync(t,c,r);const o=Date.now()-s;o>100&&S.debug(`Enhanced search: Indexed ${t} (${o}ms, ${Math.round(c.length/1024)}KB)`),this.requestCacheSave()}catch(e){throw S.error(`Enhanced search: Failed to index ${t}:`,e),e}}async indexDocumentAsync(e,t,i){await this.searchIndex.addDocument(e,t,i),await this.persistence.setMetadata(e,{lastModified:i.lastModified,indexedAt:Date.now(),contentHash:Ie(t),size:t.length}),this.settings.enableContentSearch&&this.persistence.set(e,t).catch(t=>{S.warn(`Failed to store content for ${e}:`,t)});this.searchIndex.getStats().documentCount%50==0&&this.requestCacheSave()}async isCacheAvailable(){try{const e=await this.persistence.loadSearchIndex();return!(!e||!e.index)}catch(e){return!1}}async getFilesNeedingIndexing(e){const t=[];if(S.debug(`Enhanced search: Checking ${e.length} files for indexing needs`),0===e.length)return t;let i=0;const s=Math.min(8,Math.max(1,Math.ceil(e.length/100))),n=Array.from({length:s},async()=>{for(;i<e.length;){const s=i;i+=1;const n=e[s];n&&(await this.doesFileNeedIndexing(n)&&t.push(n))}});return await Promise.all(n),S.debug(`Enhanced search: ${t.length} files need indexing out of ${e.length} total`),t}async doesFileNeedIndexing(e){try{const t=await this.persistence.getMetadata(e.path);return S.debug(`Enhanced search: Metadata check for ${e.path}:`,t?"found":"not found"),t?e.stat.mtime>t.indexedAt?(S.debug(`Enhanced search: File ${e.path} needs reindexing (modified ${new Date(e.stat.mtime).toISOString()} > indexed ${new Date(t.indexedAt).toISOString()})`),!0):this.searchIndex.hasDocument(e.path)?(S.debug(`Enhanced search: File ${e.path} is up to date (indexed ${new Date(t.indexedAt).toISOString()})`),!1):(S.debug(`Enhanced search: File ${e.path} not found in search index, needs indexing`),!0):(S.debug(`Enhanced search: File ${e.path} has no metadata, needs indexing`),!0)}catch(t){return S.warn(`Enhanced search: Error checking metadata for ${e.path}, will reindex:`,t),!0}}extractFileMetadata(e){const t=this.app.metadataCache.getFileCache(e);return{path:e.path,title:t?.frontmatter?.title||e.basename,headings:t?.headings?.map(e=>({heading:e.heading,level:e.level}))||[],frontmatter:t?.frontmatter||{},tags:t?.tags?.map(e=>e.tag)||[],aliases:this.normalizeAliases(t?.frontmatter?.aliases),links:t?.links?.map(e=>e.link)||[],size:e.stat.size,lastModified:e.stat.mtime}}normalizeAliases(e){return e?Array.isArray(e)?e.filter(e=>"string"==typeof e):"string"==typeof e?[e]:[]:[]}}class $e{constructor(e=3,t=!0){this.queue=[],this.activeRequests=0,this.recentResponseTimes=[],this.responseTimeWindow=10,this.fastThresholdMs=500,this.slowThresholdMs=2e3,this.lastAdjustmentTime=0,this.adjustmentCooldownMs=5e3,this.maxConcurrent=Math.min(e,10),this.userMaxConcurrent=Math.min(e,10),this.enableAdaptive=t}async add(e){return new Promise((t,i)=>{this.queue.push(async()=>{const s=Date.now();try{this.activeRequests++;const i=await e();this.recordResponseTime(Date.now()-s,!0),t(i)}catch(e){this.recordResponseTime(Date.now()-s,!1),i(e)}finally{this.activeRequests--,this.processNext()}}),this.processNext()})}recordResponseTime(e,t){if(!this.enableAdaptive)return;this.recentResponseTimes.push(e),this.recentResponseTimes.length>this.responseTimeWindow&&this.recentResponseTimes.shift();const i=Date.now();this.recentResponseTimes.length>=3&&i-this.lastAdjustmentTime>this.adjustmentCooldownMs&&(this.adjustConcurrency(t),this.lastAdjustmentTime=i)}adjustConcurrency(e){const t=this.recentResponseTimes.reduce((e,t)=>e+t,0)/this.recentResponseTimes.length,i=this.recentResponseTimes.filter(e=>e<this.fastThresholdMs).length,s=this.recentResponseTimes.filter(e=>e>this.slowThresholdMs).length,n=this.maxConcurrent;e?s>this.recentResponseTimes.length/2?this.maxConcurrent=Math.max(1,this.maxConcurrent-1):i>.7*this.recentResponseTimes.length&&t<this.fastThresholdMs&&(this.maxConcurrent=Math.min(this.userMaxConcurrent,this.maxConcurrent+1)):this.maxConcurrent=Math.max(1,this.maxConcurrent-1),n!==this.maxConcurrent&&S.debug(`[Semantic Search] Adaptive throttling: adjusted concurrency ${n} â†’ ${this.maxConcurrent} (avg: ${t.toFixed(0)}ms, fast: ${i}, slow: ${s})`)}processNext(){if(this.queue.length>0&&this.activeRequests<this.maxConcurrent){this.queue.shift()()}}getQueueSize(){return this.queue.length}getActiveRequests(){return this.activeRequests}getCurrentConcurrency(){return this.maxConcurrent}clear(){this.queue=[]}updateConcurrentLimit(e){const t=Math.min(Math.max(1,e),10);this.userMaxConcurrent=t,this.maxConcurrent=Math.min(this.maxConcurrent,t),this.processNext()}setAdaptiveThrottling(e){this.enableAdaptive=e,e||(this.maxConcurrent=this.userMaxConcurrent,this.recentResponseTimes=[])}getStats(){return{avgResponseTime:this.recentResponseTimes.length>0?this.recentResponseTimes.reduce((e,t)=>e+t,0)/this.recentResponseTimes.length:0,currentConcurrency:this.maxConcurrent,userMax:this.userMaxConcurrent}}}class ze{constructor(e,t,i){this.chunkEmbeddingsCache=new Map,this.cacheMetadata=new Map,this.defaultModelId="nomic-embed-text",this.vault=e,this.metadataCache=t,this.settings=i,this.requestQueue=new $e(i.maxConcurrentRequests,i.enableAdaptiveThrottling??!0),this.cacheFile=".obsidian/plugins/obsidian-better-command-palette/embeddings.json",S.debug(`Semantic search: EmbeddingService initialized with cache file: ${this.cacheFile}`),S.debug(`Semantic search: Cache enabled: ${i.cacheEnabled}`),S.debug(`Semantic search: Max concurrent requests: ${i.maxConcurrentRequests}, adaptive: ${i.enableAdaptiveThrottling??!0}`)}async initialize(){S.debug("Semantic search: Initializing EmbeddingService..."),this.settings.cacheEnabled?(S.debug("Semantic search: Cache is enabled, attempting to load existing cache..."),await this.loadCache()):S.debug("Semantic search: Cache is disabled, skipping cache load"),S.debug(`Semantic search: EmbeddingService initialization complete. ${this.chunkEmbeddingsCache.size} files loaded from cache.`),void 0!==this.expectedDimension&&S.debug(`Semantic search: Expected embedding dimension: ${this.expectedDimension}`)}async loadCache(){try{if(S.debug(`Semantic search: Attempting to load cache from ${this.cacheFile}`),await this.vault.adapter.exists(this.cacheFile)){S.debug("Semantic search: Cache file exists, reading...");const e=await this.vault.adapter.read(this.cacheFile),t=JSON.parse(e);if(S.debug(`Semantic search: Cache loaded with version ${t.version}, ${Object.keys(t.embeddings).length} files`),"2.0.0"!==t.version)return void S.warn(`Semantic search: Cache version ${t.version} is outdated. Chunk-based embeddings require v2.0.0. Will rebuild index.`);let i=0,s=0,n=0,a=0;for(const[e,r]of Object.entries(t.embeddings)){const c=this.vault.getAbstractFileByPath(e);if(c)if(this.isFileUpToDate(c,r)){if(!r.chunks||0===r.chunks.length){S.debug(`Semantic search: No chunks for ${e}, skipping`),s++;continue}const c=[];let o=!0;for(const i of r.chunks){const s=new Float32Array(i.embedding);if(void 0===this.expectedDimension&&(this.expectedDimension=t.dimension??s.length,S.debug(`Semantic search: Derived expected dimension ${this.expectedDimension} from cache`)),this.expectedDimension!==s.length){S.warn(`Semantic search: Skipping chunk in ${e} due to dimension mismatch (${s.length} != ${this.expectedDimension})`),n++,o=!1;break}c.push({embedding:s,text:i.text,startLine:i.startLine})}if(!o){s++;continue}this.chunkEmbeddingsCache.set(e,c),this.cacheMetadata.set(e,{lastModified:r.lastModified,contentHash:r.contentHash}),i++,a+=c.length,S.debug(`Semantic search: Loaded ${c.length} chunks for ${e}`)}else S.debug(`Semantic search: File ${e} is newer than cache, skipping`),s++;else S.debug(`Semantic search: File ${e} no longer exists, skipping cache entry`),s++}S.debug(`Semantic search: Loaded ${i} files (${a} total chunks) from cache, skipped ${s}`),n>0&&S.warn(`Semantic search: Skipped ${n} chunks due to dimension mismatch. Consider re-indexing.`)}else S.debug("Semantic search: Cache file does not exist, starting fresh")}catch(e){S.error("Semantic search: Error loading embedding cache:",e)}}isFileUpToDate(e,t){return e.stat.mtime<=t.lastModified}async saveCache(){if(this.settings.cacheEnabled)try{S.debug(`Semantic search: Starting cache save with ${this.chunkEmbeddingsCache.size} files in memory`),S.debug(`Semantic search: Saving cache to: ${this.cacheFile}`);const e={version:"2.0.0",lastUpdated:Date.now(),model:this.settings.embeddingModel||this.defaultModelId,dimension:this.expectedDimension,embeddings:{}};let t=0,i=0,s=0;for(const[n,a]of this.chunkEmbeddingsCache){const r=this.vault.getAbstractFileByPath(n),c=this.cacheMetadata.get(n);if(!r){S.debug(`Semantic search: File ${n} no longer exists, skipping cache save`),i++;continue}if(!c){S.debug(`Semantic search: No metadata for ${n}, skipping cache save`),i++;continue}const o=a.map(e=>({embedding:Array.from(e.embedding),text:e.text,startLine:e.startLine}));e.embeddings[n]={lastModified:c.lastModified,contentHash:c.contentHash,chunks:o},t++,s+=o.length,S.debug(`Semantic search: Prepared ${n} for cache save (${o.length} chunks)`)}S.debug(`Semantic search: Writing cache file with ${t} files (${s} chunks, ${i} skipped) to ${this.cacheFile}`),await this.vault.adapter.write(this.cacheFile,JSON.stringify(e)),S.debug(`Semantic search: Successfully saved ${t} files to cache file`);const n=await this.vault.adapter.exists(this.cacheFile);if(S.debug(`Semantic search: Cache file exists after write: ${n}`),n){const e=await this.vault.adapter.stat(this.cacheFile);S.debug(`Semantic search: Cache file size: ${e?.size} bytes`)}}catch(e){S.error("Semantic search: Error saving embedding cache:",e),S.error("Semantic search: Cache file path:",this.cacheFile),S.error("Semantic search: Error details:",e)}else S.debug("Semantic search: Cache is disabled, skipping save")}async getContentHash(e){return Ie(await this.vault.cachedRead(e))}chunkDocument(e,t){const i=this.metadataCache.getFileCache(t),s=this.settings.chunkSize||400,n=t.basename,a=i?.tags?.map(e=>e.tag.replace("#","")).join(" ")||"",r=a?`${n} ${a}`:n,c=r.length+2,o=this.splitIntoSentences(e);if(0===o.length)return[`${r}: ${e.substring(0,s)}`];const h=[];let d=[],l=0;for(let e=0;e<o.length;e++){const t=o[e];if(!t)continue;const i=t.length,n=l+i>s-c,a=d.length>=2,u=d.length>=4;(n&&a||u)&&(d.length>0&&h.push(`${r}: ${d.join(" ")}`),d=[],l=0),d.push(t),l+=i+1}return d.length>0&&h.push(`${r}: ${d.join(" ")}`),h.length>0?h:[`${r}: ${e.substring(0,s)}`]}splitIntoSentences(e){return e.replace(/^---[\s\S]*?---\n?/,"").replace(/([.!?])\s+/g,"$1\n").split("\n").map(e=>e.trim()).filter(e=>e.length>0).filter(e=>e.length>10)}async generateEmbedding(t,i="search_document",s=3){for(let i=1;i<=s;i++)try{const i=await e.requestUrl({url:`${this.settings.ollamaUrl}/api/embeddings`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:this.settings.embeddingModel||this.defaultModelId,prompt:t})});if(200!==i.status)throw new Error(`HTTP ${i.status}: ${i.text}`);const s=i.json,n=Array.isArray(s?.embedding)?s.embedding:void 0;if(!n||0===n.length){const e="string"==typeof i.text?i.text.slice(0,200):"";throw console.error(`[Semantic Search] Invalid embedding response (missing/empty vector). Status: ${i.status}. Body snippet: ${e}`),new Error("Invalid embedding response: missing or empty embedding")}const a=new Float32Array(n);return void 0===this.expectedDimension?(this.expectedDimension=a.length,S.debug(`[Semantic Search] Set expected embedding dimension to ${this.expectedDimension}`)):this.expectedDimension!==a.length&&console.warn(`[Semantic Search] Generated embedding dimension ${a.length} differs from expected ${this.expectedDimension}`),a}catch(e){if(console.warn(`[Semantic Search] Embedding attempt ${i}/${s} failed:`,e),i===s){const t=e instanceof Error?e.message:String(e);throw new Error(`Failed after ${s} attempts: ${t}`)}await new Promise(e=>setTimeout(e,2**i*1e3))}throw new Error("Unexpected error in embedding generation")}shouldExcludeFile(e){return this.settings.excludePatterns&&0!==this.settings.excludePatterns.length?(S.debug(`Semantic search: Checking exclusion patterns for ${e.path}`),S.debug(`Semantic search: Available patterns: [${this.settings.excludePatterns.join(", ")}]`),this.settings.excludePatterns.some(t=>{try{let i=t.replace(/\./g,"\\.").replace(/\*\*\//g,"__DOUBLESTARSLASH__").replace(/\*\*/g,"__DOUBLESTAR__").replace(/\*/g,"[^/]*").replace(/__DOUBLESTARSLASH__/g,".*").replace(/__DOUBLESTAR__/g,"[^/]*").replace(/\?/g,"[^/]").replace(/\//g,"\\/");i=t.startsWith("**/")||t.startsWith("/")?`^${i}`:`(^|/)${i}`,t.endsWith("**")||(i=`${i}$`);const s=new RegExp(i).test(e.path);return S.debug(`Semantic search: Pattern "${t}" -> Regex "${i}" -> Match: ${s} for ${e.path}`),s&&S.debug(`Semantic search: File ${e.path} excluded by pattern: ${t}`),s}catch(e){return S.warn(`Semantic search: Invalid exclusion pattern: ${t}`,e),!1}})):(S.debug(`Semantic search: No exclusion patterns configured for ${e.path}`),!1)}async indexFile(e){try{if(this.shouldExcludeFile(e))return;const t=this.cacheMetadata.get(e.path);if(t&&this.isFileUpToDate(e,t))return;const i=await this.getContentHash(e);if(t&&t.contentHash===i)return void this.cacheMetadata.set(e.path,{lastModified:e.stat.mtime,contentHash:t.contentHash});const s=await this.vault.cachedRead(e);if(!s||0===s.trim().length)return;const n=this.chunkDocument(s,e);if(0===n.length||1===n.length&&0===n[0]?.trim().length)return;const a=[];for(let t=0;t<n.length;t++){const i=n[t];if(i)try{const s=await this.generateEmbedding(i,"search_document");if(void 0===this.expectedDimension&&(this.expectedDimension=s.length),this.expectedDimension!==s.length){console.warn(`[Semantic Search] Dimension mismatch for chunk ${t+1} of ${e.path}: got ${s.length}, expected ${this.expectedDimension}`);continue}a.push({embedding:s,text:i})}catch(i){console.error(`[Semantic Search] Failed to generate embedding for chunk ${t+1} of ${e.path}:`,i)}}if(0===a.length)return void console.warn(`[Semantic Search] No embeddings generated for ${e.path}`);this.chunkEmbeddingsCache.set(e.path,a),this.cacheMetadata.set(e.path,{lastModified:e.stat.mtime,contentHash:i}),S.debug(`Semantic search: Indexed ${e.path} with ${a.length} chunks`)}catch(t){throw console.error(`[Semantic Search] Error indexing file ${e.path}:`,t),t}}async indexAllFiles(e){const t=Date.now(),i=this.vault.getMarkdownFiles();S.debug(`[Semantic Search] Starting index scan of ${i.length} total markdown files...`);const s=i.filter(e=>{if(this.shouldExcludeFile(e))return!1;const t=this.cacheMetadata.get(e.path);return!t||!this.isFileUpToDate(e,t)}),n=this.chunkEmbeddingsCache.size,a=i.length-s.length-n,r=this.requestQueue.getStats();if(S.debug(`[Semantic Search] Files to index: ${s.length} (${n} cached, ${a} excluded)`),S.debug(`[Semantic Search] Concurrency: ${r.currentConcurrency}/${r.userMax} (adaptive: ${this.settings.enableAdaptiveThrottling??!0})`),0===s.length)return void S.debug("[Semantic Search] All files are already indexed or excluded, nothing to do");S.debug(`[Semantic Search] Starting to index ${s.length} files...`);let c=0,o=0;const h=s.map(t=>this.requestQueue.add(async()=>{try{const i=Date.now();await this.indexFile(t);const n=Date.now()-i;c++;const a=this.requestQueue.getStats();S.debug(`[Semantic Search] Indexed ${c}/${s.length}: ${t.path} (${n}ms, concurrency: ${a.currentConcurrency})`),e&&e(c,s.length),c%10==0&&await this.saveCache().catch(e=>{S.warn("Semantic search: Failed to save intermediate cache:",e)})}catch(e){o++,S.error(`Semantic search: Failed to index ${t.path}:`,e)}}));await Promise.all(h),await this.saveCache();const d=((Date.now()-t)/1e3).toFixed(1),l=this.requestQueue.getStats();S.debug(`[Semantic Search] âœ… Indexing complete: ${c} files, ${o} errors, ${d}s`),S.debug(`[Semantic Search] Final concurrency: ${l.currentConcurrency}/${l.userMax}, avg response: ${l.avgResponseTime.toFixed(0)}ms`)}async checkConnection(){try{S.debug(`[Semantic Search] Checking connection to ${this.settings.ollamaUrl}/api/tags...`);const t=(await e.requestUrl({url:`${this.settings.ollamaUrl}/api/tags`,method:"GET"})).json,i=this.settings.embeddingModel||this.defaultModelId,s=t.models.map(e=>e.name);S.debug(`[Semantic Search] Available models: ${s.join(", ")}`),S.debug(`[Semantic Search] Looking for model: ${i}`);const n=t.models.some(e=>e.name.includes(i));return S.debug(`[Semantic Search] Model found: ${n}`),n}catch(e){return console.error("[Semantic Search] Connection check failed:",e),!1}}cosineSimilarity(e,t){if(e.length!==t.length)return S.warn(`Semantic search: Cosine similarity dimension mismatch (${e.length} vs ${t.length}). Returning 0.`),0;let i=0,s=0,n=0;for(let a=0;a<e.length;a++){const r=e[a],c=t[a];void 0!==r&&void 0!==c&&(i+=r*c,s+=r*r,n+=c*c)}return 0===s||0===n?0:i/(Math.sqrt(s)*Math.sqrt(n))}getChunkEmbeddings(e){return this.chunkEmbeddingsCache.get(e)}getEmbedding(e){const t=this.chunkEmbeddingsCache.get(e);if(!t||0===t.length)return;const i=t[0];if(i){if(void 0===this.expectedDimension||i.embedding.length===this.expectedDimension)return i.embedding;S.warn(`Semantic search: Cached embedding for ${e} has wrong dimension (${i.embedding.length} != ${this.expectedDimension}). Ignoring.`)}}getIndexedFileCount(){return this.chunkEmbeddingsCache.size}getTotalChunkCount(){let e=0;for(const t of this.chunkEmbeddingsCache.values())e+=t.length;return e}getQueueStatus(){const e=this.requestQueue.getStats();return{queued:this.requestQueue.getQueueSize(),active:this.requestQueue.getActiveRequests(),currentConcurrency:e.currentConcurrency}}clearCache(){this.chunkEmbeddingsCache.clear(),this.cacheMetadata.clear(),this.expectedDimension=void 0}removeFromCache(e){this.chunkEmbeddingsCache.delete(e),this.cacheMetadata.delete(e)}updateSettings(e){this.settings=e,this.requestQueue.updateConcurrentLimit(e.maxConcurrentRequests),this.requestQueue.setAdaptiveThrottling(e.enableAdaptiveThrottling??!0),S.debug(`Semantic search: Settings updated - concurrency: ${e.maxConcurrentRequests}, adaptive: ${e.enableAdaptiveThrottling??!0}`)}}class De{constructor(e,t,i,s){this.searchCache=new Map,this.embeddingService=e,this.vault=t,this.metadataCache=i,this.settings=s}async search(e,t={}){const i=Date.now(),{limit:s=this.settings.maxResults,threshold:n=this.settings.searchThreshold,useCache:a=!0,signal:r}=t;if(S.debug(`Semantic search: Starting search for "${e}" (limit: ${s}, threshold: ${n})`),!e||e.trim().length<2)return S.debug("Semantic search: Query too short, skipping semantic lookup"),[];const c=`${e}:${n}:${s}`;if(a&&this.searchCache.has(c))return S.debug(`Semantic search: Returning cached results for "${e}"`),this.searchCache.get(c);const o=this.embeddingService.getIndexedFileCount();if(0===o)return S.warn("Semantic search: No files indexed. Please run indexing first."),[];S.debug(`Semantic search: Searching through ${o} indexed files`),S.debug(`Semantic search: Generating embedding for query "${e}"`);const h=await this.embeddingService.generateEmbedding(e,"search_query");if(S.debug(`Semantic search: Query embedding generated (${h.length} dimensions)`),0===h.length)return S.warn("Semantic search: Query embedding is empty. Aborting search. Check embedding API/model."),[];const d=[],l=this.vault.getMarkdownFiles();let u=0,g=0;for(const t of l){if(r?.aborted)return S.debug(`Semantic search: Aborted after ${u} files`),d.slice(0,s);const i=this.embeddingService.getChunkEmbeddings(t.path);if(u++,!i||0===i.length)continue;let a=0,c=-1,o="";for(let e=0;e<i.length;e++){if(e%10==0&&r?.aborted)return d.slice(0,s);const t=i[e];if(!t)continue;g++;const n=this.embeddingService.cosineSimilarity(h,t.embedding);n>c&&(c=n,a=e,o=t.text)}if(c>=n){const s=this.calculateRelevanceScore(t,c,e),n=this.analyzeMatches(t,e);let r=o;const h=r.indexOf(": ");-1!==h&&h<100&&(r=r.substring(h+2)),r.length>200&&(r=r.substring(0,200)+"..."),S.debug(`Semantic search: Found match ${t.path} chunk ${a+1}/${i.length} (similarity: ${c.toFixed(3)}, relevance: ${s.toFixed(3)})`),d.push({file:t,similarity:c,relevanceScore:s,title:t.basename,excerpt:r,matches:n,matchedChunkIndex:a,matchedChunkText:o})}}S.debug(`Semantic search: Found ${d.length} total matches from ${u} files (${g} total chunks scanned)`);const m=d.sort((e,t)=>{const i=t.relevanceScore-e.relevanceScore;if(Math.abs(i)>.001)return i;const s=t.similarity-e.similarity;return Math.abs(s)>.001?s:e.file.basename.localeCompare(t.file.basename)}).slice(0,s);if(S.debug(`Semantic search: Returning top ${m.length} results (limited from ${d.length}) sorted by relevance score`),m.length>1){const e=m[0].relevanceScore,t=m[m.length-1].relevanceScore;S.debug(`Semantic search: Score range: ${e.toFixed(3)} (highest) to ${t.toFixed(3)} (lowest)`)}if(a&&(this.searchCache.set(c,m),this.searchCache.size>100)){const e=this.searchCache.keys().next().value;this.searchCache.delete(e),S.debug("Semantic search: Cache size limited, removed oldest entry")}const p=Date.now()-i;return S.debug(`Semantic search: Search completed in ${p}ms`),m}calculateRelevanceScore(e,t,i){let s=.6*t;const n=i.toLowerCase(),a=e.basename.toLowerCase();a===n?s+=.25:a.includes(n)&&(s+=.15);const r=(Date.now()-e.stat.mtime)/864e5;r<30&&(s+=.1*Math.max(0,(30-r)/30));const c=this.metadataCache.getFileCache(e);c?.tags?.some(e=>e.tag.toLowerCase().includes(n))&&(s+=.1),c?.headings?.some(e=>e.heading.toLowerCase().includes(n))&&(s+=.08);const o=e.stat.size;return o>1e3&&o<5e4&&(s+=.02),Math.min(s,1)}analyzeMatches(e,t){const i=t.toLowerCase(),s=this.metadataCache.getFileCache(e);return{titleMatch:e.basename.toLowerCase().includes(i),tagMatch:s?.tags?.some(e=>e.tag.toLowerCase().includes(i))||!1,recentlyModified:Date.now()-e.stat.mtime<6048e5}}async extractRelevantExcerpt(e,t,i=200){try{const s=await this.vault.cachedRead(e),n=t.toLowerCase().split(/\s+/).filter(e=>e.length>2),a=s.split(/[.!?]+/).map(e=>e.trim()).filter(e=>e.length>0),r=a.map(e=>{const t=e.toLowerCase(),i=n.filter(e=>t.includes(e)).length;return{sentence:e,score:i/n.length,matches:i}}).reduce((e,t)=>t.score>e.score?t:e);if(r.matches>0){const{sentence:e}=r;return e.length>i?`${e.substring(0,i)}...`:e}return`${s.substring(0,i)}...`}catch(e){return"Could not load content"}}clearSearchCache(){this.searchCache.clear(),S.debug("Semantic search: Search cache cleared")}updateSettings(e){this.settings=e,this.clearSearchCache(),S.debug("Semantic search: Search engine settings updated")}getCacheStats(){return{size:this.searchCache.size,maxSize:100}}getEmbeddingService(){return this.embeddingService}}class Pe extends e.SuggestModal{constructor(e,t){super(e),this.isSearching=!1,this.currentResults=[],this.lastQuery="",this.plugin=t,this.modalEl.addClass("better-command-palette"),this.modalEl.setAttribute("palette-mode","semantic-search"),this.setPlaceholder("Search for concepts, ideas, or topics..."),this.setInstructions([{command:"â†‘â†“",purpose:"Navigate"},{command:"â†µ",purpose:"Open file"},{command:"esc",purpose:"Close"}])}convertToMatches(e){return e.map(e=>({id:e.file.path,text:e.title,excerpt:e.excerpt,similarity:e.similarity,file:e.file,matches:e.matches}))}getSuggestions(e){return!e||e.length<3?this.getDefaultSuggestions():e!==this.lastQuery||this.isSearching?(this.isSearching||this.performAsyncSearch(e),this.currentResults):this.currentResults}getDefaultSuggestions(){const t=[],i=new Set;try{const s=this.app.workspace.getLastOpenFiles().slice(0,8).map(e=>this.app.vault.getAbstractFileByPath(e)).filter(t=>t instanceof e.TFile);for(const e of s)i.has(e.path)||(i.add(e.path),t.push({id:e.path,text:e.basename,similarity:1,file:e,matches:{titleMatch:!1,tagMatch:!1,recentlyModified:this.isRecentlyModified(e)}}));if(t.length<10){const e=this.app.vault.getMarkdownFiles().filter(e=>!i.has(e.path)).sort((e,t)=>t.stat.mtime-e.stat.mtime).slice(0,10-t.length);for(const i of e)t.push({id:i.path,text:i.basename,similarity:.8,file:i,matches:{titleMatch:!1,tagMatch:!1,recentlyModified:!0}})}return t}catch(e){return S.warn("[SemanticSearch] Error getting default suggestions:",e),[]}}isRecentlyModified(e){return(Date.now()-e.stat.mtime)/864e5<=7}async performAsyncSearch(t){if(!this.isSearching){this.isSearching=!0,this.lastQuery=t;try{S.debug("[SemanticSearch] Starting search for:",t);const i=this.plugin.getSemanticSearchEngine();if(!i)return S.warn("[SemanticSearch] Search engine not available"),void new e.Notice("Semantic search not available");const s=Date.now(),n=await i.search(t);Date.now();S.debug(`[SemanticSearch] Found ${n.length} results`);const a=this.convertToMatches(n);this.currentResults=a,this.inputEl&&this.inputEl.value===t&&this.inputEl.dispatchEvent(new Event("input",{bubbles:!0}))}catch(t){S.error("[SemanticSearch] Search error:",t),new e.Notice(`Search error: ${t.message}`),this.currentResults=[]}finally{this.isSearching=!1}}}renderSuggestion(e,t){t.addClass("mod-complex");const i=t.createEl("div","suggestion-content"),s=t.createEl("div","suggestion-aux");if(this.renderFileSearchStyle(e,i),1===e.similarity){s.createEl("span",{cls:"suggestion-hotkey recent",text:"Recent"}).title="Recently opened file"}else if(.8===e.similarity){s.createEl("span",{cls:"suggestion-hotkey modified",text:"Modified"}).title="Recently modified file"}else{s.createEl("span",{cls:"suggestion-hotkey",text:`${Math.round(100*e.similarity)}%`}).title=`Semantic similarity: ${Math.round(100*e.similarity)}%`}if(e.similarity<1&&.8!==e.similarity){const t=[];if(e.matches.titleMatch&&t.push("title"),e.matches.tagMatch&&t.push("tag"),e.matches.recentlyModified&&t.push("recent"),t.length>0){s.createEl("span",{cls:"suggestion-flair",text:t.join(" â€¢ ")}).title=`Matches: ${t.join(", ")}`}}}renderFileSearchStyle(e,t){let i=e.file.basename;i.endsWith(".md")&&(i=i.slice(0,-3));const s=t.createEl("div",{cls:"suggestion-title"});this.addFileTypeIndicator(s,e.file.path),this.isRecentlyAccessed(e)&&s.createEl("div",{cls:"recent-indicator"}),this.renderSmartPath(s,e.file.path,i);const n=this.app.metadataCache.getFileCache(e.file);if(n?.tags&&n.tags.length>0){const e=t.createEl("div",{cls:"suggestion-note"});n.tags.forEach(t=>{t.tag.trim()&&e.createEl("span",{cls:"tag",text:t.tag})})}}addFileTypeIndicator(e,t){const i=this.getFileExtension(t);if(!i)return;let s="md",n="MD";switch(i.toLowerCase()){case"md":s="md",n="MD";break;case"txt":s="txt",n="TXT";break;case"pdf":s="pdf",n="PDF";break;case"png":case"jpg":case"jpeg":case"gif":case"svg":s="img",n="IMG";break;default:n=i.toUpperCase().substring(0,3)}e.createEl("span",{cls:`file-type-indicator ${s}`,text:n})}getFileExtension(e){const t=e.match(/\.([^.]+)$/);return t?t[1]:null}renderSmartPath(e,t,i){e.textContent=t,e.title=t}renderTruncatedPath(e,t){if(t.length<=60)return void(e.textContent=t);const i=t.split("/");if(i.length>3){const t=i.slice(0,2).join("/"),s=i.slice(-2).join("/");e.innerHTML=`${t}/<span class="path-ellipsis">â€¦</span>/${s}`}else{const i=`${t.substring(0,30)}â€¦${t.substring(t.length-25)}`;e.textContent=i}e.title=t}getDisplayName(e){return e.endsWith(".md")?e.slice(0,-3):e}isRecentlyAccessed(e){return(Date.now()-e.file.stat.mtime)/864e5<1}highlightMatches(e,t){if(!t||t.length<2)return this.escapeHtml(e);const i=this.escapeHtml(e),s=t.toLowerCase().split(/\s+/).filter(e=>e.length>=2);let n=i;for(const e of s){const t=new RegExp(`(${this.escapeRegex(e)})`,"gi");n=n.replace(t,'<span class="snippet-highlight">$1</span>')}return n}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}onChooseSuggestion(e,t){e&&(S.debug("[SemanticSearch] Opening file:",e.file.path),this.app.workspace.openLinkText(e.file.path,"",!1),this.close())}onOpen(){S.debug("[SemanticSearch] Modal opened"),super.onOpen(),this.plugin.settings.semanticSearch.preserveQuery&&this.plugin.lastSemanticQuery&&(this.inputEl.value=this.plugin.lastSemanticQuery,this.inputEl.dispatchEvent(new Event("input",{bubbles:!0})))}onClose(){S.debug("[SemanticSearch] Modal closed"),this.plugin.settings.semanticSearch.preserveQuery&&(this.plugin.lastSemanticQuery=this.inputEl.value),super.onClose(),this.currentResults=[],this.isSearching=!1,this.lastQuery=""}}class Ae{constructor(e,t,i,s={}){this.isInitialized=!1,this.isIndexing=!1,this.app=e,this.embeddingService=t,this.settings=i,this.scheduler=new F(e=>this.processScheduledFiles(e),{throttleMs:6e4,debounceMs:1e4,name:"SemanticIndexing"})}async initialize(){if(S.info("SemanticIndexingCoordinator: Initializing semantic indexing coordination"),!this.isInitialized)try{this.isInitialized=!0}catch(e){throw S.error("Failed to initialize semantic indexing coordinator:",e),e}}async checkForAutoIndexing(){S.debug("[Semantic Search] Checking if auto-indexing is needed...");try{const t=this.embeddingService.getIndexedFileCount();if(S.debug(`[Semantic Search] Currently indexed: ${t} files`),0===t){S.debug("[Semantic Search] No files indexed, checking Ollama connection...");const t=await this.embeddingService.checkConnection();S.debug(`[Semantic Search] Ollama available: ${t}`),t?(S.debug("[Semantic Search] Starting auto-indexing of all files..."),await this.indexAllFiles()):(console.warn("[Semantic Search] Ollama not available, skipping auto-indexing. Make sure Ollama is running."),new e.Notice("Semantic search: Ollama not available. Please start Ollama and reload the plugin."))}else S.debug(`[Semantic Search] ${t} files already indexed, skipping auto-indexing`)}catch(e){console.error("[Semantic Search] Error in auto-indexing check:",e)}}async indexAllFiles(t){if(this.isIndexing)S.debug("Semantic indexing: Indexing already in progress, skipping");else{this.isIndexing=!0,this.onProgressCallback=t;try{S.info("Semantic indexing: Starting coordinated indexing of all files"),await this.embeddingService.indexAllFiles((e,t)=>{e%5!=0&&e!==t||S.debug(`Semantic indexing: Progress ${e}/${t} files`),this.onProgressCallback&&this.onProgressCallback(e,t)});const t=this.embeddingService.getIndexedFileCount();S.info(`Semantic indexing: Completed, ${t} files indexed`),new e.Notice(`âœ… Semantic search: Successfully indexed ${t} files`,3e3)}catch(t){throw S.error("Semantic indexing: Failed:",t),new e.Notice(`âŒ Semantic search indexing failed: ${t.message}`,5e3),t}finally{this.isIndexing=!1,this.onProgressCallback=void 0}}}async indexFile(e){this.isInitialized?this.embeddingService.shouldExcludeFile(e)?S.debug(`Semantic indexing: Skipping excluded file ${e.path}`):this.scheduler.schedule(e.path):S.warn("Semantic indexing: Coordinator not initialized, skipping file indexing")}async processScheduledFiles(t){S.debug(`Semantic indexing: Processing ${t.length} scheduled files`);for(const i of t)try{const t=this.app.vault.getAbstractFileByPath(i);if(!(t instanceof e.TFile)){S.debug(`Semantic indexing: File not found or not a TFile: ${i}`);continue}await this.embeddingService.indexFile(t),S.debug(`Semantic indexing: Successfully indexed ${i}`)}catch(e){S.error(`Semantic indexing: Failed to index file ${i}:`,e)}}async removeFile(e){try{S.debug(`Semantic indexing: Removing file ${e}`),this.embeddingService.removeFromCache(e)}catch(t){throw S.error(`Semantic indexing: Error removing file ${e}:`,t),t}}async handleFileRename(e,t){try{S.debug(`Semantic indexing: Handling file rename from ${e} to ${t}`),this.embeddingService.removeFromCache(e);const i=this.app.vault.getAbstractFileByPath(t);i&&await this.indexFile(i)}catch(i){S.error(`Semantic indexing: Error handling file rename from ${e} to ${t}:`,i)}}async renameFile(e,t){await this.handleFileRename(e,t)}async forceReindexFile(e){try{S.debug(`Semantic indexing: Force reindexing file ${e.path}`),this.embeddingService.removeFromCache(e.path),await this.indexFile(e),S.debug(`Semantic indexing: Successfully force reindexed ${e.path}`)}catch(t){throw S.error(`Semantic indexing: Error force reindexing file ${e.path}:`,t),t}}getStats(){return{indexedFiles:this.embeddingService.getIndexedFileCount(),isIndexing:this.isIndexing,pendingUpdates:this.scheduler.pendingCount}}async clearIndex(){try{S.info("Semantic indexing: Clearing entire index"),this.isIndexing=!1,this.embeddingService.clearCache(),S.info("Semantic indexing: Index cleared successfully")}catch(e){throw S.error("Semantic indexing: Error clearing index:",e),e}}isIndexingInProgress(){return this.isIndexing}async shutdown(){try{S.info("Semantic indexing: Shutting down coordinator"),this.isIndexing=!1,this.scheduler.destroy(),this.embeddingService&&await this.embeddingService.saveCache(),S.info("Semantic indexing: Coordinator shutdown complete")}catch(e){S.error("Semantic indexing: Error during shutdown:",e)}}updateSettings(e){this.settings=e,this.embeddingService.updateSettings(e),S.debug("Semantic indexing: Coordinator settings updated")}}function We(e,t){if(S.debug(`Hybrid fusion: Normalizing ${e.length} keyword results`),0===e.length)return S.debug("Hybrid fusion: No keyword results to normalize"),[];const i=e.map(e=>e.combinedScore),s=Math.max(...i),n=Math.min(...i),a=s-n||1;S.debug(`Hybrid fusion: Keyword score range: ${n.toFixed(4)} - ${s.toFixed(4)}`);const r=e.map((e,i)=>{const s=t.getAbstractFileByPath(e.id);return s||S.debug(`Hybrid fusion: File not found for path: ${e.id}`),{path:e.id,file:s,score:e.combinedScore,normalizedScore:(e.combinedScore-n)/a,rank:i+1,matches:e.matches,metadata:e.metadata,snippet:e.snippet}}).filter(e=>null!==e.file);return S.debug(`Hybrid fusion: Normalized ${r.length} keyword results (${e.length-r.length} filtered out due to missing files)`),r}function Ze(e){if(S.debug(`Hybrid fusion: Normalizing ${e.length} semantic results`),0===e.length)return S.debug("Hybrid fusion: No semantic results to normalize"),[];const t=e.map(e=>e.relevanceScore),i=Math.max(...t),s=Math.min(...t),n=i-s||1;return S.debug(`Hybrid fusion: Semantic score range: ${s.toFixed(4)} - ${i.toFixed(4)}`),e.map((e,t)=>({path:e.file.path,file:e.file,score:e.relevanceScore,normalizedScore:(e.relevanceScore-s)/n,rank:t+1,similarity:e.similarity,excerpt:e.excerpt,matches:e.matches}))}function Ve(e,t,i){return i*(1/(t+e))}function Ne(e,t,i){const{rrfK:s,keywordWeight:n,semanticWeight:a}=i;S.debug(`Hybrid fusion: Merging ${e.length} keyword and ${t.length} semantic results`);const r=new Map,c=new Map;e.forEach(e=>r.set(e.path,e)),t.forEach(e=>c.set(e.path,e));const o=new Set([...e.map(e=>e.path),...t.map(e=>e.path)]);S.debug(`Hybrid fusion: ${o.size} unique files across both result sets`);const h=[];if(o.forEach(e=>{const t=r.get(e),i=c.get(e);let o,d=0;t&&(d+=Ve(t.rank,s,n)),i&&(d+=Ve(i.rank,s,a)),o=t&&i?"both":t?"keyword":"semantic";const l=t?.file||i?.file;l&&h.push({path:e,file:l,fusionScore:d,keywordResult:t,semanticResult:i,source:o})}),h.sort((e,t)=>t.fusionScore-e.fusionScore),h.length>0){const e=h.slice(0,5);S.debug("Hybrid fusion: Top 5 fused results:"),e.forEach((e,t)=>{S.debug(`  ${t+1}. ${e.path} (score: ${e.fusionScore.toFixed(4)}, source: ${e.source})`)})}return h}class He{constructor(e,t,i,s,n){this.linkGraphService=null,this.termFrequencyIndex=null,this.contentCache=new Map,this.vault=e,this.metadataCache=t,this.usageTracker=i,this.settings=s,this.linkGraphService=n??null}setLinkGraphService(e){this.linkGraphService=e}updateSettings(e){this.settings=e}setTermFrequencyIndex(e){this.termFrequencyIndex=e}async reRank(e,t,i){const s=Date.now(),{reRankPoolSize:n,enableReRanking:a}=this.settings;if(!a)return S.debug("Hybrid re-ranker: Re-ranking disabled, using fusion scores only"),this.convertToHybridResults(e,t,!1);const r=e.slice(0,n),c=e.slice(n);this.contentCache.clear(),S.debug(`Hybrid re-ranker: Re-ranking top ${r.length} results`);const o=await Promise.all(r.map(e=>this.computeReRankScore(e,t,i)));o.sort((e,t)=>t.finalScore-e.finalScore);const h=await Promise.all(c.map(e=>this.convertSingleResult(e,t,0))),d=[...o,...h],l=Date.now()-s;return S.debug(`Hybrid re-ranker: Completed in ${l}ms`),d}async computeReRankScore(e,t,i){const{reRankTitleWeight:s,reRankRecencyWeight:n,reRankUsageWeight:a,reRankContentWeight:r,reRankPageRankWeight:c,reRankProximityWeight:o}=this.settings,h=e.file,d=t.toLowerCase(),l=this.computeTitleScore(h,d),u=this.computeRecencyScore(h),g=this.computeUsageScore(h.path),m=await this.computeContentDensityScore(h,d),p=this.computePageRankScore(h.path),f=await this.computeProximityScore(h,d,i),y=this.computeBounceScore(h.path),b=c??.1,x=o??.15,w=this.normalizeWeights(s,n,a,r,b,x),v=w.title*l+w.recency*u+w.usage*g+w.content*m+w.pageRank*p+w.proximity*f-.1*y,k=Math.min(1,30*e.fusionScore),C=Math.max(0,.6*k+.4*v);return S.debug(`Re-ranker: ${h.path} - fusion: ${e.fusionScore.toFixed(4)} -> ${k.toFixed(3)}, boost: ${v.toFixed(3)}, pageRank: ${p.toFixed(3)}, proximity: ${f.toFixed(3)}, bounce: ${y.toFixed(3)}, final: ${C.toFixed(3)}`),this.convertSingleResult(e,t,v,C)}normalizeWeights(e,t,i,s,n,a){const r=e+t+i+s+n+a;return r<=0?{title:1/6,recency:1/6,usage:1/6,content:1/6,pageRank:1/6,proximity:1/6}:{title:e/r,recency:t/r,usage:i/r,content:s/r,pageRank:n/r,proximity:a/r}}computePageRankScore(e){return this.linkGraphService?this.linkGraphService.getPageRankScore(e):0}computeBounceScore(e){return this.usageTracker.getBounceScore(e)}async computeProximityScore(e,t,i){const s=i?.segments||[],n=t.split(/\s+/).filter(e=>e.length>2);if(n.length<=1)return.5;try{const t=(await this.getFileContent(e)).toLowerCase(),i=new Map;for(const e of n){const s=[];let n=t.indexOf(e);for(;-1!==n;)s.push(n),n=t.indexOf(e,n+1);s.length>0&&i.set(e,s)}if(i.size<n.length){return.3*(i.size/n.length)}if(s.length>0&&s.some(e=>e.isPhrase))return this.computeSegmentAwareProximity(t,s,i);const a=this.findMinimumSpan(i,n);if(a===1/0)return 0;const r=a/(n.reduce((e,t)=>e+t.length,0)+(n.length-1)),c=1/(1+Math.log(Math.max(1,r)));return Math.min(1,Math.max(0,c))}catch{return 0}}computeSegmentAwareProximity(e,t,i){let s=0,n=0;for(const a of t){if(!a.isPhrase){i.has(a.text)&&(s+=1,n++);continue}if(-1!==e.indexOf(a.text))s+=1;else{const e=a.text.split(/\s+/).filter(e=>e.length>2);if(e.length>1){const t=new Map;for(const s of e){const e=i.get(s);e&&t.set(s,e)}if(t.size===e.length){const i=this.findMinimumSpan(t,e)/(e.reduce((e,t)=>e+t.length,0)+(e.length-1));s+=1/(1+Math.log(Math.max(1,i)))}else{s+=.3*(t.size/e.length)}}}n++}return 0===n?.5:Math.min(1,Math.max(0,s/n))}findMinimumSpan(e,t){const i=[];for(const s of t){const t=e.get(s);if(t)for(const e of t)i.push({pos:e,term:s,endPos:e+s.length})}if(0===i.length)return 1/0;i.sort((e,t)=>e.pos-t.pos);const s=new Map;let n=0;const a=t.length;let r=1/0,c=0;for(let e=0;e<i.length;e++){const t=i[e],o=s.get(t.term)||0;for(0===o&&n++,s.set(t.term,o+1);n===a&&c<=e;){const t=i[e].endPos-i[c].pos;r=Math.min(r,t);const a=i[c],o=s.get(a.term)||0;s.set(a.term,o-1),o-1==0&&n--,c++}}return r}computeTitleScore(e,t){const i=e.basename.toLowerCase();if(i===t)return 1;if(i.startsWith(t))return.8;if(i.includes(t))return.6;const s=t.split(/\s+/).filter(e=>e.length>2),n=s.filter(e=>i.includes(e));return n.length>0?n.length/s.length*.4:0}computeRecencyScore(e){const t=this.usageTracker.getRecencyScore(e.path);return 0===t?0:t>=.1?t:0}computeUsageScore(e){const t=this.usageTracker.getUsageScore(e);return Math.min(t/100,1)}async getFileContent(e){const t=this.contentCache.get(e.path);if(void 0!==t)return t;const i=await this.vault.cachedRead(e);return this.contentCache.set(e.path,i),i}async computeContentDensityScore(e,t){try{const i=(await this.getFileContent(e)).toLowerCase(),s=t.split(/\s+/).filter(e=>e.length>2);if(0===s.length)return 0;const n=this.termFrequencyIndex?.getTermWeights(s)??new Map(s.map(e=>[e,1/s.length]));let a=0,r=0;for(const e of s){const t=n.get(e)??1/s.length;r+=t;const c=new RegExp(e,"gi"),o=i.match(c);if(o&&o.length>0){a+=t*Math.min(o.length/5,1)}}return r>0?a/r:0}catch{return 0}}buildMatchDetails(e,t){const i=t.toLowerCase(),s=e.file,n=s.basename.toLowerCase().includes(i),a=this.metadataCache.getFileCache(s),r=a?.tags?.some(e=>e.tag.toLowerCase().includes(i))||!1,c=Date.now()-s.stat.mtime<6048e5,o=[];e.keywordResult?.matches&&Object.values(e.keywordResult.matches).forEach(e=>{o.push(...e)});const h=this.buildMatchReason(e,n,r);return{titleMatch:n,tagMatch:r,recentlyModified:c,keywordMatches:[...new Set(o)].slice(0,5),semanticSimilarity:e.semanticResult?.similarity,matchReason:h}}buildMatchReason(e,t,i){const s=[];return"both"===e.source?s.push("Matched by keywords and meaning"):"keyword"===e.source?s.push("Matched by keywords"):s.push("Matched by meaning"),t&&s.push("title matches"),i&&s.push("tag matches"),e.semanticResult?.similarity&&e.semanticResult.similarity>.7&&s.push("highly relevant content"),s.join(" â€¢ ")}async convertToHybridResults(e,t,i){return Promise.all(e.map(e=>{const i=Math.min(1,30*e.fusionScore);return this.convertSingleResult(e,t,0,i)}))}async convertSingleResult(e,t,i,s){const n=e.file;let a=e.semanticResult?.excerpt||e.keywordResult?.snippet||"";a||(a=await this.generateExcerpt(n,t));const r=this.buildMatchDetails(e,t),c=s??Math.min(1,30*e.fusionScore);return{file:n,path:e.path,title:n.basename,excerpt:a,finalScore:c,keywordScore:e.keywordResult?.normalizedScore??0,semanticScore:e.semanticResult?.normalizedScore??0,fusionScore:e.fusionScore,reRankBoost:i,source:e.source,keywordRank:e.keywordResult?.rank,semanticRank:e.semanticResult?.rank,matches:r,metadata:e.keywordResult?.metadata,lastModified:n.stat.mtime}}async generateExcerpt(e,t,i=150){try{const s=await this.vault.cachedRead(e),n=t.toLowerCase().split(/\s+/).filter(e=>e.length>2),a=s.split(/[.!?]+/).map(e=>e.trim()).filter(e=>e.length>0);for(const e of a){const t=e.toLowerCase();if(n.some(e=>t.includes(e)))return e.length>i?`${e.substring(0,i)}...`:e}const r=s.substring(0,i).trim();return r?`${r}...`:"No preview available"}catch{return"Could not load preview"}}}class Xe{constructor(){this.phraseLexicon=new Set,this.phrasesByFirstWord=new Map,this.maxPhraseLength=0,this.isBuilt=!1}async buildLexicon(e){const t=Date.now();this.phraseLexicon.clear(),this.phrasesByFirstWord.clear();const i=e.vault.getMarkdownFiles();for(const t of i){this.addPhraseIfMultiWord(t.basename);const i=e.metadataCache.getFileCache(t);if(i){if(i.frontmatter?.aliases){const e=Array.isArray(i.frontmatter.aliases)?i.frontmatter.aliases:[i.frontmatter.aliases];for(const t of e)"string"==typeof t&&this.addPhraseIfMultiWord(t)}if(i.links)for(const e of i.links)e.displayText&&e.displayText!==e.link&&this.addPhraseIfMultiWord(e.displayText),this.addPhraseIfMultiWord(e.link);if(i.headings)for(const e of i.headings)this.addPhraseIfMultiWord(e.heading)}}this.buildFirstWordIndex(),this.isBuilt=!0;const s=Date.now()-t;S.debug(`[QuerySegmenter] Built lexicon with ${this.phraseLexicon.size} phrases from ${i.length} files in ${s}ms`)}addPhraseIfMultiWord(e){if(!e)return;const t=this.normalizePhrase(e),i=t.split(/\s+/).filter(e=>e.length>0);i.length>=2&&(this.phraseLexicon.add(t),this.maxPhraseLength=Math.max(this.maxPhraseLength,i.length))}normalizePhrase(e){return e.toLowerCase().replace(/[^\p{L}\p{N}\s'-]/gu," ").replace(/\s+/g," ").trim()}buildFirstWordIndex(){this.phrasesByFirstWord.clear();for(const e of this.phraseLexicon){const t=e.split(/\s+/)[0];if(t){const i=this.phrasesByFirstWord.get(t)||[];i.push(e),this.phrasesByFirstWord.set(t,i)}}for(const[e,t]of this.phrasesByFirstWord)t.sort((e,t)=>t.length-e.length),this.phrasesByFirstWord.set(e,t)}segmentQuery(e){const t=this.normalizePhrase(e).split(/\s+/).filter(e=>e.length>0);if(0===t.length)return{original:e,segments:[],terms:[]};const i=[];let s=0,n=0;for(;s<t.length;){const e=t[s];let a=null,r=1;if(this.isBuilt){const i=this.phrasesByFirstWord.get(e)||[];for(const e of i){const i=e.split(/\s+/);if(s+i.length<=t.length){let n=!0;for(let e=0;e<i.length;e++)if(t[s+e]!==i[e]){n=!1;break}if(n){a=e,r=i.length;break}}}}const c=t.slice(s,s+r).join(" "),o=n,h=n+c.length;i.push({text:c,isPhrase:null!==a,startIndex:o,endIndex:h}),n=h+1,s+=r}return{original:e,segments:i,terms:t}}getLexiconSize(){return this.phraseLexicon.size}isReady(){return this.isBuilt}clear(){this.phraseLexicon.clear(),this.phrasesByFirstWord.clear(),this.maxPhraseLength=0,this.isBuilt=!1}}const Ge=/(\w+):(>=|<=|>|<|~|-)?("[^"]+"|'[^']+'|[^\s]+)/g;function Oe(e){switch(e){case">=":return"gte";case"<=":return"lte";case">":return"gt";case"<":return"lt";case"~":return"contains";case"-":return"neq";default:return"eq"}}function Ue(e){let t=e;(t.startsWith('"')&&t.endsWith('"')||t.startsWith("'")&&t.endsWith("'"))&&(t=t.slice(1,-1));const i=parseFloat(t);return!isNaN(i)&&isFinite(i)?i:t}function Ke(e){const t=[];let i,s=e;for(Ge.lastIndex=0;null!==(i=Ge.exec(e));){const[e,s,n,a]=i,r={field:s.toLowerCase(),operator:Oe(n),value:Ue(a),rawValue:a,rawMatch:e};t.push(r),S.debug("Query filter parsed:",r)}for(const e of t)s=s.replace(e.rawMatch,"");return s=s.replace(/\s+/g," ").trim(),t.length>0&&S.debug(`Parsed ${t.length} filters from query. Remaining text query: "${s}"`),{textQuery:s,filters:t}}function _e(e,t){if(!t)return!1;const i=t[e.field];if(null==i)return"neq"===e.operator;const s=e.value;switch(e.operator){case"eq":return Be(i,s);case"neq":return!Be(i,s);case"gt":return Ye(i,s,(e,t)=>e>t);case"lt":return Ye(i,s,(e,t)=>e<t);case"gte":return Ye(i,s,(e,t)=>e>=t);case"lte":return Ye(i,s,(e,t)=>e<=t);case"contains":return qe(i,s);default:return S.warn(`Unknown filter operator: ${e.operator}`),!1}}function Be(e,t){if(Array.isArray(e))return e.some(e=>Be(e,t));if("number"==typeof e&&"number"==typeof t)return e===t;if("boolean"==typeof e){const i=String(t).toLowerCase();return!0===e&&("true"===i||"1"===i)||!1===e&&("false"===i||"0"===i)}return String(e).toLowerCase()===String(t).toLowerCase()}function Ye(e,t,i){const s="number"==typeof e?e:parseFloat(String(e)),n="number"==typeof t?t:parseFloat(String(t));if(!isNaN(s)&&!isNaN(n))return i(s,n);const a=je(e),r=je(t);return null!==a&&null!==r?i(a,r):(S.debug(`Falling back to string comparison for filter value: ${t}`),i(String(e).localeCompare(String(t)),0))}function je(e){if(e instanceof Date)return e.getTime();if("string"==typeof e){const t=e.match(/^(\d{4})(?:-(\d{2}))?(?:-(\d{2}))?$/);if(t){const[,e,i="01",s="01"]=t,n=Date.parse(`${e}-${i}-${s}`);if(!isNaN(n))return n}const i=Date.parse(e);if(!isNaN(i))return i}if("number"==typeof e){if(e>=1900&&e<=2100)return Date.parse(`${e}-01-01`);if(e>1e10)return e}return null}function qe(e,t){if(Array.isArray(e))return e.some(e=>qe(e,t));const i=String(e).toLowerCase(),s=String(t).toLowerCase();return i.includes(s)}function Je(e,t){return 0===e.length||e.every(e=>_e(e,t))}function Qe(e,t){const i=t.getFileCache(e);return i?.frontmatter}function et(e,t,i){if(0===e.length||0===t.length)return 0;let s=0;for(const n of e)for(const e of t){const t=i.cosineSimilarity(n.embedding,e.embedding);t>s&&(s=t)}return s}function tt(e,t,i){if(!i.enableClustering||!t)return e.map(e=>({...e}));if(e.length<=1)return e.map(e=>({...e}));const s=function(e,t,i=.85){if(0===e.length)return[];const s=[],n=new Set,a=new Map;for(const i of e){const e=t.getChunkEmbeddings(i.path);e&&e.length>0&&a.set(i.path,e)}S.debug(`Result clustering: Processing ${e.length} results, ${a.size} have embeddings`);for(const r of e){if(n.has(r.path))continue;const e=a.get(r.path);if(!e){s.push({primary:r,related:[],clusterId:`cluster-${s.length}`}),n.add(r.path);continue}let c=null;for(const n of s){const s=a.get(n.primary.path);if(!s)continue;const o=et(e,s,t);if(o>=i){c=n,S.debug(`Result clustering: ${r.path} similar to ${n.primary.path} (${(100*o).toFixed(1)}%)`);break}}c?(c.related.push(r),n.add(r.path)):(s.push({primary:r,related:[],clusterId:`cluster-${s.length}`}),n.add(r.path))}const r=s.filter(e=>e.related.length>0);return S.debug(`Result clustering: Created ${s.length} clusters, ${r.length} have multiple results`),s}(e,t,i.clusterSimilarityThreshold);return function(e){const t=[];for(const i of e){const e=1+i.related.length;t.push({...i.primary,clusterId:i.clusterId,isClusterPrimary:!0,clusterSize:e})}return t}(s)}class it{constructor(e,t,i,s,n,a){this.linkGraphService=null,this.isInitialized=!1,this.searchCache=new Map,this.CACHE_TTL_MS=3e4,this.app=e,this.keywordSearch=t,this.semanticSearch=i,this.usageTracker=s,this.linkGraphService=a??null,this.settings={...I,...n},this.reRanker=new He(e.vault,e.metadataCache,s,this.settings,this.linkGraphService??void 0);const r=this.keywordSearch.getTermFrequencyIndex();this.reRanker.setTermFrequencyIndex(r),this.querySegmenter=new Xe,S.debug("HybridSearchService: Initialized")}setLinkGraphService(e){this.linkGraphService=e,this.reRanker.setLinkGraphService(e),S.debug("HybridSearchService: LinkGraphService set")}async initialize(){this.isInitialized||(S.debug("HybridSearchService: Starting initialization..."),this.keywordSearch.isReady()||S.warn("HybridSearchService: Keyword search not ready, hybrid search may be limited"),this.semanticSearch||S.debug("HybridSearchService: No semantic search engine provided, will use keyword-only mode"),this.linkGraphService&&(await this.linkGraphService.recompute(),S.debug("HybridSearchService: Link graph initialized")),await this.querySegmenter.buildLexicon(this.app),S.debug(`HybridSearchService: Query segmenter ready with ${this.querySegmenter.getLexiconSize()} phrases`),this.isInitialized=!0,S.debug("HybridSearchService: Initialization complete"))}isReady(){return this.isInitialized}hasSemanticSearch(){return null!==this.semanticSearch}updateSettings(e){this.settings={...this.settings,...e},this.reRanker.updateSettings(this.settings),this.clearCache(),S.debug("HybridSearchService: Settings updated")}setSemanticSearch(e){this.semanticSearch=e,this.clearCache(),S.debug("HybridSearchService: Semantic search "+(e?"enabled":"disabled"))}async search(e,t={}){const i=Date.now(),{limit:s=this.settings.maxResults,threshold:n=this.settings.minScoreThreshold,semanticOnly:a=!1,keywordOnly:r=!1,signal:c}=t,{textQuery:o,filters:h}=Ke(e.trim());if((!o||o.length<2)&&0===h.length)return S.debug("HybridSearchService: Query too short and no filters"),[];const d=o||"*";S.debug(`HybridSearchService: Searching for "${d}" with ${h.length} filters (limit: ${s})`);const l=`${d}:${s}:${a}:${r}:${h.map(e=>`${e.field}${e.operator}${e.value}`).join(",")}`,u=this.getFromCache(l);if(u)return S.debug("HybridSearchService: Returning cached results"),u;if(c?.aborted)return[];try{const e=o&&o.length>=2,[t,u]=await Promise.all([e?this.runKeywordSearch(d,s,a,c):Promise.resolve([]),e?this.runSemanticSearch(d,s,r,c):Promise.resolve([])]);if(c?.aborted)return[];S.debug(`HybridSearchService: Got ${t.length} keyword and ${u.length} semantic results`);const g=We(t,this.app.vault),m=Ze(u);S.debug(`HybridSearchService: Normalized ${g.length} keyword and ${m.length} semantic results`);const p=Ne(g,m,this.settings);S.debug(`HybridSearchService: Fused into ${p.length} results`),p.length>0&&S.debug("HybridSearchService: Top fused result:",{path:p[0].file.path,fusionScore:p[0].fusionScore});const f=this.querySegmenter.segmentQuery(d),y=await this.reRanker.reRank(p,d,f);S.debug(`HybridSearchService: Re-ranked ${y.length} results`),y.length>0&&S.debug("HybridSearchService: Top re-ranked result:",{path:y[0].file.path,finalScore:y[0].finalScore}),S.debug(`HybridSearchService: Filtering with threshold ${n} and ${h.length} frontmatter filters`);const b=y.filter(e=>{if(!(e.finalScore>=n))return S.debug(`HybridSearchService: Filtered out ${e.file.path} (score ${e.finalScore} < ${n})`),!1;if(h.length>0){const t=Qe(e.file,this.app.metadataCache);if(!Je(h,t))return S.debug(`HybridSearchService: Filtered out ${e.file.path} (failed frontmatter filters)`),!1}return!0}).slice(0,s),x=tt(b,this.semanticSearch?.getEmbeddingService()??null,this.settings);this.addToCache(l,x),this.usageTracker.recordSearch(d);const w=Date.now()-i;return S.debug(`HybridSearchService: Search completed in ${w}ms, returning ${x.length} results`),x}catch(e){throw S.error("HybridSearchService: Search failed",e),e}}async searchStream(e,t){const i=Date.now(),{limit:s=this.settings.maxResults,threshold:n=this.settings.minScoreThreshold,semanticOnly:a=!1,keywordOnly:r=!1,signal:c,onUpdate:o}=t,{textQuery:h,filters:d}=Ke(e.trim());if((!h||h.length<2)&&0===d.length)return S.debug("HybridSearchService: Query too short and no filters"),void o([],"complete");const l=h||"*";S.debug(`HybridSearchService: Stream searching for "${l}" with ${d.length} filters (limit: ${s})`);const u=`${l}:${s}:${a}:${r}:${d.map(e=>`${e.field}${e.operator}${e.value}`).join(",")}`,g=this.getFromCache(u);if(g)return S.debug("HybridSearchService: Returning cached results"),void o(g,"complete");if(c?.aborted)o([],"complete");else try{let e=[],t=[],g=!1;const m=h&&h.length>=2,p=m?this.runKeywordSearch(l,s,a,c).then(t=>(e=t,t)):Promise.resolve([]),f=m?this.runSemanticSearch(l,s,r,c).then(e=>(t=e,g=!0,e)):Promise.resolve([]).then(()=>(g=!0,[]));if(await p,c?.aborted)return void o([],"complete");if(!g&&e.length>0&&!a){const t=Date.now()-i;S.debug(`HybridSearchService: Keyword results ready in ${t}ms, emitting phase: keyword`);const a=Ne(We(e,this.app.vault),[],this.settings),r=this.querySegmenter.segmentQuery(l),c=(await this.reRanker.reRank(a,l,r)).filter(e=>{if(!(e.finalScore>=n))return!1;if(d.length>0){const t=Qe(e.file,this.app.metadataCache);if(!Je(d,t))return!1}return!0}).slice(0,s);c.length>0&&o(c,"keyword")}if(await f,c?.aborted)return;S.debug(`HybridSearchService: Got ${e.length} keyword and ${t.length} semantic results`);const y=We(e,this.app.vault),b=Ne(y,Ze(t),this.settings),x=this.querySegmenter.segmentQuery(l),w=(await this.reRanker.reRank(b,l,x)).filter(e=>{if(!(e.finalScore>=n))return!1;if(d.length>0){const t=Qe(e.file,this.app.metadataCache);if(!Je(d,t))return!1}return!0}).slice(0,s),v=tt(w,this.semanticSearch?.getEmbeddingService()??null,this.settings);this.addToCache(u,v),this.usageTracker.recordSearch(l);const k=Date.now()-i;S.debug(`HybridSearchService: Stream search completed in ${k}ms, returning ${v.length} results (phase: complete)`),o(v,"complete")}catch(e){S.error("HybridSearchService: Stream search failed",e),o([],"complete")}}async runKeywordSearch(e,t,i,s){if(S.debug(`HybridSearchService: runKeywordSearch called (skip=${i}, keywordReady=${this.keywordSearch.isReady()})`),i)return S.debug("HybridSearchService: Skipping keyword search (semanticOnly mode)"),[];if(!this.keywordSearch.isReady())return S.warn("HybridSearchService: Keyword search not ready"),[];if(s?.aborted)return S.debug("HybridSearchService: Keyword search aborted"),[];try{S.debug(`HybridSearchService: Running keyword search for "${e}" with limit ${2*t}`);const i=await this.keywordSearch.search(e,2*t);return S.debug(`HybridSearchService: Keyword search returned ${i.length} results`),i}catch(e){return S.error("HybridSearchService: Keyword search failed",e),[]}}async runSemanticSearch(e,t,i,s){if(S.debug(`HybridSearchService: runSemanticSearch called (skip=${i}, hasSemanticEngine=${!!this.semanticSearch})`),i)return S.debug("HybridSearchService: Skipping semantic search (keywordOnly mode)"),[];if(!this.semanticSearch)return S.debug("HybridSearchService: No semantic search engine available"),[];if(s?.aborted)return S.debug("HybridSearchService: Semantic search aborted"),[];try{S.debug(`HybridSearchService: Running semantic search for "${e}" with limit ${2*t}`);const i=await this.semanticSearch.search(e,{limit:2*t,useCache:!0,signal:s});return S.debug(`HybridSearchService: Semantic search returned ${i.length} results`),i}catch(e){return S.error("HybridSearchService: Semantic search failed",e),[]}}getFromCache(e){const t=this.searchCache.get(e);return t?Date.now()-t.timestamp>this.CACHE_TTL_MS?(this.searchCache.delete(e),null):t.results:null}addToCache(e,t){if(this.searchCache.set(e,{results:t,timestamp:Date.now()}),this.searchCache.size>50){const e=this.searchCache.keys().next().value;e&&this.searchCache.delete(e)}}clearCache(){this.searchCache.clear(),S.debug("HybridSearchService: Cache cleared")}recordSelection(e,t){this.usageTracker.recordSearch(e,t),this.usageTracker.recordFileOpen(t)}getStats(){return{isReady:this.isInitialized,hasSemanticSearch:null!==this.semanticSearch,cacheSize:this.searchCache.size,settings:this.settings}}destroy(){this.clearCache(),this.isInitialized=!1,S.debug("HybridSearchService: Destroyed")}}class st extends e.SuggestModal{constructor(e,t,i,s,n){super(e),this.isSearching=!1,this.currentResults=[],this.lastQuery="",this.allFiles=[],this.isInitialLoad=!0,this.hasPerformedInitialSearch=!1,this.initialSearchResults=[],this.plugin=t,this.selectedText=i,this.sourceFile=s,this.editor=n,this.modalEl.addClass("better-command-palette"),this.modalEl.addClass("quick-link-modal"),this.modalEl.setAttribute("palette-mode","quick-link");const a=t.settings.quickLink.searchEngine,r="semantic"===a?"ðŸ§  Semantic":"hybrid"===a?"âš¡ Hybrid":"ðŸ” Enhanced";this.modalEl.setAttribute("search-engine",a),this.setPlaceholder(`${r} | Showing results for "${this.truncateText(i,25)}" (or type to search)`),this.setInstructions([{command:"â†‘â†“",purpose:"Navigate"},{command:"â†µ",purpose:"Create link"},{command:"Ctrl+â†µ",purpose:"Create new file and link"},{command:"esc",purpose:"Cancel"}]),this.initializeFiles()}initializeFiles(){this.allFiles=[];try{const t=this.app.metadataCache.getCachedFiles();for(const i of t){if(!i||"string"!=typeof i)continue;if(this.plugin.settings.fileTypeExclusion.some(e=>i.endsWith(`.${e}`)))continue;const t=this.app.vault.getAbstractFileByPath(i);t instanceof e.TFile&&this.allFiles.push({id:t.path,text:t.basename,file:t,isUnresolved:!1})}const i=this.app.metadataCache.unresolvedLinks[this.sourceFile.path];i&&"object"==typeof i&&Object.keys(i).forEach(e=>{e&&"string"==typeof e&&e.trim()&&this.allFiles.push({id:e,text:e,file:null,isUnresolved:!0})});const s=new Set(this.app.workspace.getLastOpenFiles());this.allFiles.sort((e,t)=>{const i=e.file&&s.has(e.file.path),n=t.file&&s.has(t.file.path);return i&&!n?-1:!i&&n?1:e.text.localeCompare(t.text)})}catch(e){S.error("[QuickLink] Error initializing files:",e)}}getSuggestions(e){return!this.isInitialLoad||e&&0!==e.length||this.hasPerformedInitialSearch?(e&&e.length>0&&(this.isInitialLoad=!1),e&&0!==e.length?e!==this.lastQuery||this.isSearching?(this.performSearch(e),this.currentResults):this.currentResults:this.initialSearchResults.length>0?this.initialSearchResults:this.getRecentFiles()):(this.hasPerformedInitialSearch=!0,this.performInitialSearch(),this.getRecentFiles())}async performInitialSearch(){if(!this.selectedText||0===this.selectedText.trim().length)return;const t=this.selectedText.trim();S.debug("[QuickLink] Performing initial search with selected text:",t);try{const i=await this.performEngineSearch(t,50);if(i.length>0){this.isSearching=!0;const t=i.filter(e=>e.path!==this.sourceFile.path).map(t=>{const i=this.app.vault.getAbstractFileByPath(t.path);return{id:t.path,text:i instanceof e.TFile?i.basename:t.path,file:i instanceof e.TFile?i:null,isUnresolved:!1}});return this.initialSearchResults=t,this.isInitialLoad&&(this.currentResults=t),this.isSearching=!1,void(this.inputEl&&""===this.inputEl.value&&this.inputEl.dispatchEvent(new Event("input",{bubbles:!0})))}}catch(e){S.warn("[QuickLink] Engine search failed in initial search, falling back to fuzzy search:",e),this.isSearching=!1}const i=t.toLowerCase(),s=this.allFiles.filter(e=>e.file?.path!==this.sourceFile.path&&e.text.toLowerCase().includes(i)).slice(0,50);this.initialSearchResults=s,this.isInitialLoad&&(this.currentResults=s)}async performEngineSearch(e,t){const i=this.plugin.settings.quickLink.searchEngine;switch(S.debug(`[QuickLink] Using search engine: ${i}`),i){case"semantic":{const i=this.plugin.getSemanticSearchEngine();if(i){return(await i.search(e)).slice(0,t).map(e=>({path:e.file.path,score:e.similarity}))}S.warn("[QuickLink] Semantic engine not available, falling back to enhanced")}case"hybrid":if("hybrid"===i&&this.plugin.hybridSearchService?.isReady()){return(await this.plugin.hybridSearchService.search(e,{limit:t})).map(e=>({path:e.path,score:e.finalScore}))}"hybrid"===i&&S.warn("[QuickLink] Hybrid engine not ready, falling back to enhanced");default:if(this.plugin.searchService){return(await this.plugin.searchService.search(e,t)).map(e=>({path:e.metadata.path,score:e.score}))}return[]}}getRecentFiles(){const t=this.app.workspace.getLastOpenFiles().slice(0,10),i=[];for(const s of t){const t=this.app.vault.getAbstractFileByPath(s);t instanceof e.TFile&&s!==this.sourceFile.path&&i.push({id:t.path,text:t.basename,file:t,isUnresolved:!1})}return i}async performSearch(t){this.lastQuery=t;const i=t.toLowerCase();try{const i=await this.performEngineSearch(t,50);if(i.length>0)return this.isSearching=!0,this.currentResults=i.filter(e=>e.path!==this.sourceFile.path).map(t=>{const i=this.app.vault.getAbstractFileByPath(t.path);return{id:t.path,text:i instanceof e.TFile?i.basename:t.path,file:i instanceof e.TFile?i:null,isUnresolved:!1}}),this.isSearching=!1,void(this.inputEl&&this.inputEl.value===t&&this.inputEl.dispatchEvent(new Event("input",{bubbles:!0})))}catch(e){S.warn("[QuickLink] Engine search failed, falling back to fuzzy search:",e),this.isSearching=!1}this.currentResults=this.allFiles.filter(e=>e.file?.path!==this.sourceFile.path&&e.text.toLowerCase().includes(i)).slice(0,50)}renderSuggestion(e,t){this.renderFileSearchStyle(e,t)}renderFileSearchStyle(t,i){let s=t.text;this.plugin.settings.displayOnlyNotesNames&&(s=t.text.split("/").pop()||t.text),this.plugin.settings.hideMdExtension&&s.endsWith(".md")&&(s=s.slice(0,-3));const n=i.createEl("div",{cls:"suggestion-title"});if(t.file)this.addFileTypeIndicator(n,t.file.path);else{const t=n.createDiv({cls:"file-type-indicator unresolved"});e.setIcon(t,"link")}if(t.file&&this.isRecentlyAccessed(t)&&n.createEl("div",{cls:"recent-indicator"}),!this.plugin.settings.displayOnlyNotesNames&&t.file&&t.file.path.includes("/")?this.renderSmartPath(n,t.file.path,s):n.createEl("span",{cls:"path-part filename",text:s}),t.isUnresolved&&n.addClass("unresolved"),t.id.includes(":")){n.createEl("span",{cls:"suggestion-name",text:t.text}).ariaLabel="Alias",e.setIcon(n,"right-arrow-with-tail");const[,i]=t.id.split(":");n.createEl("span",{cls:"suggestion-note",text:i})}}addFileTypeIndicator(t,i){const s=t.createDiv({cls:"file-type-indicator"});let n="document";switch(this.getFileExtension(i)){case"md":n="document";break;case"pdf":n="file-text";break;case"png":case"jpg":case"jpeg":case"gif":case"svg":n="image";break;default:n="file"}e.setIcon(s,n)}getFileExtension(e){const t=e.match(/\.([^.]+)$/);return t?t[1].toLowerCase():null}renderSmartPath(e,t,i){if(!t.includes("/"))return void e.createEl("span",{cls:"path-part filename",text:i});const s=t.split("/"),n=s.pop()||i;if(s.length>0){const t=s.join("/");e.createEl("span",{cls:"path-part folder",text:`${t}/`})}e.createEl("span",{cls:"path-part filename",text:this.plugin.settings.hideMdExtension&&n.endsWith(".md")?n.slice(0,-3):n})}isRecentlyAccessed(e){if(!e.file)return!1;return this.app.workspace.getLastOpenFiles().includes(e.file.path)}onChooseSuggestion(e,t){if(!e)return;t&&t.ctrlKey&&e.isUnresolved?this.createNewFileAndLink(e.text):this.createLink(e)}createLink(t){try{let i;i=t.file?this.app.fileManager.generateMarkdownLink(t.file,this.sourceFile.path,"#",this.selectedText):`[[${t.text}|${this.selectedText}]]`,this.editor.replaceSelection(i),new e.Notice(`Created link: ${i}`,3e3),S.info("[QuickLink] Created link:",i),this.plugin.settings.quickLink.autoCloseModal&&this.close()}catch(t){S.error("[QuickLink] Error creating link:",t),new e.Notice("Failed to create link")}}async createNewFileAndLink(t){try{t.endsWith(".md")||(t+=".md");const i=await this.app.vault.create(t,""),s=this.app.fileManager.generateMarkdownLink(i,this.sourceFile.path,"#",this.selectedText);this.editor.replaceSelection(s),new e.Notice(`Created new file and link: ${s}`,3e3),S.info("[QuickLink] Created new file and link:",s),this.plugin.settings.quickLink.autoCloseModal&&this.close()}catch(t){S.error("[QuickLink] Error creating new file and link:",t),new e.Notice("Failed to create new file and link")}}truncateText(e,t){return e.length<=t?e:`${e.substring(0,t)}...`}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}onOpen(){super.onOpen(),S.debug("[QuickLink] Modal opened for selected text:",this.selectedText)}onClose(){super.onClose(),S.debug("[QuickLink] Modal closed")}}class nt extends e.Plugin{constructor(){super(...arguments),this.lastSemanticQuery="",this.lastFileQuery=""}async onload(){S.setLogLevel(m.DEBUG),S.info("Loading plugin: Better Command Palette"),await this.loadSettings(),this.prevCommands=new n,this.prevTags=new n,this.suggestionsWorker=new s({}),this.searchService=new Re(this.app,this.settings.enhancedSearch),this.usageTracker=new Ee,this.linkGraphService=new M(this.app,this.settings.linkGraph),this.registerLinkGraphEvents(),this.app.workspace.layoutReady?(S.debug("Workspace layout already ready, initializing search services immediately"),this.linkGraphService.recompute().catch(e=>{S.error("Failed to compute link graph:",e)}),this.searchService.initialize().catch(e=>{S.error("Failed to initialize enhanced search service:",e)}),this.settings.semanticSearch.enableSemanticSearch?(S.debug("Semantic search enabled, initializing immediately"),this.initializeSemanticSearch().then(()=>{this.initializeHybridSearch()}).catch(e=>{S.error("Failed to initialize semantic search:",e),this.initializeHybridSearch()})):this.initializeHybridSearch()):(S.debug("Workspace layout not ready, waiting for layout-ready event before initializing search services"),this.app.workspace.onLayoutReady(()=>{S.debug("Workspace layout ready event received, initializing search services"),this.linkGraphService.recompute().catch(e=>{S.error("Failed to compute link graph:",e)}),this.searchService.initialize().catch(e=>{S.error("Failed to initialize enhanced search service:",e)}),this.settings.semanticSearch.enableSemanticSearch?(S.debug("Semantic search enabled, initializing after workspace ready"),this.initializeSemanticSearch().then(()=>{this.initializeHybridSearch()}).catch(e=>{S.error("Failed to initialize semantic search:",e),this.initializeHybridSearch()})):this.initializeHybridSearch()})),this.addCommand({id:"open-better-command-palette",name:"Open better command palette",hotkeys:[{modifiers:["Mod","Shift"],key:"p"}],callback:()=>{new C(this.app,this.prevCommands,this.prevTags,this,this.suggestionsWorker,this.searchService,this.hybridSearchService).open()}}),this.addCommand({id:"open-better-command-palette-file-search",name:"Open better command palette: File Search",hotkeys:[],callback:()=>{new C(this.app,this.prevCommands,this.prevTags,this,this.suggestionsWorker,this.searchService,this.hybridSearchService,this.settings.fileSearchPrefix).open()}}),this.addCommand({id:"open-better-command-palette-tag-search",name:"Open better command palette: Tag Search",hotkeys:[],callback:()=>{new C(this.app,this.prevCommands,this.prevTags,this,this.suggestionsWorker,this.searchService,this.hybridSearchService,this.settings.tagSearchPrefix).open()}}),this.addCommand({id:"trigger-enhanced-search-indexing",name:"Enhanced Search: Trigger Manual Indexing",callback:async()=>{this.searchService&&await this.searchService.triggerVaultIndexing()}}),this.addCommand({id:"pause-enhanced-search-indexing",name:"Enhanced Search: Pause Indexing",callback:()=>{this.searchService&&(this.searchService.pauseIndexing(),new e.Notice("Enhanced search indexing paused"))}}),this.addCommand({id:"resume-enhanced-search-indexing",name:"Enhanced Search: Resume Indexing",callback:()=>{this.searchService&&(this.searchService.resumeIndexing(),new e.Notice("Enhanced search indexing resumed"))}}),this.addCommand({id:"open-semantic-search",name:"Open semantic search",hotkeys:[{modifiers:["Mod","Alt"],key:"s"}],callback:()=>{this.settings.semanticSearch.enableSemanticSearch&&this.semanticSearchEngine?new Pe(this.app,this).open():new e.Notice("Semantic search is not enabled or not initialized")}}),this.addCommand({id:"open-hybrid-search",name:"Open hybrid search (keyword + semantic)",hotkeys:[{modifiers:["Mod","Shift"],key:this.settings.hybridSearch.searchHotkey}],callback:()=>{this.settings.hybridSearch.enabled&&this.hybridSearchService?.isReady()?new C(this.app,this.prevCommands,this.prevTags,this,this.suggestionsWorker,this.searchService,this.hybridSearchService,"",g.Hybrid).open():new e.Notice("Hybrid search is not enabled or not initialized")}}),this.addCommand({id:"reindex-semantic-search",name:"Reindex semantic search",callback:async()=>{await this.reindexSemanticSearch()}}),this.addCommand({id:"clear-and-reindex-semantic-search",name:"Clear semantic search cache and reindex",callback:async()=>{this.embeddingService?(this.embeddingService.clearCache(),new e.Notice("Semantic search cache cleared. Starting reindex..."),await this.reindexSemanticSearch()):new e.Notice("Semantic search is not initialized")}}),this.addCommand({id:"create-quick-link",name:"Create quick link from selection",hotkeys:this.settings.quickLink.enabled?[{modifiers:["Mod","Shift"],key:this.settings.quickLink.defaultHotkey}]:[],editorCallback:(t,i)=>{if(!this.settings.quickLink.enabled)return void new e.Notice("Quick Link feature is disabled in settings");const s=t.getSelection();s?i.file?new st(this.app,this,s,i.file,t).open():new e.Notice("No active file"):new e.Notice("Please select text first")}}),this.addCommand({id:"debug-semantic-search-settings",name:"Debug semantic search settings",callback:()=>{this.settings.semanticSearch?(S.debug("Current semantic search settings:",this.settings.semanticSearch),S.debug("Exclusion patterns:",this.settings.semanticSearch.excludePatterns),new e.Notice(`Exclusion patterns: ${this.settings.semanticSearch.excludePatterns.join(", ")}`)):new e.Notice("Semantic search settings not found")}}),this.settings.semanticSearch.enableSemanticSearch&&this.addRibbonIcon("search","Open semantic search",()=>{this.semanticSearchEngine?new Pe(this.app,this).open():new e.Notice("Semantic search is not initialized")}),this.addSettingTab(new N(this.app,this))}onunload(){this.suggestionsWorker.terminate(),this.searchService&&this.searchService.shutdown().catch(e=>{S.error("Error shutting down search service:",e)}),this.hybridSearchService&&this.hybridSearchService.destroy(),this.semanticIndexingCoordinator&&this.semanticIndexingCoordinator.shutdown().catch(e=>{S.error("Error shutting down semantic indexing coordinator:",e)})}async initializeSemanticSearch(){try{S.debug("Semantic search: Initializing after workspace is ready..."),this.embeddingService=new ze(this.app.vault,this.app.metadataCache,this.settings.semanticSearch),await this.embeddingService.initialize(),this.semanticSearchEngine=new De(this.embeddingService,this.app.vault,this.app.metadataCache,this.settings.semanticSearch),this.semanticIndexingCoordinator=new Ae(this.app,this.embeddingService,this.settings.semanticSearch),await this.semanticIndexingCoordinator.initialize(),this.registerEvent(this.app.vault.on("create",t=>{t instanceof e.TFile&&"md"===t.extension&&this.semanticIndexingCoordinator.indexFile(t)})),this.registerEvent(this.app.vault.on("modify",t=>{t instanceof e.TFile&&"md"===t.extension&&this.semanticIndexingCoordinator.indexFile(t)})),this.registerEvent(this.app.vault.on("delete",t=>{t instanceof e.TFile&&"md"===t.extension&&this.semanticIndexingCoordinator.removeFile(t.path)})),this.registerEvent(this.app.vault.on("rename",(t,i)=>{t instanceof e.TFile&&"md"===t.extension&&this.semanticIndexingCoordinator.renameFile(i,t.path)})),S.debug("Semantic search: Initialization completed successfully after workspace ready"),await this.semanticIndexingCoordinator.checkForAutoIndexing()}catch(t){S.error("Semantic search: Failed to initialize after workspace ready:",t),new e.Notice("Failed to initialize semantic search. Check console for details.")}}initializeHybridSearch(){try{S.debug("Hybrid search: Initializing..."),this.hybridSearchService=new it(this.app,this.searchService,this.semanticSearchEngine||null,this.usageTracker,this.settings.hybridSearch,this.linkGraphService),this.hybridSearchService.initialize().then(async()=>{S.debug("Hybrid search: Initialization complete"),!this.semanticSearchEngine&&this.settings.semanticSearch.enableSemanticSearch&&S.debug("Hybrid search: Semantic search not yet ready, will update when available")}).catch(e=>{S.error("Hybrid search: Failed to initialize:",e)})}catch(e){S.error("Hybrid search: Failed to create service:",e)}}registerLinkGraphEvents(){this.registerEvent(this.app.vault.on("create",t=>{t instanceof e.TFile&&"md"===t.extension&&(S.debug("[Main] vault.create event:",t.path),S.debug(`Link graph: File created - ${t.path}`),this.linkGraphService.onFileCreate(t))})),this.registerEvent(this.app.metadataCache.on("changed",t=>{t instanceof e.TFile&&"md"===t.extension&&(S.debug("[Main] metadataCache.changed event:",t.path),S.debug(`Link graph: Metadata changed - ${t.path}`),this.linkGraphService.onFileModify(t))})),this.registerEvent(this.app.vault.on("delete",t=>{t instanceof e.TFile&&"md"===t.extension&&(S.debug("[Main] vault.delete event:",t.path),S.debug(`Link graph: File deleted - ${t.path}`),this.linkGraphService.onFileDelete(t.path))})),this.registerEvent(this.app.vault.on("rename",(t,i)=>{t instanceof e.TFile&&"md"===t.extension&&(S.debug("[Main] vault.rename event:",i,"->",t.path),S.debug(`Link graph: File renamed - ${i} -> ${t.path}`),this.linkGraphService.onFileRename(i,t.path))})),S.debug("[Main] Link graph file events registered"),S.debug("Link graph: File events registered")}updateHybridSearchWithSemantic(){this.hybridSearchService&&this.semanticSearchEngine&&(this.hybridSearchService.setSemanticSearch(this.semanticSearchEngine),S.debug("Hybrid search: Updated with semantic search engine"))}async reindexSemanticSearch(){if(!this.settings.semanticSearch.enableSemanticSearch)throw new Error("Semantic search is not enabled");if(this.semanticIndexingCoordinator||await this.initializeSemanticSearch(),!this.semanticIndexingCoordinator)throw new Error("Failed to initialize semantic indexing coordinator");await this.semanticIndexingCoordinator.indexAllFiles()}async testSemanticEmbedding(){if(!this.settings.semanticSearch.enableSemanticSearch)throw new Error("Semantic search is not enabled");if(this.embeddingService||await this.initializeSemanticSearch(),!this.embeddingService)throw new Error("Embedding service not initialized");const e=Date.now(),t=await this.embeddingService.generateEmbedding("hello world","search_query",1),i=Date.now()-e;return`Embedding OK: ${t.length} dims via ${this.settings.semanticSearch.embeddingModel||"nomic-embed-text"} in ${i}ms`}loadMacroCommands(){this.settings.macros.forEach((e,t)=>{if(!e.name||!e.commandIds.length)return;const i=new c(this.app,`${u}${t}`,e.name,e.commandIds,e.delay);this.addCommand(i),this.prevCommands&&(this.prevCommands=this.prevCommands.values().reduce((e,t)=>(t.id===i.id&&t.text!==i.name||e.add(t),e),new n))})}deleteMacroCommands(){Object.keys(this.app.commands.commands).filter(e=>e.includes(u)).forEach(e=>{this.app.commands.removeCommand(e)})}async loadSettings(){const e=await this.loadData();this.settings={...L,...e,enhancedSearch:{...L.enhancedSearch,...e?.enhancedSearch??{}},semanticSearch:{...L.semanticSearch,...e?.semanticSearch??{}},hybridSearch:{...L.hybridSearch,...e?.hybridSearch??{}},quickLink:{...L.quickLink,...e?.quickLink??{}},linkGraph:{...L.linkGraph,...e?.linkGraph??{}}},this.loadMacroCommands()}async saveSettings(){this.deleteMacroCommands(),await this.saveData(this.settings),this.loadMacroCommands(),this.updateSearchSettings()}updateSearchSettings(){this.embeddingService&&this.embeddingService.updateSettings(this.settings.semanticSearch),this.semanticSearchEngine&&this.semanticSearchEngine.updateSettings(this.settings.semanticSearch),this.semanticIndexingCoordinator&&this.semanticIndexingCoordinator.updateSettings(this.settings.semanticSearch),this.hybridSearchService&&this.hybridSearchService.updateSettings(this.settings.hybridSearch),this.linkGraphService&&this.linkGraphService.updateSettings(this.settings.linkGraph)}getEmbeddingService(){return this.embeddingService}getSemanticSearchEngine(){return this.semanticSearchEngine}}module.exports=nt;
